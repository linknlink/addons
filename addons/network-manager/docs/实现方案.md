# Network Manager 实现方案

## 1. 概述

本文档详细说明 Network Manager 的实现方案，包括技术架构、实现细节、关键技术选型和部署流程。

## 2. 技术架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│              Docker Host (Ubuntu Server)                 │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │         NetworkManager 服务 (宿主机)              │  │
│  │  - 管理 WiFi 设备                                 │  │
│  │  - 通过 D-Bus 提供接口                           │  │
│  └──────────┬───────────────────────────────────────┘  │
│             │ D-Bus Socket                              │
│             │ /run/dbus/system_bus_socket              │
│  ┌──────────▼───────────────────────────────────────┐  │
│  │         Network Manager Container                 │  │
│  │                                                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │         nmcli 客户端                        │  │  │
│  │  │  - 通过 D-Bus 与宿主机 NetworkManager 通信 │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │         network-manager.sh                  │  │  │
│  │  │  - WiFi 扫描、连接、配置管理                │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │         docker-entrypoint.sh                │  │  │
│  │  │  - 容器启动和初始化                         │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Host Network Interface                    │  │
│  │  - WiFi 设备 (wlan0, wlan1, ...)                 │  │
│  │  - 以太网设备 (eth0, eth1, ...)                  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 通信机制

**D-Bus 通信流程：**

1. **宿主机 NetworkManager 服务**
   - 作为系统服务运行在宿主机上
   - 通过 D-Bus 系统总线 (`/run/dbus/system_bus_socket`) 提供服务接口
   - 管理实际的网络设备（WiFi、以太网等）

2. **容器内的 nmcli 客户端**
   - 通过挂载的 D-Bus socket 连接到宿主机的 D-Bus
   - 使用 D-Bus 协议与宿主机 NetworkManager 通信
   - 发送命令（连接 WiFi、配置 IP 等）
   - 接收状态信息（连接状态、设备信息等）

3. **网络模式**
   - 使用 `host` 网络模式，容器直接使用宿主机的网络命名空间
   - 容器内的进程可以直接访问宿主机的网络设备

## 3. 技术选型

### 3.1 基础镜像选择

**选择：`debian:bookworm-slim`**

**原因：**

1. **体积优化**
   - 基础镜像约 80MB（相比 Ubuntu 的 200MB+ 更小）
   - 只安装必要的包，进一步减小镜像体积

2. **兼容性**
   - 基于 glibc，与宿主机 Ubuntu 22.04 兼容
   - NetworkManager 包在 Debian 仓库中完整可用

3. **功能完整性**
   - 完整的 `nmcli` 客户端支持
   - 所有 NetworkManager 功能可用

4. **为什么不使用 Alpine**
   - Alpine 使用 musl libc，NetworkManager 支持不完整
   - Alpine 仓库中可能没有完整的 NetworkManager 包
   - 需要从源码编译，复杂度高

### 3.2 容器内组件

**只安装客户端工具，不安装服务：**

```dockerfile
network-manager      # nmcli 客户端工具
iputils-ping         # ping 工具
curl                 # HTTP 客户端
jq                   # JSON 处理工具
bash                 # Shell 环境
ca-certificates      # SSL 证书
dbus                 # D-Bus 客户端库
```

**不安装：**
- NetworkManager 服务（在宿主机运行）
- systemd（不需要在容器内运行服务）

### 3.3 容器配置

**网络模式：`host`**
- 直接使用宿主机的网络命名空间
- 容器内的进程可以直接访问网络设备

**权限：`privileged: true`**
- 需要访问网络设备和管理网络配置
- 需要 `NET_ADMIN` 和 `SYS_ADMIN` capabilities

**挂载点：**
- `/etc/NetworkManager` - NetworkManager 配置文件（只读）
- `/var/lib/NetworkManager` - NetworkManager 状态数据
- `/run/dbus` - D-Bus socket（只读）
- `/var/run/dbus` - D-Bus socket（只读）

## 4. 核心实现

### 4.1 文件结构

```
addons/network-manager/
├── common/
│   ├── Dockerfile                    # 容器构建文件
│   └── rootfs/
│       └── app/
│           ├── docker-entrypoint.sh  # 容器入口脚本
│           ├── network-manager.sh    # 核心管理脚本
│           ├── config-validator.sh   # 配置验证脚本
│           └── utils.sh              # 工具函数库
├── docker-compose.yml                # 本地开发配置
├── repository.json                   # 项目元数据
├── VERSION                           # 版本号
└── README.md                         # 用户文档
```

### 4.2 核心脚本说明

#### 4.2.1 docker-entrypoint.sh

**功能：**
- 容器启动时的初始化逻辑
- 加载和验证配置
- 检查 NetworkManager 连接
- 执行初始化 WiFi 连接（如果配置）
- 启动监控服务（如果启用）

**关键逻辑：**
```bash
# 1. 加载配置
load_config

# 2. 验证配置
config-validator.sh

# 3. 检查 NetworkManager（通过 nmcli）
check_network_manager

# 4. 等待 NetworkManager 就绪
wait_for_network_manager

# 5. 初始化 WiFi 连接（如果配置）
if [ -n "$INITIAL_WIFI_SSID" ]; then
    network-manager.sh connect ...
fi

# 6. 启动监控服务
if [ "$AUTO_RECONNECT" = "true" ]; then
    network-manager.sh monitor &
fi
```

#### 4.2.2 network-manager.sh

**功能：**
- WiFi 网络扫描
- WiFi 连接管理（DHCP/静态 IP）
- 连接状态查看
- IP 配置管理
- 连接监控和自动重连

**主要命令：**
- `scan` - 扫描 WiFi 网络
- `connect` - 连接 WiFi（支持 DHCP/静态 IP）
- `disconnect` - 断开连接
- `status` - 查看网络状态
- `configure` - 配置 IP 地址
- `list` - 列出所有连接
- `delete` - 删除连接
- `monitor` - 监控连接状态

**实现要点：**
- 所有操作通过 `nmcli` 命令执行
- `nmcli` 通过 D-Bus 与宿主机 NetworkManager 通信
- 支持 JSON 格式输出（使用 `jq` 处理）

#### 4.2.3 config-validator.sh

**功能：**
- 验证环境变量配置
- 验证 IP 地址格式（IPv4）
- 验证 CIDR 格式
- 验证 DNS 服务器地址
- 验证配置逻辑（如静态 IP 需要 IP 地址）

**验证项：**
- `WIFI_SCAN_INTERVAL` - 必须是正整数
- `DEFAULT_IP_METHOD` - 必须是 'dhcp' 或 'static'
- `INITIAL_WIFI_IP_ADDRESS` - CIDR 格式验证
- `INITIAL_WIFI_GATEWAY` - IP 地址格式验证
- `INITIAL_WIFI_DNS` - IP 地址格式验证（支持多个）
- `LOG_LEVEL` - 必须是有效级别

#### 4.2.4 utils.sh

**功能：**
- 日志函数（DEBUG/INFO/WARNING/ERROR）
- 配置加载和默认值设置
- NetworkManager 连接检查
- WiFi 设备检查
- NetworkManager 就绪等待

**关键函数：**
- `log()` - 日志输出函数
- `load_config()` - 加载配置并设置默认值
- `check_network_manager()` - 检查 nmcli 是否可用
- `wait_for_network_manager()` - 等待 NetworkManager 就绪
- `check_wifi_device()` - 检查 WiFi 设备是否存在

## 5. D-Bus 通信机制

### 5.1 D-Bus 是什么

D-Bus（Desktop Bus）是 Linux 系统上的进程间通信（IPC）机制，用于：
- 应用程序之间的消息传递
- 系统服务提供接口
- 事件通知和信号传递

### 5.2 NetworkManager 的 D-Bus 接口

NetworkManager 通过 D-Bus 提供以下接口：

- **org.freedesktop.NetworkManager** - 主接口
  - 设备管理
  - 连接管理
  - 状态查询

- **org.freedesktop.NetworkManager.Device** - 设备接口
  - 设备状态
  - 设备配置

- **org.freedesktop.NetworkManager.Connection.Active** - 活动连接接口
  - 连接状态
  - IP 配置

### 5.3 nmcli 如何使用 D-Bus

`nmcli` 命令内部实现：

1. 连接到 D-Bus 系统总线
2. 调用 NetworkManager 的 D-Bus 接口
3. 发送命令（如连接 WiFi）
4. 接收响应和状态信息

**示例：**
```bash
# nmcli 内部通过 D-Bus 调用
nmcli device wifi connect "SSID" password "password"
# ↓
# 通过 D-Bus 发送命令到 NetworkManager
# NetworkManager 执行操作
# 返回结果
```

### 5.4 容器如何访问 D-Bus

**挂载 D-Bus socket：**
```yaml
volumes:
  - /run/dbus:/run/dbus:ro
  - /var/run/dbus:/var/run/dbus:ro
```

**工作原理：**
1. 宿主机 NetworkManager 通过 `/run/dbus/system_bus_socket` 提供服务
2. 容器挂载这个 socket 文件
3. 容器内的 `nmcli` 通过挂载的 socket 连接到宿主机的 D-Bus
4. `nmcli` 可以调用宿主机的 NetworkManager 接口

## 6. 配置管理

### 6.1 环境变量配置

**基本配置：**
- `WIFI_SCAN_INTERVAL` - WiFi 扫描间隔（秒）
- `AUTO_RECONNECT` - 是否自动重连
- `DEFAULT_IP_METHOD` - 默认 IP 配置方法（dhcp/static）
- `LOG_LEVEL` - 日志级别（debug/info/warning/error）

**WiFi 连接配置：**
- `INITIAL_WIFI_SSID` - 初始连接的 WiFi 名称
- `INITIAL_WIFI_PASSWORD` - WiFi 密码
- `INITIAL_WIFI_IP_ADDRESS` - 静态 IP 地址（CIDR 格式）
- `INITIAL_WIFI_GATEWAY` - 网关地址
- `INITIAL_WIFI_DNS` - DNS 服务器（多个用空格分隔）

### 6.2 配置验证

配置验证在容器启动时执行：

1. **格式验证**
   - IP 地址格式
   - CIDR 格式
   - DNS 服务器格式

2. **逻辑验证**
   - 静态 IP 模式必须提供 IP 地址
   - 配置项之间的依赖关系

3. **验证失败处理**
   - 输出错误信息
   - 容器退出（避免错误配置运行）

### 6.3 配置持久化

NetworkManager 配置保存在：
- `/etc/NetworkManager` - 配置文件（挂载为只读）
- `/var/lib/NetworkManager` - 状态数据（挂载为可写）

容器内的配置保存在：
- `/data/config/` - 应用配置（通过 volume 挂载）

## 7. 构建和部署

### 7.1 本地构建

```bash
cd addons/network-manager
docker-compose build
docker-compose up -d
```

### 7.2 使用构建脚本

```bash
# 构建所有架构
./scripts/build-addon.sh network-manager

# 构建特定架构
./scripts/build-addon.sh network-manager --arch aarch64

# 构建并推送
./scripts/build-addon.sh network-manager --push
```

### 7.3 CI/CD 流程

**触发条件：**
- 创建 Git tag：`network-manager-v<version>`

**执行步骤：**
1. 解析 tag 获取 addon 名称和版本
2. 从 `repository.json` 读取支持的架构
3. 为每个架构构建 Docker 镜像
4. 推送到 `ghcr.io/linknlink/network_manager`
5. 创建 GitHub Release

**多架构支持：**
- `aarch64` - ARM 64 位（鲁班猫）
- `amd64` - x86_64
- `armv7` - ARM 32 位

### 7.4 镜像命名

- 开发版本：`ghcr.io/linknlink/network_manager:dev`
- 发布版本：`ghcr.io/linknlink/network_manager:0.0.1`
- 最新版本：`ghcr.io/linknlink/network_manager:latest`

## 8. 使用示例

### 8.1 基本使用

**启动容器：**
```bash
docker run -d \
  --name network-manager \
  --network host \
  --privileged \
  -e INITIAL_WIFI_SSID=MyWiFi \
  -e INITIAL_WIFI_PASSWORD=password \
  ghcr.io/linknlink/network_manager:latest
```

### 8.2 扫描 WiFi

```bash
docker exec network-manager /app/network-manager.sh scan
```

### 8.3 连接 WiFi（DHCP）

```bash
docker exec network-manager /app/network-manager.sh connect \
  --ssid "MyWiFi" \
  --password "password" \
  --ip-method dhcp
```

### 8.4 连接 WiFi（静态 IP）

```bash
docker exec network-manager /app/network-manager.sh connect \
  --ssid "MyWiFi" \
  --password "password" \
  --ip-method static \
  --ip-address "192.168.1.100/24" \
  --gateway "192.168.1.1" \
  --dns "8.8.8.8 8.8.4.4"
```

### 8.5 查看状态

```bash
docker exec network-manager /app/network-manager.sh status
```

## 9. 关键技术点

### 9.1 为什么使用 host 网络模式

- 容器需要直接访问宿主机的网络设备
- NetworkManager 管理的是宿主机的网络，不是容器网络
- 使用 host 模式可以避免网络配置的复杂性

### 9.2 为什么需要 privileged 模式

- 需要 `NET_ADMIN` capability 来管理网络配置
- 需要 `SYS_ADMIN` capability 来访问系统资源
- 需要访问 `/dev` 下的设备文件

### 9.3 为什么只安装客户端工具

- NetworkManager 服务在宿主机运行
- 容器只需要 `nmcli` 客户端通过 D-Bus 通信
- 减小镜像体积，提高启动速度

### 9.4 D-Bus socket 挂载

- 只读挂载确保容器不会修改 D-Bus 配置
- 挂载两个路径确保兼容性（不同系统可能使用不同路径）
- 容器内的 `nmcli` 通过挂载的 socket 访问宿主机的 D-Bus

## 10. 故障排查

### 10.1 无法连接到 NetworkManager

**检查项：**
1. 宿主机 NetworkManager 服务是否运行
   ```bash
   sudo systemctl status NetworkManager
   ```

2. D-Bus socket 是否正确挂载
   ```bash
   docker exec network-manager ls -la /run/dbus/
   ```

3. 容器是否有足够权限
   - 检查 `privileged` 模式
   - 检查 capabilities

### 10.2 WiFi 连接失败

**检查项：**
1. WiFi 设备是否可用
   ```bash
   docker exec network-manager nmcli device status
   ```

2. 密码是否正确
3. 信号强度是否足够
4. 网络是否可用

### 10.3 配置验证失败

**检查项：**
1. 环境变量格式是否正确
2. IP 地址格式是否正确（CIDR 格式）
3. 静态 IP 配置是否完整

## 11. 性能优化

### 11.1 镜像体积优化

- 使用 `debian:bookworm-slim` 基础镜像
- 只安装必要的包
- 使用 `--no-install-recommends` 选项
- 清理 apt 缓存

### 11.2 启动时间优化

- 不安装 NetworkManager 服务（在宿主机运行）
- 最小化容器内组件
- 异步初始化（监控服务后台运行）

### 11.3 资源使用优化

- 监控服务使用合理的扫描间隔
- 避免频繁的 WiFi 扫描
- 缓存扫描结果（如适用）

## 12. 安全考虑

### 12.1 权限最小化

- 只挂载必要的目录
- D-Bus socket 只读挂载
- NetworkManager 配置只读挂载

### 12.2 敏感信息处理

- WiFi 密码通过环境变量传递
- 不在日志中输出密码
- 配置文件不包含敏感信息

### 12.3 网络安全

- 验证网络配置的有效性
- 防止恶意网络配置
- 限制网络访问范围（如适用）

## 13. 未来扩展

### 13.1 功能扩展

- [ ] 支持多个 WiFi 网络配置
- [ ] WiFi 网络优先级管理
- [ ] 网络质量监控和报告
- [ ] 自动网络切换（根据信号强度）

### 13.2 集成扩展

- [ ] MQTT 支持（状态发布）
- [ ] Web UI 管理界面
- [ ] RESTful API 完整实现
- [ ] Prometheus 指标导出

### 13.3 平台扩展

- [ ] 支持更多 Linux 发行版
- [ ] 支持以太网配置管理
- [ ] 支持 VPN 配置

## 14. 总结

Network Manager 实现方案的核心要点：

1. **轻量级容器** - 只安装客户端工具，服务在宿主机运行
2. **D-Bus 通信** - 通过 D-Bus socket 与宿主机 NetworkManager 通信
3. **host 网络模式** - 直接访问宿主机的网络设备
4. **配置灵活** - 支持环境变量配置，支持 DHCP 和静态 IP
5. **功能完整** - 支持 WiFi 扫描、连接、配置管理等完整功能

这个方案既保证了功能的完整性，又实现了镜像体积的最小化，是一个平衡性能和功能的优秀方案。

---

**文档版本**：1.0.0  
**最后更新**：2024年  
**维护者**：linknlink
