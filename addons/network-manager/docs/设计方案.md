# Network Manager 设计方案

## 1. 项目概述

### 1.1 项目背景

Network Manager 是一个 Docker 容器应用，旨在为 Ubuntu Server 系统（特别是鲁班猫设备）提供 WiFi 网络管理功能。该容器通过 NetworkManager 的 `nmcli` 命令行工具，实现对 WiFi 连接的扫描、连接、配置和管理。

### 1.2 项目目标

- **主要功能**：实现 Ubuntu Server 系统（鲁班猫）的 WiFi 管理功能
- **核心能力**：
  - WiFi 网络扫描和发现
  - WiFi 连接管理（连接、断开、重连）
  - IP 地址配置（DHCP 自动分配和静态 IP）
  - 网络连接状态监控
  - 网络配置持久化
- **部署要求**：能够通过 `scripts/release-addon.sh` 推送和构建镜像

### 1.3 技术栈

- **基础镜像**：Ubuntu Server（适配鲁班猫 ARM 架构）
- **网络管理工具**：NetworkManager (nmcli)
- **容器运行时**：Docker
- **脚本语言**：Bash
- **配置格式**：JSON/YAML（环境变量或配置文件）

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│              Docker Host (Ubuntu Server)                 │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Network Manager Container                 │  │
│  │                                                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │         NetworkManager Service             │  │  │
│  │  │  - nmcli 命令执行                          │  │  │
│  │  │  - 网络配置管理                            │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │         API Server (可选)                  │  │  │
│  │  │  - RESTful API 接口                        │  │  │
│  │  │  - WebSocket 实时状态                      │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │         Configuration Manager               │  │  │
│  │  │  - 配置读取和验证                          │  │  │
│  │  │  - 配置持久化                              │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │         Logging & Monitoring                │  │  │
│  │  │  - 日志记录                                │  │  │
│  │  │  - 状态监控                                │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Host Network Interface                    │  │
│  │  - WiFi 设备 (wlan0, wlan1, ...)                 │  │
│  │  - 以太网设备 (eth0, eth1, ...)                  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 容器网络模式

由于需要直接访问主机的网络设备，容器必须使用 `host` 网络模式：

```yaml
network_mode: host
```

这样可以：
- 直接访问主机的网络接口
- NetworkManager 能够管理实际的网络设备
- 避免网络配置的复杂性

### 2.3 文件系统结构

```
addons/network-manager/
├── repository.json              # 项目元数据（可选）
├── config.json                  # 配置模板（可选）
├── VERSION                      # 版本号
├── README.md                    # 用户文档
├── CHANGELOG.md                 # 更新日志
├── docs/
│   ├── prompt.md               # 项目需求说明
│   ├── 配置指南.md             # nmcli 使用指南
│   └── 设计方案.md             # 本文档
├── common/
│   ├── Dockerfile              # Docker 构建文件
│   └── rootfs/
│       ├── app/
│       │   ├── docker-entrypoint.sh    # 入口脚本
│       │   ├── network-manager.sh      # 核心管理脚本
│       │   ├── config-validator.sh     # 配置验证脚本
│       │   └── utils.sh                # 工具函数
│       └── runtime/
│           ├── data/                   # 数据目录
│           │   └── config/             # 配置存储
│           └── etc/
│               └── NetworkManager/     # NetworkManager 配置
└── docker-compose.yml          # 本地开发配置
```

---

## 3. 功能设计

### 3.1 核心功能模块

#### 3.1.1 WiFi 扫描功能

**功能描述**：扫描并列出可用的 WiFi 网络

**实现方式**：
```bash
nmcli device wifi list
```

**输出格式**：JSON 格式的网络列表，包含：
- SSID（网络名称）
- 信号强度
- 加密类型
- 频率
- 通道

#### 3.1.2 WiFi 连接功能

**功能描述**：连接到指定的 WiFi 网络

**支持模式**：
1. **DHCP 模式**（自动分配 IP）
2. **静态 IP 模式**（固定 IP 地址）

**实现方式**：
```bash
# DHCP 模式
nmcli device wifi connect "SSID" password "密码"

# 静态 IP 模式
nmcli device wifi connect "SSID" password "密码" \
  ipv4.method manual \
  ipv4.addresses 192.168.1.100/24 \
  ipv4.gateway 192.168.1.1 \
  ipv4.dns "8.8.8.8 8.8.4.4"
```

#### 3.1.3 连接管理功能

**功能描述**：管理现有的网络连接

**操作类型**：
- 查看连接状态
- 激活连接
- 停用连接
- 删除连接
- 修改连接配置

**实现方式**：
```bash
nmcli connection show          # 列出所有连接
nmcli connection up "连接名"    # 激活连接
nmcli connection down "连接名"  # 停用连接
nmcli connection delete "连接名" # 删除连接
nmcli connection modify "连接名" ipv4.method auto  # 修改配置
```

#### 3.1.4 IP 配置管理

**功能描述**：管理 IP 地址配置

**配置类型**：
1. **DHCP 自动分配**
   - 自动获取 IP 地址
   - 自动获取网关和 DNS

2. **静态 IP 配置**
   - 手动指定 IP 地址
   - 手动指定子网掩码
   - 手动指定网关
   - 手动指定 DNS 服务器

**实现方式**：
```bash
# 切换到 DHCP
nmcli connection modify "连接名" ipv4.method auto

# 切换到静态 IP
nmcli connection modify "连接名" \
  ipv4.method manual \
  ipv4.addresses 192.168.1.100/24 \
  ipv4.gateway 192.168.1.1 \
  ipv4.dns "8.8.8.8 8.8.4.4"
```

#### 3.1.5 状态监控功能

**功能描述**：实时监控网络连接状态

**监控内容**：
- 当前活动的连接
- IP 地址信息
- 网络设备状态
- 连接质量（信号强度等）

**实现方式**：
```bash
nmcli device status           # 设备状态
nmcli connection show --active # 活动连接
nmcli device show              # 详细设备信息
```

### 3.2 配置管理

#### 3.2.1 配置项设计

**环境变量配置**：

通过环境变量或配置文件进行配置：

```yaml
# docker-compose.yml 或环境变量
WIFI_SCAN_INTERVAL: 30
AUTO_RECONNECT: true
DEFAULT_IP_METHOD: dhcp
LOG_LEVEL: info
```

**配置文件格式（config.yaml）**：

```yaml
wifi_scan_interval: 30
auto_reconnect: true
default_ip_method: dhcp
log_level: info
```

#### 3.2.2 配置验证

- 验证 IP 地址格式
- 验证子网掩码格式
- 验证网关地址
- 验证 DNS 服务器地址
- 验证 WiFi 密码长度和格式

### 3.3 日志和监控

#### 3.3.1 日志级别

- **DEBUG**：详细的调试信息
- **INFO**：一般信息（连接状态、配置变更等）
- **WARNING**：警告信息（连接失败、配置错误等）
- **ERROR**：错误信息（严重故障）

#### 3.3.2 日志输出

- 标准输出（stdout）：INFO 级别及以上
- 标准错误（stderr）：ERROR 级别
- 日志文件：`/data/network-manager.log`

---

## 4. 技术实现方案

### 4.1 Dockerfile 设计

```dockerfile
ARG BUILD_FROM=ubuntu:22.04
FROM ${BUILD_FROM}

ENV LANG=C.UTF-8 \
    DEBIAN_FRONTEND=noninteractive

# 安装 NetworkManager 和相关工具
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        network-manager \
        nmcli \
        iputils-ping \
        curl \
        jq \
        bash \
        ca-certificates && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 复制应用文件
COPY rootfs /

# 设置工作目录
WORKDIR /app

# 设置权限
RUN chmod +x /app/docker-entrypoint.sh && \
    chmod +x /app/network-manager.sh

# 运行脚本
ENTRYPOINT ["/bin/bash", "/app/docker-entrypoint.sh"]
```

### 4.2 入口脚本设计

**docker-entrypoint.sh**：

```bash
#!/bin/bash
set -e

# 加载配置
source /app/utils.sh
load_config

# 验证配置
/app/config-validator.sh

# 启动 NetworkManager 服务
systemctl start NetworkManager || service NetworkManager start

# 等待 NetworkManager 就绪
wait_for_network_manager

# 执行初始化配置
if [ -n "$INITIAL_WIFI_SSID" ]; then
    /app/network-manager.sh connect \
        --ssid "$INITIAL_WIFI_SSID" \
        --password "$INITIAL_WIFI_PASSWORD" \
        --ip-method "$DEFAULT_IP_METHOD"
fi

# 启动监控服务（如果启用）
if [ "$AUTO_RECONNECT" = "true" ]; then
    /app/network-manager.sh monitor &
fi

# 保持容器运行
exec "$@"
```

### 4.3 核心管理脚本设计

**network-manager.sh** 主要功能：

1. **scan**：扫描 WiFi 网络
2. **connect**：连接 WiFi
3. **disconnect**：断开连接
4. **status**：查看状态
5. **configure**：配置 IP
6. **monitor**：监控连接

**函数示例**：

```bash
#!/bin/bash

# WiFi 扫描
wifi_scan() {
    nmcli device wifi list --format json | jq '.'
}

# WiFi 连接
wifi_connect() {
    local ssid=$1
    local password=$2
    local ip_method=$3
    local ip_address=$4
    local gateway=$5
    local dns=$6
    
    if [ "$ip_method" = "dhcp" ]; then
        nmcli device wifi connect "$ssid" password "$password"
    else
        nmcli device wifi connect "$ssid" password "$password" \
            ipv4.method manual \
            ipv4.addresses "$ip_address" \
            ipv4.gateway "$gateway" \
            ipv4.dns "$dns"
    fi
}

# 查看状态
get_status() {
    nmcli device status --format json | jq '.'
}

# 配置 IP
configure_ip() {
    local connection=$1
    local ip_method=$2
    local ip_address=$3
    local gateway=$4
    local dns=$5
    
    if [ "$ip_method" = "dhcp" ]; then
        nmcli connection modify "$connection" ipv4.method auto
    else
        nmcli connection modify "$connection" \
            ipv4.method manual \
            ipv4.addresses "$ip_address" \
            ipv4.gateway "$gateway" \
            ipv4.dns "$dns"
    fi
    
    nmcli connection down "$connection"
    nmcli connection up "$connection"
}
```

### 4.4 配置验证脚本

**config-validator.sh**：

```bash
#!/bin/bash

validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        return 0
    fi
    return 1
}

validate_cidr() {
    local cidr=$1
    if [[ $cidr =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}$ ]]; then
        return 0
    fi
    return 1
}

validate_config() {
    # 验证配置项
    # ...
}
```

---

## 5. 配置方案

### 5.1 环境变量配置

用户可以通过环境变量或 Docker Compose 文件进行配置：

**Docker Compose 配置示例**：

```yaml
services:
  network-manager:
    image: ghcr.io/linknlink/network-manager:latest
    container_name: network-manager
    network_mode: host
    privileged: true
    environment:
      - WIFI_SCAN_INTERVAL=30
      - AUTO_RECONNECT=true
      - DEFAULT_IP_METHOD=dhcp
      - LOG_LEVEL=info
    volumes:
      - ./data:/data
    restart: unless-stopped
```

**Docker 命令行配置示例**：

```bash
docker run -d \
  --name network-manager \
  --network host \
  --privileged \
  -e WIFI_SCAN_INTERVAL=30 \
  -e AUTO_RECONNECT=true \
  -e DEFAULT_IP_METHOD=dhcp \
  -e LOG_LEVEL=info \
  -v $(pwd)/data:/data \
  ghcr.io/linknlink/network-manager:latest
```

### 5.2 高级配置（静态 IP）

如果需要配置静态 IP，可以通过环境变量或配置文件：

```yaml
wifi_connections:
  - ssid: "MyWiFi"
    password: "mypassword"
    ip_method: static
    ip_address: "192.168.1.100/24"
    gateway: "192.168.1.1"
    dns: "8.8.8.8 8.8.4.4"
```

### 5.3 配置持久化

- 配置保存在 `/data/config/` 目录
- NetworkManager 配置保存在 `/data/NetworkManager/`
- 连接配置自动持久化，重启后保持

---

## 6. API 接口设计（可选）

### 6.1 RESTful API

如果需要在容器内部提供 API 服务：

**端点设计**：

```
GET  /api/status          # 获取网络状态
GET  /api/networks        # 扫描 WiFi 网络
POST /api/connect         # 连接 WiFi
POST /api/disconnect      # 断开连接
POST /api/configure       # 配置 IP
GET  /api/connections     # 列出所有连接
```

**示例请求**：

```bash
# 连接 WiFi
curl -X POST http://localhost:8080/api/connect \
  -H "Content-Type: application/json" \
  -d '{
    "ssid": "MyWiFi",
    "password": "mypassword",
    "ip_method": "dhcp"
  }'

# 配置静态 IP
curl -X POST http://localhost:8080/api/configure \
  -H "Content-Type: application/json" \
  -d '{
    "connection": "MyWiFi",
    "ip_method": "static",
    "ip_address": "192.168.1.100/24",
    "gateway": "192.168.1.1",
    "dns": "8.8.8.8 8.8.4.4"
  }'
```

### 6.2 WebSocket 实时状态

提供 WebSocket 连接以实时推送网络状态变化：

```
ws://localhost:8080/ws/status
```

---

## 7. 部署方案

### 7.1 构建流程

1. **本地构建**：
   ```bash
   cd addons/network-manager
   docker build -t network-manager:local -f common/Dockerfile .
   ```

2. **使用发布脚本**：
   ```bash
   ./scripts/release-addon.sh network-manager patch --commit --push
   ```

3. **CI/CD 自动构建**：
   - 通过 GitHub Actions 自动构建
   - 支持多架构构建（aarch64, amd64, armv7）
   - 自动推送到容器仓库

### 7.2 镜像命名规范

- 开发版本：`ghcr.io/linknlink/network-manager:dev`
- 发布版本：`ghcr.io/linknlink/network-manager:1.0.0`
- 最新版本：`ghcr.io/linknlink/network-manager:latest`

### 7.3 多架构支持

由于目标系统是鲁班猫（ARM 架构），需要支持：

- **aarch64**：ARM 64 位（主要目标）
- **armv7**：ARM 32 位（兼容性）
- **amd64**：x86_64（开发和测试）

使用 Docker Buildx 进行多架构构建：

```bash
docker buildx build \
  --platform linux/arm64,linux/arm/v7,linux/amd64 \
  -t ghcr.io/linknlink/network-manager:1.0.0 \
  --push .
```

---

## 8. 测试方案

### 8.1 单元测试

- 配置验证函数测试
- IP 地址格式验证测试
- 命令生成测试

### 8.2 集成测试

- WiFi 扫描功能测试
- WiFi 连接功能测试
- IP 配置切换测试
- 连接状态监控测试

### 8.3 端到端测试

- 完整连接流程测试
- DHCP 模式测试
- 静态 IP 模式测试
- 配置持久化测试
- 容器重启恢复测试

### 8.4 测试环境

- **开发环境**：本地 Docker 容器
- **测试环境**：Ubuntu Server 虚拟机
- **生产环境**：鲁班猫设备

---

## 9. 安全考虑

### 9.1 权限管理

- 使用最小权限原则
- 仅授予必要的 Linux capabilities：
  - `NET_ADMIN`：网络管理权限
  - `SYS_ADMIN`：系统管理权限（NetworkManager 需要）

### 9.2 敏感信息处理

- WiFi 密码加密存储
- 配置文件中不直接暴露密码
- 使用环境变量或密钥管理服务

### 9.3 网络安全

- 验证网络配置的有效性
- 防止恶意网络配置
- 限制网络访问范围

---

## 10. 错误处理和故障恢复

### 10.1 错误类型

1. **网络设备不可用**
   - 检测 WiFi 设备是否存在
   - 提供清晰的错误信息

2. **连接失败**
   - 密码错误
   - 信号强度不足
   - 网络不可用

3. **配置错误**
   - IP 地址冲突
   - 网关不可达
   - DNS 服务器无效

### 10.2 故障恢复策略

- **自动重连**：连接断开时自动尝试重连
- **配置回滚**：配置失败时恢复到之前的配置
- **日志记录**：记录所有错误以便排查

### 10.3 健康检查

- 定期检查 NetworkManager 服务状态
- 监控网络连接状态
- 检测 IP 地址是否有效

---

## 11. 性能优化

### 11.1 WiFi 扫描优化

- 限制扫描频率（避免过于频繁）
- 缓存扫描结果
- 异步扫描（不阻塞主进程）

### 11.2 资源使用

- 最小化容器镜像大小
- 优化启动时间
- 减少内存占用

---

## 12. 文档要求

### 12.1 用户文档

- **README.md**：基本使用说明
- **配置指南.md**：详细的配置说明和示例
- **故障排查**：常见问题和解决方案

### 12.2 开发文档

- **设计方案.md**：本文档
- **API 文档**：API 接口说明（如果提供）
- **贡献指南**：开发参与指南

---

## 13. 开发计划

### 13.1 第一阶段：基础功能（v0.1.0）

- [x] 项目结构搭建
- [ ] Dockerfile 和基础镜像
- [ ] WiFi 扫描功能
- [ ] WiFi 连接功能（DHCP）
- [ ] 基本的状态查看

### 13.2 第二阶段：IP 配置（v0.2.0）

- [ ] 静态 IP 配置功能
- [ ] IP 配置切换（DHCP ↔ Static）
- [ ] 配置验证和错误处理

### 13.3 第三阶段：高级功能（v0.3.0）

- [ ] 连接管理（断开、删除、修改）
- [ ] 自动重连功能
- [ ] 状态监控和日志

### 13.4 第四阶段：优化和测试（v1.0.0）

- [ ] 性能优化
- [ ] 完整测试覆盖
- [ ] 文档完善
- [ ] 生产环境测试

---

## 14. 未来扩展

### 14.1 功能扩展

- [ ] 支持多个 WiFi 网络配置
- [ ] WiFi 网络优先级管理
- [ ] 网络质量监控和报告
- [ ] 自动网络切换（根据信号强度）

### 14.2 集成扩展

- [ ] MQTT 支持（状态发布）
- [ ] Web UI 管理界面
- [ ] RESTful API 完整实现
- [ ] Prometheus 指标导出

### 14.3 平台扩展

- [ ] 支持更多 Linux 发行版
- [ ] 支持以太网配置管理
- [ ] 支持 VPN 配置

---

## 15. 参考资源

- [NetworkManager 官方文档](https://networkmanager.dev/)
- [nmcli 命令参考](https://networkmanager.dev/docs/api/latest/nmcli.html)
- [Docker 多架构构建](https://docs.docker.com/build/building/multi-platform/)
- [Docker Compose 文档](https://docs.docker.com/compose/)

---

## 附录

### A. 常用 nmcli 命令速查

参考 `配置指南.md` 文档。

### B. 配置示例

#### B.1 DHCP 配置示例

```bash
nmcli device wifi connect "MyWiFi" password "mypassword"
```

#### B.2 静态 IP 配置示例

```bash
nmcli device wifi connect "MyWiFi" password "mypassword" \
  ipv4.method manual \
  ipv4.addresses 192.168.1.100/24 \
  ipv4.gateway 192.168.1.1 \
  ipv4.dns "8.8.8.8 8.8.4.4"
```

### C. 故障排查清单

1. 检查 NetworkManager 服务状态
2. 检查 WiFi 设备是否可用
3. 检查网络配置是否正确
4. 查看日志文件
5. 验证 IP 地址是否冲突

---

**文档版本**：1.0.0  
**最后更新**：2024年  
**维护者**：linknlink
