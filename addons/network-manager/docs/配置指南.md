# NetworkManager (nmcli) 网络配置指南

本文档介绍如何使用 `nmcli` 命令配置网络连接，包括 WiFi 连接、自动分配 IP (DHCP) 和固定 IP (Static IP) 的配置方法。

---

## 目录

- [WiFi 连接](#wifi-连接)
- [自动分配 IP (DHCP)](#自动分配-ip-dhcp)
- [固定 IP (Static IP)](#固定-ip-static-ip)
- [常用命令](#常用命令)

---

## WiFi 连接

### 扫描并列出可用 WiFi

```bash
nmcli device wifi list
```

### 连接至 WiFi

```bash
nmcli device wifi connect "你的WiFi名称" password "你的密码"
```

### 查看当前连接状态

```bash
nmcli device status
nmcli connection show
```

---

## 自动分配 IP (DHCP)

DHCP 是默认的网络配置方式，由路由器自动分配 IP 地址、子网掩码、网关和 DNS 服务器。

### 方法一：连接时自动使用 DHCP

使用 `nmcli device wifi connect` 连接 WiFi 时，默认就会使用 DHCP 自动分配 IP：

```bash
nmcli device wifi connect "你的WiFi名称" password "你的密码"
```

### 方法二：为现有连接配置 DHCP

如果连接已存在，可以修改为使用 DHCP：

```bash
# 查看现有连接
nmcli connection show

# 修改连接使用 DHCP（替换 "连接名称" 为实际的连接名称）
nmcli connection modify "连接名称" ipv4.method auto

# 重新激活连接
nmcli connection down "连接名称"
nmcli connection up "连接名称"
```

### 方法三：创建新的以太网连接使用 DHCP

```bash
# 创建以太网连接（使用 DHCP）
nmcli connection add type ethernet con-name "我的以太网" ifname eth0 ipv4.method auto

# 激活连接
nmcli connection up "我的以太网"
```

---

## 固定 IP (Static IP)

当需要为设备配置固定 IP 地址时，可以使用以下方法。

### 方法一：连接 WiFi 时指定固定 IP

```bash
nmcli device wifi connect "你的WiFi名称" password "你的密码" \
  ipv4.method manual \
  ipv4.addresses 192.168.1.100/24 \
  ipv4.gateway 192.168.1.1 \
  ipv4.dns "8.8.8.8 8.8.4.4"
```

参数说明：
- `ipv4.method manual`: 使用手动配置（固定 IP）
- `ipv4.addresses 192.168.1.100/24`: 设置 IP 地址和子网掩码（/24 表示 255.255.255.0）
- `ipv4.gateway 192.168.1.1`: 设置网关地址
- `ipv4.dns "8.8.8.8 8.8.4.4"`: 设置 DNS 服务器（多个 DNS 用空格分隔）

### 方法二：修改现有连接为固定 IP

```bash
# 查看现有连接
nmcli connection show

# 修改连接为固定 IP（替换 "连接名称" 为实际的连接名称）
nmcli connection modify "连接名称" \
  ipv4.method manual \
  ipv4.addresses 192.168.1.100/24 \
  ipv4.gateway 192.168.1.1 \
  ipv4.dns "8.8.8.8 8.8.4.4"

# 重新激活连接
nmcli connection down "连接名称"
nmcli connection up "连接名称"
```

### 方法三：创建新的以太网连接使用固定 IP

```bash
# 创建以太网连接（使用固定 IP）
nmcli connection add type ethernet \
  con-name "我的以太网-固定IP" \
  ifname eth0 \
  ipv4.method manual \
  ipv4.addresses 192.168.1.100/24 \
  ipv4.gateway 192.168.1.1 \
  ipv4.dns "8.8.8.8 8.8.4.4"

# 激活连接
nmcli connection up "我的以太网-固定IP"
```

### 方法四：使用交互式编辑器修改

```bash
# 打开交互式编辑器
nmcli connection edit "连接名称"

# 在编辑器中，可以使用以下命令：
# > set ipv4.method manual
# > set ipv4.addresses 192.168.1.100/24
# > set ipv4.gateway 192.168.1.1
# > set ipv4.dns 8.8.8.8
# > save
# > quit
```

---

## 常用命令

### 查看网络设备

```bash
# 查看所有网络设备
nmcli device status

# 查看设备详细信息
nmcli device show
```

### 管理连接

```bash
# 列出所有连接
nmcli connection show

# 查看特定连接的详细信息
nmcli connection show "连接名称"

# 激活连接
nmcli connection up "连接名称"

# 停用连接
nmcli connection down "连接名称"

# 删除连接
nmcli connection delete "连接名称"
```

### 重新加载配置

```bash
# 重新加载 NetworkManager 配置
sudo systemctl reload NetworkManager

# 重启 NetworkManager 服务
sudo systemctl restart NetworkManager
```

### 查看 IP 地址

```bash
# 使用 nmcli 查看
nmcli device show | grep IP4

# 使用 ip 命令查看
ip addr show

# 使用 ifconfig 查看（如果已安装）
ifconfig
```

---

## 注意事项

1. **权限要求**：某些 `nmcli` 命令可能需要 root 权限，如果遇到权限问题，请在命令前添加 `sudo`。

2. **连接名称**：如果连接名称包含空格，请使用引号括起来，例如 `"我的 WiFi 连接"`。

3. **子网掩码格式**：可以使用 CIDR 格式（如 `/24`）或传统格式（如 `255.255.255.0`），但 CIDR 格式更简洁。

4. **DNS 服务器**：可以指定多个 DNS 服务器，用空格分隔，例如 `"8.8.8.8 8.8.4.4 1.1.1.1"`。

5. **配置持久化**：使用 `nmcli` 修改的配置会自动保存，重启后仍然有效。

6. **验证配置**：修改配置后，建议使用 `nmcli connection show "连接名称"` 验证配置是否正确。

---

## 故障排查

### 连接失败

```bash
# 检查 NetworkManager 服务状态
sudo systemctl status NetworkManager

# 查看详细日志
sudo journalctl -u NetworkManager -f
```

### 恢复 DHCP 配置

如果固定 IP 配置出现问题，可以快速恢复为 DHCP：

```bash
nmcli connection modify "连接名称" ipv4.method auto
nmcli connection down "连接名称"
nmcli connection up "连接名称"
```

### 重置网络配置

```bash
# 删除所有连接（谨慎使用）
nmcli connection delete --all

# 重新扫描设备
nmcli device wifi rescan
```
