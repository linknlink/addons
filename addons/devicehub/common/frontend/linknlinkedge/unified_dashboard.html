<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿä¸€ç®¡ç†ç•Œé¢ - LinkNLink Edge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .nav {
            display: flex;
            gap: 1rem;
        }

        .nav a {
            text-decoration: none;
            color: #7f8c8d;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav a:hover, .nav a.active {
            background: #3498db;
            color: white;
        }

        .nav button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .nav button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: #ecf0f1;
            border: none;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .header-actions select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .card-header h3 {
            color: #2c3e50;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn.disabled {
            background: #6c757d;
            color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn.disabled:hover {
            background: #6c757d;
            transform: none;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.6rem 0.8rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        /* å®ä½“è¡¨æ ¼æ›´ç´§å‡‘ */
        #entitiesTable th,
        #entitiesTable td {
            padding: 0.4rem 0.4rem;
            font-size: 0.85rem;
        }
        
        /* æ“ä½œåˆ—æŒ‰é’®æ›´ç´§å‡‘ */
        #entitiesTable td:last-child {
            padding: 0.3rem 0.4rem;
        }
        
        #entitiesTable td:last-child .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }
        
        /* è®¾å¤‡è¡¨æ ¼æ“ä½œåˆ—æŒ‰é’®å¹¶æ’æ˜¾ç¤º */
        #devicesTable td:last-child {
            white-space: nowrap;
        }
        
        #devicesTable td:last-child > div {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: nowrap;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status.online {
            background: #d4edda;
            color: #155724;
        }

        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status.unavailable {
            background: #fff3cd;
            color: #856404;
        }

        .status.unknown {
            background: #e2e3e5;
            color: #6c757d;
        }

        .status.no-state {
            background: #f8f9fa;
            color: #6c757d;
            font-style: italic;
        }

        .attributes-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
            font-size: 0.9rem;
            color: #666;
        }

        .attributes-cell:hover {
            background: #f8f9fa;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
        }

        .attributes-preview {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .attributes-details {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .attribute-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 0.5rem;
        }

        .attribute-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .attribute-key {
            font-weight: bold;
            color: #495057;
            min-width: 120px;
        }

        .attribute-value {
            color: #6c757d;
            word-break: break-all;
            flex: 1;
            margin-left: 1rem;
        }

        .entity-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border-left: 4px solid #17a2b8;
        }

        .entity-info h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1.1rem;
        }

        .entity-info p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .device-type {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .device-type span {
            font-size: 1.2rem;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .control-group h4 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .control-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .control-buttons .btn {
            flex: 1;
            min-width: 80px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .table {
                font-size: 0.9rem;
            }
            
            .table th,
            .table td {
                padding: 0.5rem;
            }
        }

        /* è®¾å¤‡è¯¦æƒ…æ ·å¼ */
        .device-detail-section {
            margin-bottom: 2rem;
        }

        .device-detail-section h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ecf0f1;
        }

        /* å‹ç¼©çš„è®¾å¤‡ä¿¡æ¯æ ·å¼ */
        .device-info-compact {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .device-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.4rem;
        }

        .device-status {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .device-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .detail-value {
            color: #6c757d;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            text-align: right;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .detail-item label {
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .detail-item span {
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.online {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .source-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .source-badge.mqtt {
            background: #e3f2fd;
            color: #1565c0;
        }

        .source-badge.ha {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .entities-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .entity-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }

        .entity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .entity-header h5 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .entity-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .entity-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entity-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .entity-info span {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .entity-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        .no-entities {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* è®¾å¤‡æ§åˆ¶æ¨¡æ€æ¡†ä¸­çš„ç½®ç°æ ·å¼ */
        .control-group.disabled {
            opacity: 0.5;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
        }

        .control-group.disabled .disabled-title {
            color: #6c757d;
            font-style: italic;
        }

        .control-group.disabled .control-buttons.disabled {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .disabled-text {
            color: #6c757d;
            font-style: italic;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”— LinkNLink Edge - ç»Ÿä¸€ç®¡ç†ç•Œé¢</h1>
        <div class="nav">
            <a href="/">é¦–é¡µ</a>
            <a href="/linknlinkedge/web/mqtt_advanced_test.html">MQTTæµ‹è¯•</a>
            <a href="/linknlinkedge/web/simple_dashboard.html">ç®€å•ä»ªè¡¨æ¿</a>
            <button class="btn btn-primary" onclick="refreshAllData()" style="margin-left: 1rem;">
                ğŸ”„ åˆ·æ–°æ•°æ®
            </button>
            <label style="margin-left: 1rem; color: white; cursor: pointer;">
                <input type="checkbox" id="autoRefreshToggle" checked onchange="toggleAutoRefresh()" style="margin-right: 0.3rem;">
                è‡ªåŠ¨åˆ·æ–°
            </label>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab" onclick="switchTab('devices')">è®¾å¤‡ç®¡ç†</button>
            <button class="tab active" onclick="switchTab('entities')">å®ä½“ç®¡ç†</button>
            <button class="tab" onclick="switchTab('states')">çŠ¶æ€ç›‘æ§</button>
        </div>

        <!-- è®¾å¤‡ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="devices" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>è®¾å¤‡åˆ—è¡¨</h3>
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="deviceSearch" placeholder="æœç´¢è®¾å¤‡...">
                            <button class="btn btn-primary" onclick="filterDevices()">æœç´¢</button>
                            <button class="btn" onclick="clearDeviceSearch()">æ¸…é™¤</button>
                        </div>
                        <button class="btn btn-warning" onclick="selectAllCurrentPageDevices()">å…¨é€‰å½“å‰é¡µé¢</button>
                        <button class="btn btn-warning" onclick="selectAllDevices()">å…¨é€‰æ‰€æœ‰</button>
                        <button class="btn btn-danger" onclick="deleteSelectedDevices()" id="deleteSelectedDevices" disabled>åˆ é™¤é€‰ä¸­</button>
                        <button class="btn btn-success" onclick="showAddDeviceModal()">æ·»åŠ è®¾å¤‡</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="devicesLoading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="devicesError" class="error" style="display: none;"></div>
                    <table class="table" id="devicesTable" style="display: none;">
                        <thead>
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>åç§°</th>
                                <th>åˆ¶é€ å•†</th>
                                <th>å‹å·</th>
                                <th>æœ€åæ´»è·ƒ</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="devicesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å®ä½“ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="entities" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3>å®ä½“åˆ—è¡¨</h3>
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="entitySearch" placeholder="æœç´¢å®ä½“...">
                            <button class="btn btn-primary" onclick="filterEntities()">æœç´¢</button>
                            <button class="btn" onclick="clearEntitySearch()">æ¸…é™¤</button>
                        </div>
                        <select id="domainFilter" onchange="filterEntities()">
                            <option value="">æ‰€æœ‰ domain</option>
                        </select>
                        <select id="deviceClassFilter" onchange="filterEntities()">
                            <option value="">æ‰€æœ‰ device_class</option>
                        </select>
                        <button class="btn btn-info" onclick="refreshEntityStates()">åˆ·æ–°çŠ¶æ€</button>
                        <button class="btn btn-warning" onclick="selectAllCurrentPageEntities()">å…¨é€‰å½“å‰é¡µé¢</button>
                        <button class="btn btn-warning" onclick="selectAllEntities()">å…¨é€‰æ‰€æœ‰</button>
                        <button class="btn btn-danger" onclick="deleteSelectedEntities()" id="deleteSelectedEntities" disabled>åˆ é™¤é€‰ä¸­</button>
                        <button class="btn btn-success" onclick="showAddEntityModal()">æ·»åŠ å®ä½“</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="entitiesLoading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="entitiesError" class="error" style="display: none;"></div>
                    <table class="table" id="entitiesTable" style="display: none;">
                        <thead>
                            <tr>
                                <th></th>
                                <th>å®ä½“ID</th>
                                <th>åç§°</th>
                                <th>domain</th>
                                <th>device_class</th>
                                <th>å½“å‰çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æœ€åæ›´æ–°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="entitiesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€ç›‘æ§æ ‡ç­¾é¡µ -->
        <div id="states" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>çŠ¶æ€ç›‘æ§</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="stateSearchInput" placeholder="æœç´¢å®ä½“ID..." 
                               style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; width: 250px;">
                        <button class="btn" onclick="filterStateCache()">æœç´¢</button>
                        <span id="stateCacheInfo" style="color: #666; font-size: 0.9rem;">ç¼“å­˜: 0 æ¡</span>
                        <button class="btn" onclick="clearStateCache()">æ¸…ç©ºç¼“å­˜</button>
                        <button class="btn" onclick="refreshStates()">åˆ·æ–°çŠ¶æ€</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="statesLoading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="statesError" class="error" style="display: none;"></div>
                    <table class="table" id="statesTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>å®ä½“ID</th>
                                <th>çŠ¶æ€å’Œå±æ€§</th>
                            </tr>
                        </thead>
                        <tbody id="statesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ è®¾å¤‡</h3>
                <span class="close" onclick="closeModal('addDeviceModal')">&times;</span>
            </div>
            <form id="addDeviceForm">
                <div class="form-group">
                    <label for="deviceName">è®¾å¤‡åç§° *</label>
                    <input type="text" id="deviceName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="deviceManufacturer">åˆ¶é€ å•†</label>
                    <input type="text" id="deviceManufacturer" name="manufacturer">
                </div>
                <div class="form-group">
                    <label for="deviceModel">å‹å·</label>
                    <input type="text" id="deviceModel" name="model">
                </div>
                <div class="form-group">
                    <label for="deviceSWVersion">è½¯ä»¶ç‰ˆæœ¬</label>
                    <input type="text" id="deviceSWVersion" name="sw_version">
                </div>
                <div class="form-group">
                    <label for="deviceHWVersion">ç¡¬ä»¶ç‰ˆæœ¬</label>
                    <input type="text" id="deviceHWVersion" name="hw_version">
                </div>
                <div class="form-group">
                    <label for="deviceArea">å»ºè®®åŒºåŸŸ</label>
                    <input type="text" id="deviceArea" name="suggested_area">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addDeviceModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="deviceDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>è®¾å¤‡è¯¦æƒ…</h3>
                <span class="close" onclick="closeModal('deviceDetailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="deviceDetailContent">
                    <!-- è®¾å¤‡è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å®ä½“æ¨¡æ€æ¡† -->
    <div id="addEntityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ å®ä½“</h3>
                <span class="close" onclick="closeModal('addEntityModal')">&times;</span>
            </div>
            <form id="addEntityForm">
                <div class="form-group">
                    <label for="entityID">å®ä½“ID *</label>
                    <input type="text" id="entityID" name="entity_id" required placeholder="ä¾‹å¦‚: sensor.temperature">
                </div>
                <div class="form-group">
                    <label for="entityName">å®ä½“åç§°</label>
                    <input type="text" id="entityName" name="name">
                </div>
                <div class="form-group">
                    <label for="entityDomain">åŸŸ *</label>
                    <select id="entityDomain" name="domain" required>
                        <option value="">é€‰æ‹©åŸŸ</option>
                        <option value="sensor">ä¼ æ„Ÿå™¨</option>
                        <option value="binary_sensor">äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨</option>
                        <option value="switch">å¼€å…³</option>
                        <option value="light">ç¯å…‰</option>
                        <option value="climate">æ°”å€™æ§åˆ¶</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="entityClass">å®ä½“ç±»å‹</label>
                    <input type="text" id="entityClass" name="entity_class">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addEntityModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å®ä½“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="entityDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>å®ä½“çŠ¶æ€ JSON</h3>
                <span class="close" onclick="closeModal('entityDetailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="entityDetailContent">
                    <!-- å®ä½“è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('entityDetailModal')">å…³é—­</button>
                <button class="btn btn-info" onclick="copyEntityDetailToClipboard()">å¤åˆ¶JSON</button>
            </div>
        </div>
    </div>

    <!-- å±æ€§è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="attributesModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>å®ä½“å±æ€§è¯¦æƒ…</h3>
                <span class="close" onclick="closeModal('attributesModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entity-info">
                    <h4 id="attributesEntityId"></h4>
                    <p id="attributesEntityName"></p>
                </div>
                <div class="attributes-details" id="attributesDetails">
                    <!-- å±æ€§è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('attributesModal')">å…³é—­</button>
                <button class="btn btn-info" onclick="copyAttributesToClipboard()">å¤åˆ¶JSON</button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'entities';
        let devices = [];
        let entities = [];
        let states = [];
        let wsClient = null;
        let wsConnected = false;
        let messageIdCounter = 1; // WebSocketæ¶ˆæ¯IDè®¡æ•°å™¨
        let isRenderingEntities = false; // é˜²æ­¢é‡å¤æ¸²æŸ“
        let refreshDebounceTimer = null; // é˜²æŠ–å®šæ—¶å™¨
        let autoRefreshEnabled = true; // è‡ªåŠ¨åˆ·æ–°å¼€å…³
        let lastRefreshTime = 0; // ä¸Šæ¬¡åˆ·æ–°æ—¶é—´
        const MIN_REFRESH_INTERVAL = 3000; // æœ€å°åˆ·æ–°é—´éš”3ç§’
        
        // çŠ¶æ€å˜æ›´ç¼“å­˜
        let stateChangedCache = []; // ç¼“å­˜state_changedæ¶ˆæ¯
        const MAX_CACHE_SIZE = 30 * 1024 * 1024; // 30MBé™åˆ¶
        let statesRenderTimer = null; // çŠ¶æ€è¡¨æ ¼å®šæ—¶æ¸²æŸ“å®šæ—¶å™¨

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°å¼€å…³
        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            autoRefreshEnabled = toggle.checked;
            console.log('è‡ªåŠ¨åˆ·æ–°å·²' + (autoRefreshEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'));
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // é‡ç½®åˆ·æ–°æ—¶é—´ï¼Œå…è®¸ç«‹å³åˆ·æ–°
            lastRefreshTime = 0;
            
            // åŠ è½½å¯¹åº”æ•°æ®
            switch(tabName) {
                case 'devices':
                    stopStatesRenderTimer(); // åœæ­¢çŠ¶æ€è¡¨æ ¼å®šæ—¶æ¸²æŸ“
                    loadDevices();
                    break;
                case 'entities':
                    stopStatesRenderTimer(); // åœæ­¢çŠ¶æ€è¡¨æ ¼å®šæ—¶æ¸²æŸ“
                    loadEntities();
                    break;
                case 'states':
                    loadStates();
                    startStatesRenderTimer(); // å¯åŠ¨çŠ¶æ€è¡¨æ ¼å®šæ—¶æ¸²æŸ“
                    break;
            }
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            const loading = document.getElementById('devicesLoading');
            const error = document.getElementById('devicesError');
            const table = document.getElementById('devicesTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const response = await fetch('/linknlinkedge/api/devices');
                const data = await response.json();
                
                if (response.ok) {
                    devices = data.devices || [];
                    renderDevicesTable();
                    loading.style.display = 'none';
                    table.style.display = 'table';
                } else {
                    throw new Error(data.error || 'åŠ è½½è®¾å¤‡å¤±è´¥');
                }
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = err.message;
            }
        }

        // æ¸²æŸ“è®¾å¤‡è¡¨æ ¼
        function renderDevicesTable() {
            const tbody = document.getElementById('devicesTableBody');
            tbody.innerHTML = '';
            
            devices.forEach(device => {
                const row = document.createElement('tr');
                
                // æ ¼å¼åŒ–æœ€åæ´»è·ƒæ—¶é—´
                let lastSeenText = '-';
                if (device.last_seen) {
                    const lastSeen = new Date(device.last_seen);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastSeen) / (1000 * 60));
                    
                    if (diffMinutes < 1) {
                        lastSeenText = 'åˆšåˆš';
                    } else if (diffMinutes < 60) {
                        lastSeenText = `${diffMinutes}åˆ†é’Ÿå‰`;
                    } else if (diffMinutes < 1440) {
                        lastSeenText = `${Math.floor(diffMinutes / 60)}å°æ—¶å‰`;
                    } else {
                        lastSeenText = lastSeen.toLocaleString();
                    }
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="device-checkbox" value="${device.id}" onchange="updateDeviceSelection()"></td>
                    <td>${device.id}</td>
                    <td>${device.name || '-'}</td>
                    <td>${device.manufacturer || '-'}</td>
                    <td>${device.model || '-'}</td>
                    <td>${lastSeenText}</td>
                    <td>${new Date(device.created_at).toLocaleString()}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap;">
                            <button class="btn btn-info" onclick="showDeviceDetail('${device.id}')">è¯¦æƒ…</button>
                            <button class="btn btn-success" onclick="controlDevice('${device.id}')">æ§åˆ¶</button>
                            <button class="btn btn-danger" onclick="deleteDevice('${device.id}')">åˆ é™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // åŠ è½½å®ä½“åˆ—è¡¨
        async function loadEntities() {
            // å¦‚æœæ­£åœ¨æ¸²æŸ“ï¼Œè·³è¿‡é‡å¤åŠ è½½
            if (isRenderingEntities) {
                console.log('å®ä½“è¡¨æ ¼æ­£åœ¨æ¸²æŸ“ä¸­ï¼Œè·³è¿‡é‡å¤åŠ è½½');
                return;
            }
            
            const loading = document.getElementById('entitiesLoading');
            const error = document.getElementById('entitiesError');
            const table = document.getElementById('entitiesTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const response = await fetch('/linknlinkedge/api/entities');
                const data = await response.json();
                
                if (response.ok) {
                    entities = data.entities || [];
                    updateFilterOptions(); // æ›´æ–°ç­›é€‰é€‰é¡¹
                    await renderEntitiesTable(); // ç­‰å¾…æ¸²æŸ“å®Œæˆ
                    loading.style.display = 'none';
                    table.style.display = 'table';
                } else {
                    throw new Error(data.error || 'åŠ è½½å®ä½“å¤±è´¥');
                }
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = err.message;
                isRenderingEntities = false; // ç¡®ä¿é‡ç½®æ ‡å¿—
            }
        }

        // è·å–å®ä½“çŠ¶æ€
        async function getEntityState(entityId) {
            try {
                const response = await fetch(`/linknlinkedge/api/states/${entityId}`);
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('è·å–å®ä½“çŠ¶æ€å¤±è´¥:', error);
                return null;
            }
        }

        // åˆ·æ–°å®ä½“çŠ¶æ€
        async function refreshEntityStates() {
            const loading = document.getElementById('entitiesLoading');
            const error = document.getElementById('entitiesError');
            const table = document.getElementById('entitiesTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';
            
            try {
                await renderEntitiesTable();
                loading.style.display = 'none';
                table.style.display = 'table';
                showMessage('å®ä½“çŠ¶æ€å·²åˆ·æ–°', 'success');
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = err.message;
            }
        }

        // æ˜¾ç¤ºå±æ€§è¯¦æƒ…
        function showAttributesDetails(entityId, attributes) {
            const modal = document.getElementById('attributesModal');
            const entityIdElement = document.getElementById('attributesEntityId');
            const entityNameElement = document.getElementById('attributesEntityName');
            const detailsElement = document.getElementById('attributesDetails');
            
            // æŸ¥æ‰¾å®ä½“ä¿¡æ¯
            const entity = entities.find(e => e.entity_id === entityId);
            
            entityIdElement.textContent = entityId;
            entityNameElement.textContent = entity ? entity.name || 'æœªå‘½åå®ä½“' : 'æœªçŸ¥å®ä½“';
            
            // è§£æå±æ€§
            let attributesObj;
            try {
                attributesObj = typeof attributes === 'string' ? JSON.parse(attributes) : attributes;
            } catch (e) {
                attributesObj = {};
            }
            
            // ç”Ÿæˆå±æ€§è¯¦æƒ…HTML
            if (Object.keys(attributesObj).length === 0) {
                detailsElement.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">è¯¥å®ä½“æš‚æ— å±æ€§ä¿¡æ¯</p>';
            } else {
                let html = '';
                for (const [key, value] of Object.entries(attributesObj)) {
                    const valueStr = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
                    html += `
                        <div class="attribute-item">
                            <div class="attribute-key">${key}</div>
                            <div class="attribute-value">${valueStr}</div>
                        </div>
                    `;
                }
                detailsElement.innerHTML = html;
            }
            
            // å­˜å‚¨å½“å‰å±æ€§ç”¨äºå¤åˆ¶
            window.currentAttributes = attributesObj;
            
            modal.style.display = 'block';
        }

        // å¤åˆ¶å±æ€§åˆ°å‰ªè´´æ¿
        function copyAttributesToClipboard() {
            if (window.currentAttributes) {
                const jsonStr = JSON.stringify(window.currentAttributes, null, 2);
                navigator.clipboard.writeText(jsonStr).then(() => {
                    showMessage('å±æ€§JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            }
        }

        // æ¸²æŸ“å®ä½“è¡¨æ ¼
        async function renderEntitiesTable() {
            // é˜²æ­¢é‡å¤æ¸²æŸ“
            if (isRenderingEntities) {
                console.log('å®ä½“è¡¨æ ¼æ­£åœ¨æ¸²æŸ“ä¸­ï¼Œè·³è¿‡é‡å¤æ¸²æŸ“');
                return;
            }
            
            isRenderingEntities = true;
            const tbody = document.getElementById('entitiesTableBody');
            
            try {
                tbody.innerHTML = '';
                
                // å¦‚æœå®ä½“åˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥æ˜¾ç¤ºç©ºçŠ¶æ€
                if (!entities || entities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #6c757d;">æš‚æ— å®ä½“æ•°æ®</td></tr>';
                    return;
                }
                
                // å…ˆæ¸²æŸ“å®ä½“åˆ—è¡¨ï¼ˆä¸ç­‰å¾…çŠ¶æ€ï¼‰ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
                entities.forEach(entity => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-entity-id', entity.entity_id); // æ·»åŠ æ ‡è¯†å±æ€§
                    row.innerHTML = `
                        <td><input type="checkbox" class="entity-checkbox" value="${entity.entity_id}" onchange="updateEntitySelection()"></td>
                        <td>${entity.entity_id}</td>
                        <td>${entity.name || '-'}</td>
                        <td data-domain="${entity.domain}">${entity.domain}</td>
                        <td data-device-class="${entity.device_class || entity.domain || '-'}"><span class="device-type">${getEntityIconForDomain(entity.domain)} ${entity.device_class || entity.domain || '-'}</span></td>
                        <td><span class="status unknown">åŠ è½½ä¸­...</span></td>
                        <td>${new Date(entity.created_at || Date.now()).toLocaleString()}</td>
                        <td>åŠ è½½ä¸­...</td>
                        <td style="white-space: nowrap;">
                            <div style="display: flex; gap: 0.25rem; align-items: center;">
                                ${isEntityControlSupported(entity.domain) ? `<button class="btn btn-sm btn-success" onclick="controlEntity('${entity.entity_id}')">æ§åˆ¶</button>` : ''}
                                <button class="btn btn-sm btn-info" onclick="showEntityDetail('${entity.entity_id}')">è¯¦æƒ…</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteEntity('${entity.entity_id}')">åˆ é™¤</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // å¹¶è¡Œè·å–æ‰€æœ‰å®ä½“çš„çŠ¶æ€ï¼ˆå¸¦è¶…æ—¶å’Œé”™è¯¯å¤„ç†ï¼‰
                const statePromises = entities.map(async (entity) => {
                    try {
                        // è®¾ç½®3ç§’è¶…æ—¶ï¼ˆå‡å°‘è¶…æ—¶æ—¶é—´ï¼‰
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('timeout')), 3000)
                        );
                        const statePromise = getEntityState(entity.entity_id);
                        const state = await Promise.race([statePromise, timeoutPromise]);
                        return { entityId: entity.entity_id, state, error: null };
                    } catch (error) {
                        console.warn(`è·å–å®ä½“ ${entity.entity_id} çŠ¶æ€å¤±è´¥:`, error);
                        return { entityId: entity.entity_id, state: null, error: error.message };
                    }
                });
                
                // ç­‰å¾…æ‰€æœ‰çŠ¶æ€è·å–å®Œæˆï¼ˆä½¿ç”¨ allSettled ç¡®ä¿å³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿèƒ½ç»§ç»­ï¼‰
                const results = await Promise.allSettled(statePromises);
                const entityStates = {};
                results.forEach((result) => {
                    if (result.status === 'fulfilled' && result.value && result.value.state) {
                        entityStates[result.value.entityId] = result.value.state;
                    }
                });
                
                // æ›´æ–°è¡¨æ ¼ä¸­çš„çŠ¶æ€ä¿¡æ¯
                entities.forEach((entity, index) => {
                    const row = tbody.querySelector(`tr[data-entity-id="${entity.entity_id}"]`);
                    if (!row) return;
                    
                    const state = entityStates[entity.entity_id];
                    
                    // è·å–å®ä½“çŠ¶æ€ï¼ˆå³ä½¿è·å–å¤±è´¥ä¹Ÿæ˜¾ç¤ºunknownï¼Œè€Œä¸æ˜¯ä¸€ç›´æ˜¾ç¤º"åŠ è½½ä¸­"ï¼‰
                    const currentState = state ? state.state : 'unknown';
                    const attributes = state ? state.attributes : {};
                    const lastUpdated = state ? state.last_updated : (entity.created_at || new Date().toISOString());
                    
                    // æ ¹æ®çŠ¶æ€ç¡®å®šæ˜¾ç¤ºæ–‡æœ¬å’ŒCSSç±»
                    let statusText = currentState;
                    let statusClass = '';
                    
                    // buttonç±»å‹ä¸æ˜¾ç¤ºçŠ¶æ€ï¼Œåªæ˜¾ç¤º"æ— çŠ¶æ€"
                    if (entity.domain === 'button') {
                        statusText = 'æ— çŠ¶æ€';
                        statusClass = 'no-state';
                    } else if (entity.domain === 'light') {
                        // lightç±»å‹çŠ¶æ€å€¼å·²ç»æ˜¯on/offï¼Œç›´æ¥è½¬æ¢æ˜¾ç¤º
                        if (currentState === 'on') {
                            statusText = 'å¼€å¯';
                            statusClass = 'online';
                        } else if (currentState === 'off') {
                            statusText = 'å…³é—­';
                            statusClass = 'offline';
                        } else {
                            statusText = currentState === 'unknown' ? 'æœªçŸ¥' : currentState;
                            statusClass = 'unknown';
                        }
                    } else if (entity.domain === 'climate') {
                        // climateç±»å‹çŠ¶æ€å€¼å·²ç»æ˜¯hvac_modeï¼Œç›´æ¥æ˜¾ç¤ºæ¨¡å¼
                        statusText = currentState === 'unknown' ? 'æœªçŸ¥' : currentState;
                        statusClass = currentState === 'unknown' ? 'unknown' : 'online';
                    } else if (currentState === 'unavailable') {
                        statusText = 'ä¸å¯ç”¨';
                        statusClass = 'unavailable';
                    } else if (currentState === 'unknown') {
                        statusText = 'æœªçŸ¥';
                        statusClass = 'unknown';
                    } else {
                        statusClass = 'online';
                    }
                    
                    // æ›´æ–°çŠ¶æ€åˆ—
                    const statusCell = row.cells[5];
                    if (statusCell) {
                        statusCell.innerHTML = `<span class="status ${statusClass}">${statusText}</span>`;
                    }
                    
                    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´ï¼ˆç´¢å¼•æ”¹ä¸º7ï¼Œå› ä¸ºåˆ é™¤äº†å±æ€§åˆ—ï¼‰
                    const lastUpdatedCell = row.cells[7];
                    if (lastUpdatedCell) {
                        try {
                            lastUpdatedCell.textContent = new Date(lastUpdated).toLocaleString();
                        } catch (e) {
                            lastUpdatedCell.textContent = '-';
                        }
                    }
                });
            } catch (error) {
                console.error('æ¸²æŸ“å®ä½“è¡¨æ ¼å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #e74c3c;">æ¸²æŸ“å¤±è´¥: ' + error.message + '</td></tr>';
            } finally {
                isRenderingEntities = false;
            }
        }
        
        // è·å–å®ä½“åŸŸå›¾æ ‡ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
        function getEntityIconForDomain(domain) {
            const icons = {
                'temperature': 'ğŸŒ¡ï¸',
                'humidity': 'ğŸ’§',
                'illuminance': 'â˜€ï¸',
                'power': 'âš¡',
                'button': 'ğŸ”˜',
                'sensor': 'ğŸ“Š',
                'light': 'ğŸ’¡',
                'switch': 'ğŸ”Œ',
                'climate': 'ğŸŒ¡ï¸',
                'fan': 'ğŸŒ€',
                'cover': 'ğŸªŸ',
                'lock': 'ğŸ”’',
                'media_player': 'ğŸµ',
                'binary_sensor': 'ğŸ“¡'
            };
            return icons[domain] || 'ğŸ“±';
        }
        
        // è·å–å®ä½“ç±»å‹æ–‡æœ¬ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
        function getEntityTypeText(entity) {
            const deviceClass = entity.device_class || entity.domain || 'unknown';
            const typeMap = {
                'temperature': 'æ¸©åº¦ä¼ æ„Ÿå™¨',
                'humidity': 'æ¹¿åº¦ä¼ æ„Ÿå™¨',
                'illuminance': 'å…‰ç…§ä¼ æ„Ÿå™¨',
                'power': 'åŠŸè€—ä¼ æ„Ÿå™¨',
                'button': 'æŒ‰é’®',
                'sensor': 'ä¼ æ„Ÿå™¨',
                'light': 'ç¯å…‰',
                'switch': 'å¼€å…³',
                'climate': 'ç©ºè°ƒ',
                'fan': 'é£æ‰‡',
                'cover': 'çª—å¸˜',
                'lock': 'é—¨é”',
                'media_player': 'åª’ä½“æ’­æ”¾å™¨',
                'binary_sensor': 'äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨'
            };
            return typeMap[deviceClass] || typeMap[entity.domain] || deviceClass;
        }
        
        // è®¡ç®—ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        function calculateCacheSize() {
            return new Blob([JSON.stringify(stateChangedCache)]).size;
        }
        
        // æ¸…ç†æ—§ç¼“å­˜æ•°æ®ï¼Œä¿æŒç¼“å­˜å¤§å°åœ¨30MBä»¥å†…
        function trimCache() {
            let cacheSize = calculateCacheSize();
            while (cacheSize > MAX_CACHE_SIZE && stateChangedCache.length > 0) {
                // åˆ é™¤æœ€è€çš„æ•°æ®ï¼ˆæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰
                stateChangedCache.shift();
                cacheSize = calculateCacheSize();
            }
            updateCacheInfo();
        }
        
        // æ›´æ–°ç¼“å­˜ä¿¡æ¯æ˜¾ç¤º
        function updateCacheInfo() {
            const cacheInfo = document.getElementById('stateCacheInfo');
            if (cacheInfo) {
                const sizeMB = (calculateCacheSize() / (1024 * 1024)).toFixed(2);
                cacheInfo.textContent = `ç¼“å­˜: ${stateChangedCache.length} æ¡ (${sizeMB} MB)`;
            }
        }
        
        // æ·»åŠ state_changedæ¶ˆæ¯åˆ°ç¼“å­˜
        function addToStateCache(eventData) {
            if (!eventData || !eventData.new_state) {
                console.warn('æ— æ•ˆçš„state_changedæ•°æ®:', eventData);
                return;
            }
            
            const cacheItem = {
                timestamp: new Date().toISOString(),
                entity_id: eventData.entity_id || (eventData.new_state && eventData.new_state.entity_id) || 'æœªçŸ¥',
                new_state: eventData.new_state,
                time_fired: eventData.time_fired || new Date().toISOString()
            };
            
            // æ·»åŠ åˆ°æ•°ç»„æœ«å°¾ï¼ˆæœ€æ–°çš„ï¼‰
            stateChangedCache.push(cacheItem);
            
            // æ£€æŸ¥å¹¶æ¸…ç†æ—§æ•°æ®
            trimCache();
        }
        
        // æ¸…ç©ºç¼“å­˜
        function clearStateCache() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿ')) {
                stateChangedCache = [];
                updateCacheInfo();
                renderStatesTable();
            }
        }
        
        // è¿‡æ»¤ç¼“å­˜æ•°æ®
        function filterStateCache() {
            renderStatesTable();
        }
        
        // åŠ è½½çŠ¶æ€åˆ—è¡¨ï¼ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼‰
        async function loadStates() {
            const loading = document.getElementById('statesLoading');
            const error = document.getElementById('statesError');
            const table = document.getElementById('statesTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';
            
            try {
                // ç›´æ¥æ˜¾ç¤ºç¼“å­˜æ•°æ®
                renderStatesTable();
                updateCacheInfo();
                loading.style.display = 'none';
                table.style.display = 'table';
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = err.message;
            }
        }
        
        // åˆ·æ–°çŠ¶æ€ï¼ˆæ‰‹åŠ¨åˆ·æ–°ï¼‰
        function refreshStates() {
            renderStatesTable();
            updateCacheInfo();
        }

        // æ¸²æŸ“çŠ¶æ€è¡¨æ ¼ï¼ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼‰
        function renderStatesTable() {
            const tbody = document.getElementById('statesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // è·å–æœç´¢å…³é”®è¯
            const searchInput = document.getElementById('stateSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            
            // è¿‡æ»¤ç¼“å­˜æ•°æ®
            let filteredCache = stateChangedCache;
            if (searchTerm) {
                filteredCache = stateChangedCache.filter(item => {
                    const entityId = item.entity_id || (item.new_state && item.new_state.entity_id) || '';
                    return entityId.toLowerCase().includes(searchTerm);
                });
            }
            
            // æŒ‰æ—¶é—´ä»æ–°åˆ°è€æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            filteredCache = [...filteredCache].sort((a, b) => {
                const timeA = new Date(a.timestamp || a.time_fired);
                const timeB = new Date(b.timestamp || b.time_fired);
                return timeB - timeA; // é™åºæ’åˆ—
            });
            
            if (filteredCache.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3" style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</td>';
                tbody.appendChild(row);
                return;
            }
            
            filteredCache.forEach(item => {
                const row = document.createElement('tr');
                // ç¡®ä¿ä» new_state ä¸­è·å–æ‰€æœ‰æ•°æ®
                const newState = item.new_state || {};
                const entityId = newState.entity_id || item.entity_id || 'æœªçŸ¥';
                const timestamp = item.timestamp || item.time_fired || new Date().toISOString();
                
                // å°†new_stateçš„å®Œæ•´å†…å®¹åˆå¹¶æˆä¸€ä¸ªJSONå¯¹è±¡
                let stateJsonStr = '{}';
                try {
                    // åˆ›å»ºåŒ…å«new_stateæ‰€æœ‰å­—æ®µçš„å®Œæ•´å¯¹è±¡
                    const fullState = {
                        ...newState
                    };
                    stateJsonStr = JSON.stringify(fullState, null, 2);
                } catch (e) {
                    stateJsonStr = String(newState);
                }
                
                row.innerHTML = `
                    <td>${new Date(timestamp).toLocaleString()}</td>
                    <td>${entityId}</td>
                    <td style="max-width: 600px; overflow-x: auto;"><pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${stateJsonStr}</pre></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // å¯åŠ¨çŠ¶æ€è¡¨æ ¼å®šæ—¶æ¸²æŸ“ï¼ˆæ¯3ç§’ï¼‰
        function startStatesRenderTimer() {
            // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (statesRenderTimer) {
                clearInterval(statesRenderTimer);
            }
            
            // åªåœ¨çŠ¶æ€ç›‘æ§æ ‡ç­¾é¡µæ—¶å¯åŠ¨å®šæ—¶å™¨
            if (currentTab === 'states') {
                statesRenderTimer = setInterval(() => {
                    if (currentTab === 'states') {
                        renderStatesTable();
                        updateCacheInfo();
                    }
                }, 3000); // æ¯3ç§’æ¸²æŸ“ä¸€æ¬¡
            }
        }
        
        // åœæ­¢çŠ¶æ€è¡¨æ ¼å®šæ—¶æ¸²æŸ“
        function stopStatesRenderTimer() {
            if (statesRenderTimer) {
                clearInterval(statesRenderTimer);
                statesRenderTimer = null;
            }
        }

        // æ˜¾ç¤ºæ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'block';
        }

        // æ˜¾ç¤ºæ·»åŠ å®ä½“æ¨¡æ€æ¡†
        function showAddEntityModal() {
            document.getElementById('addEntityModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ·»åŠ è®¾å¤‡è¡¨å•æäº¤
        document.getElementById('addDeviceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const deviceData = Object.fromEntries(formData.entries());
            
            // ç”ŸæˆUUID
            deviceData.id = 'device_' + Date.now();
            
            try {
                const response = await fetch('/linknlinkedge/api/devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(deviceData)
                });
                
                if (response.ok) {
                    closeModal('addDeviceModal');
                    this.reset();
                    loadDevices();
                    showMessage('è®¾å¤‡æ·»åŠ æˆåŠŸ', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'æ·»åŠ è®¾å¤‡å¤±è´¥');
                }
            } catch (err) {
                showMessage(err.message, 'error');
            }
        });

        // æ·»åŠ å®ä½“è¡¨å•æäº¤
        document.getElementById('addEntityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const entityData = Object.fromEntries(formData.entries());
            
            // ç”ŸæˆUUID
            entityData.id = 'entity_' + Date.now();
            
            try {
                const response = await fetch('/linknlinkedge/api/entities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(entityData)
                });
                
                if (response.ok) {
                    closeModal('addEntityModal');
                    this.reset();
                    loadEntities();
                    showMessage('å®ä½“æ·»åŠ æˆåŠŸ', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'æ·»åŠ å®ä½“å¤±è´¥');
                }
            } catch (err) {
                showMessage(err.message, 'error');
            }
        });

        // åˆ é™¤è®¾å¤‡
        async function deleteDevice(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/linknlinkedge/api/devices/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadDevices();
                    showMessage('è®¾å¤‡åˆ é™¤æˆåŠŸ', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'åˆ é™¤è®¾å¤‡å¤±è´¥');
                }
            } catch (err) {
                showMessage(err.message, 'error');
            }
        }

        // åˆ é™¤å®ä½“
        async function deleteEntity(entityId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®ä½“å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/linknlinkedge/api/entities/${entityId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadEntities();
                    showMessage('å®ä½“åˆ é™¤æˆåŠŸ', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'åˆ é™¤å®ä½“å¤±è´¥');
                }
            } catch (err) {
                showMessage(err.message, 'error');
            }
        }


        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ç¼–è¾‘è®¾å¤‡
        function editDevice(id) {
            showMessage('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'error');
        }

        // ç¼–è¾‘å®ä½“
        function editEntity(entityId) {
            showMessage('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'error');
        }

        // æ˜¾ç¤ºå®ä½“è¯¦æƒ…ï¼ˆstatesæ¥å£è¿”å›çš„JSONï¼‰
        async function showEntityDetail(entityId) {
            try {
                // åªè·å– /api/states/{entityId} æ¥å£è¿”å›çš„ JSON
                const response = await fetch(`/linknlinkedge/api/states/${entityId}`);
                if (!response.ok) {
                    throw new Error('è·å–å®ä½“çŠ¶æ€å¤±è´¥');
                }
                
                const stateData = await response.json();
                displayEntityDetail(stateData, entityId);
            } catch (error) {
                console.error('è·å–å®ä½“è¯¦æƒ…å¤±è´¥:', error);
                showMessage('è·å–å®ä½“è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºå®ä½“è¯¦æƒ…å†…å®¹ï¼ˆç›´æ¥æ˜¾ç¤ºstatesæ¥å£è¿”å›çš„JSONï¼‰
        function displayEntityDetail(stateData, entityId) {
            const modal = document.getElementById('entityDetailModal');
            const content = document.getElementById('entityDetailContent');
            
            // æ ¼å¼åŒ–JSONæ˜¾ç¤º
            const jsonStr = JSON.stringify(stateData, null, 2);
            
            // å­˜å‚¨å½“å‰å®ä½“æ•°æ®ç”¨äºå¤åˆ¶
            window.currentEntityDetail = stateData;
            
            // æ˜¾ç¤ºæ ¼å¼åŒ–çš„JSON
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;">å®ä½“ID: ${entityId || stateData.entity_id || 'æœªçŸ¥'}</h4>
                    <p style="color: #6c757d; margin: 0;">API: /linknlinkedge/api/states/${entityId || stateData.entity_id || ''}</p>
                </div>
                <pre style="background: #282c34; color: #abb2bf; padding: 1.5rem; border-radius: 5px; overflow-x: auto; max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5;">${escapeHtml(jsonStr)}</pre>
            `;
            
            modal.style.display = 'block';
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¤åˆ¶å®ä½“è¯¦æƒ…åˆ°å‰ªè´´æ¿
        function copyEntityDetailToClipboard() {
            if (!window.currentEntityDetail) {
                showMessage('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'error');
                return;
            }
            
            const jsonStr = JSON.stringify(window.currentEntityDetail, null, 2);
            
            // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(jsonStr).then(() => {
                    showMessage('å®ä½“JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(err => {
                    console.error('Clipboard APIå¤åˆ¶å¤±è´¥:', err);
                    // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                    fallbackCopyText(jsonStr);
                });
            } else {
                // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyText(jsonStr);
            }
        }
        
        // é™çº§å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('å®ä½“JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // è®¾å¤‡é€‰æ‹©ç›¸å…³åŠŸèƒ½
        function updateDeviceSelection() {
            const checkboxes = document.querySelectorAll('.device-checkbox');
            const selectedCount = document.querySelectorAll('.device-checkbox:checked').length;
            const deleteBtn = document.getElementById('deleteSelectedDevices');
            
            deleteBtn.disabled = selectedCount === 0;
            deleteBtn.textContent = selectedCount > 0 ? `åˆ é™¤é€‰ä¸­ (${selectedCount})` : 'åˆ é™¤é€‰ä¸­';
            
            // æ›´æ–°å…¨é€‰çŠ¶æ€
            const selectAll = document.getElementById('selectAllDevices');
            selectAll.checked = selectedCount === checkboxes.length && checkboxes.length > 0;
            selectAll.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
        }

        function toggleAllDevices() {
            const selectAll = document.getElementById('selectAllDevices');
            const checkboxes = document.querySelectorAll('.device-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateDeviceSelection();
        }

        // å…¨é€‰å½“å‰é¡µé¢çš„è®¾å¤‡ï¼ˆåªé€‰æ‹©å¯è§çš„è®¾å¤‡ï¼‰
        function selectAllCurrentPageDevices() {
            const selectAll = document.getElementById('selectAllDevices');
            const checkboxes = document.querySelectorAll('.device-checkbox');
            const visibleRows = document.querySelectorAll('#devicesTableBody tr:not([style*="display: none"])');
            
            // åªé€‰æ‹©å¯è§è¡Œçš„å¤é€‰æ¡†
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.device-checkbox');
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
            updateDeviceSelection();
        }

        // å…¨é€‰æ‰€æœ‰è®¾å¤‡ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰
        function selectAllDevices() {
            const selectAll = document.getElementById('selectAllDevices');
            const checkboxes = document.querySelectorAll('.device-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            
            updateDeviceSelection();
        }

        async function deleteSelectedDevices() {
            const selectedCheckboxes = document.querySelectorAll('.device-checkbox:checked');
            if (selectedCheckboxes.length === 0) return;
            
            const deviceIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${deviceIds.length} ä¸ªè®¾å¤‡å—ï¼Ÿ`)) return;
            
            try {
                const deletePromises = deviceIds.map(id => 
                    fetch(`/linknlinkedge/api/devices/${id}`, { method: 'DELETE' })
                );
                
                const results = await Promise.allSettled(deletePromises);
                const successCount = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
                const failCount = results.length - successCount;
                
                if (successCount > 0) {
                    showMessage(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªè®¾å¤‡`, 'success');
                    loadDevices();
                }
                if (failCount > 0) {
                    showMessage(`${failCount} ä¸ªè®¾å¤‡åˆ é™¤å¤±è´¥`, 'error');
                }
            } catch (err) {
                showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + err.message, 'error');
            }
        }

        // å®ä½“é€‰æ‹©ç›¸å…³åŠŸèƒ½
        function updateEntitySelection() {
            const checkboxes = document.querySelectorAll('.entity-checkbox');
            const selectedCount = document.querySelectorAll('.entity-checkbox:checked').length;
            const deleteBtn = document.getElementById('deleteSelectedEntities');
            
            deleteBtn.disabled = selectedCount === 0;
            deleteBtn.textContent = selectedCount > 0 ? `åˆ é™¤é€‰ä¸­ (${selectedCount})` : 'åˆ é™¤é€‰ä¸­';
            
            // æ›´æ–°å…¨é€‰çŠ¶æ€
            const selectAll = document.getElementById('selectAllEntities');
            selectAll.checked = selectedCount === checkboxes.length && checkboxes.length > 0;
            selectAll.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
        }

        function toggleAllEntities() {
            const selectAll = document.getElementById('selectAllEntities');
            const checkboxes = document.querySelectorAll('.entity-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateEntitySelection();
        }

        // å…¨é€‰å½“å‰é¡µé¢çš„å®ä½“ï¼ˆåªé€‰æ‹©å¯è§çš„å®ä½“ï¼‰
        function selectAllCurrentPageEntities() {
            const selectAll = document.getElementById('selectAllEntities');
            const visibleRows = document.querySelectorAll('#entitiesTableBody tr:not([style*="display: none"])');
            
            // åªé€‰æ‹©å¯è§è¡Œçš„å¤é€‰æ¡†
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.entity-checkbox');
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
            updateEntitySelection();
        }

        // å…¨é€‰æ‰€æœ‰å®ä½“ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰
        function selectAllEntities() {
            const selectAll = document.getElementById('selectAllEntities');
            const checkboxes = document.querySelectorAll('.entity-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            
            updateEntitySelection();
        }

        async function deleteSelectedEntities() {
            const selectedCheckboxes = document.querySelectorAll('.entity-checkbox:checked');
            if (selectedCheckboxes.length === 0) return;
            
            const entityIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${entityIds.length} ä¸ªå®ä½“å—ï¼Ÿ`)) return;
            
            try {
                const deletePromises = entityIds.map(id => 
                    fetch(`/linknlinkedge/api/entities/${id}`, { method: 'DELETE' })
                );
                
                const results = await Promise.allSettled(deletePromises);
                const successCount = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
                const failCount = results.length - successCount;
                
                if (successCount > 0) {
                    showMessage(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªå®ä½“`, 'success');
                    loadEntities();
                }
                if (failCount > 0) {
                    showMessage(`${failCount} ä¸ªå®ä½“åˆ é™¤å¤±è´¥`, 'error');
                }
            } catch (err) {
                showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + err.message, 'error');
            }
        }

        // æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
        function filterDevices() {
            const searchTerm = document.getElementById('deviceSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#devicesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function clearDeviceSearch() {
            document.getElementById('deviceSearch').value = '';
            const rows = document.querySelectorAll('#devicesTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }

        // æ›´æ–°ç­›é€‰ä¸‹æ‹‰æ¡†é€‰é¡¹ï¼ˆä»å®ä½“æ•°æ®ä¸­åŠ¨æ€ç”Ÿæˆï¼‰
        function updateFilterOptions() {
            const domainFilter = document.getElementById('domainFilter');
            const deviceClassFilter = document.getElementById('deviceClassFilter');
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„ domain å’Œ device_class
            const domains = new Set();
            const deviceClasses = new Set();
            
            entities.forEach(entity => {
                if (entity.domain) {
                    domains.add(entity.domain);
                }
                if (entity.device_class) {
                    deviceClasses.add(entity.device_class);
                }
            });
            
            // æ¸…ç©ºå¹¶å¡«å…… domain é€‰é¡¹
            domainFilter.innerHTML = '<option value="">æ‰€æœ‰ domain</option>';
            Array.from(domains).sort().forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainFilter.appendChild(option);
            });
            
            // æ¸…ç©ºå¹¶å¡«å…… device_class é€‰é¡¹
            deviceClassFilter.innerHTML = '<option value="">æ‰€æœ‰ device_class</option>';
            Array.from(deviceClasses).sort().forEach(deviceClass => {
                const option = document.createElement('option');
                option.value = deviceClass;
                option.textContent = deviceClass;
                deviceClassFilter.appendChild(option);
            });
        }

        function filterEntities() {
            const searchTerm = document.getElementById('entitySearch').value.toLowerCase();
            const domainFilter = document.getElementById('domainFilter').value;
            const deviceClassFilter = document.getElementById('deviceClassFilter').value;
            const rows = document.querySelectorAll('#entitiesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const domainCell = row.cells[3]; // domainåˆ—
                const deviceClassCell = row.cells[4]; // device_classåˆ—
                
                // ä» data å±æ€§è·å–åŸå§‹å€¼ï¼ˆè‹±æ–‡ï¼‰
                const domain = domainCell ? (domainCell.getAttribute('data-domain') || domainCell.textContent.trim()) : '';
                const deviceClass = deviceClassCell ? (deviceClassCell.getAttribute('data-device-class') || deviceClassCell.textContent.trim()) : '';
                
                const matchesSearch = text.includes(searchTerm);
                const matchesDomain = !domainFilter || domain.toLowerCase() === domainFilter.toLowerCase();
                const matchesDeviceClass = !deviceClassFilter || deviceClass.toLowerCase() === deviceClassFilter.toLowerCase();
                
                row.style.display = (matchesSearch && matchesDomain && matchesDeviceClass) ? '' : 'none';
            });
        }

        function clearEntitySearch() {
            document.getElementById('entitySearch').value = '';
            document.getElementById('domainFilter').value = '';
            document.getElementById('deviceClassFilter').value = '';
            const rows = document.querySelectorAll('#entitiesTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }

        // è®¾ç½®çŠ¶æ€
        function setState(entityId) {
            const newState = prompt(`è®¾ç½®å®ä½“ ${entityId} çš„çŠ¶æ€:`, '');
            if (newState !== null) {
                // TODO: å®ç°çŠ¶æ€è®¾ç½®
                showMessage('çŠ¶æ€è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'error');
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡è¯¦æƒ…
        async function showDeviceDetail(deviceId) {
            try {
                const response = await fetch(`/linknlinkedge/api/devices/${deviceId}`);
                if (!response.ok) {
                    throw new Error('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥');
                }
                
                const deviceData = await response.json();
                const device = deviceData;
                
                // ä½¿ç”¨APIè¿”å›çš„å®ä½“æ•°æ®ï¼Œè€Œä¸æ˜¯å…¨å±€entitieså˜é‡
                const deviceEntities = device.entities || [];
                
                // ç”Ÿæˆå‹ç¼©çš„è®¾å¤‡ä¿¡æ¯HTML
                let deviceInfoHtml = `
                    <div class="device-detail-section">
                        <h4>ğŸ“± è®¾å¤‡ä¿¡æ¯</h4>
                        <div class="device-info-compact">
                            <div class="device-header">
                                <h3>${device.name || 'æœªå‘½åè®¾å¤‡'}</h3>
                                <div class="device-status">
                                    <span class="status-badge ${device.status === 'online' ? 'online' : 'offline'}">${device.status || 'æœªçŸ¥'}</span>
                                    <span class="source-badge ${device.source || 'mqtt'}">${device.source || 'MQTT'}</span>
                                </div>
                            </div>
                            <div class="device-details">
                                <div class="detail-row">
                                    <span class="detail-label">ID:</span>
                                    <span class="detail-value">${device.id}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">æ ‡è¯†ç¬¦:</span>
                                    <span class="detail-value">${device.device_id}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">åˆ¶é€ å•†:</span>
                                    <span class="detail-value">${device.manufacturer || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">å‹å·:</span>
                                    <span class="detail-value">${device.model || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">ç±»å‹:</span>
                                    <span class="detail-value">${device.device_class || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">æœ€åæ´»è·ƒ:</span>
                                    <span class="detail-value">${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'ä»æœª'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç”Ÿæˆå…³è”å®ä½“HTML
                let entitiesHtml = `
                    <div class="device-detail-section">
                        <h4>ğŸ”— å…³è”å®ä½“ (${deviceEntities.length}ä¸ª)</h4>
                `;
                
                if (deviceEntities.length === 0) {
                    entitiesHtml += '<p class="no-entities">è¯¥è®¾å¤‡æš‚æ— å…³è”å®ä½“</p>';
                } else {
                    entitiesHtml += '<div class="entities-list">';
                    deviceEntities.forEach(entity => {
                        const statusClass = entity.available ? 'online' : 'offline';
                        const statusText = entity.available ? 'åœ¨çº¿' : 'ç¦»çº¿';
                        
                        entitiesHtml += `
                            <div class="entity-item">
                                <div class="entity-header">
                                    <h5>${getEntityIcon(entity.domain)} ${entity.name || entity.entity_id}</h5>
                                    <span class="entity-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="entity-details">
                                    <div class="entity-info">
                                        <span class="entity-id">ID: ${entity.entity_id}</span>
                                        <span class="entity-domain">ç±»å‹: ${entity.domain}</span>
                                        <span class="entity-class">åˆ†ç±»: ${entity.device_class || 'æ— '}</span>
                                    </div>
                                    <div class="entity-actions">
                                        <button class="btn btn-sm btn-info" onclick="showEntityDetail('${entity.entity_id}')">è¯¦æƒ…</button>
                                        <button class="btn btn-sm btn-success" onclick="controlEntity('${entity.entity_id}')">æ§åˆ¶</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    entitiesHtml += '</div>';
                }
                
                entitiesHtml += '</div>';
                
                // ç»„åˆå®Œæ•´å†…å®¹
                const fullContent = deviceInfoHtml + entitiesHtml;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('deviceDetailContent').innerHTML = fullContent;
                document.getElementById('deviceDetailModal').style.display = 'block';
                
            } catch (error) {
                console.error('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥:', error);
                showMessage('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // è·å–å®ä½“å›¾æ ‡
        function getEntityIcon(domain) {
            const icons = {
                'light': 'ğŸ’¡',
                'switch': 'ğŸ”Œ',
                'climate': 'â„ï¸',
                'fan': 'ğŸŒ€',
                'cover': 'ğŸªŸ',
                'lock': 'ğŸ”’',
                'media_player': 'ğŸµ',
                'button': 'ğŸ”˜',
                'sensor': 'ğŸ“Š',
                'binary_sensor': 'ğŸ“¡',
                'camera': 'ğŸ“¹',
                'alarm_control_panel': 'ğŸš¨',
                'vacuum': 'ğŸ¤–',
                'water_heater': 'ğŸ”¥',
                'humidifier': 'ğŸ’§',
                'dehumidifier': 'ğŸŒ¬ï¸'
            };
            return icons[domain] || 'ğŸ”§';
        }

        // åˆ¤æ–­å®ä½“æ˜¯å¦æ”¯æŒæ§åˆ¶
        function isEntityControlSupported(domain) {
            const controllableDomains = [
                'light', 'switch', 'climate', 'fan', 'cover', 'lock', 
                'media_player', 'button', 'vacuum', 'water_heater', 
                'humidifier', 'dehumidifier', 'alarm_control_panel'
            ];
            
            return controllableDomains.includes(domain);
        }

        // æ§åˆ¶è®¾å¤‡
        function controlDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                showDeviceControlModal(device);
            }
        }

        // æ§åˆ¶å®ä½“
        function controlEntity(entityId) {
            const entity = entities.find(e => e.entity_id === entityId);
            if (entity) {
                showEntityControlModal(entity);
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡æ§åˆ¶æ¨¡æ€æ¡†
        function showDeviceControlModal(device) {
            console.log('ğŸ” è®¾å¤‡æ§åˆ¶è°ƒè¯•ä¿¡æ¯:');
            console.log('è®¾å¤‡ID (æ•°æ®åº“ä¸»é”®):', device.id);
            console.log('è®¾å¤‡ID (è®¾å¤‡æ ‡è¯†ç¬¦):', device.device_id);
            console.log('æ‰€æœ‰å®ä½“:', entities);
            
            // è·å–è®¾å¤‡ç›¸å…³çš„å®ä½“
            const deviceEntities = entities.filter(entity => 
                entity.device_id === device.device_id
            );
            
            console.log('è®¾å¤‡ç›¸å…³å®ä½“:', deviceEntities);

            // åˆ›å»ºæ§åˆ¶æŒ‰é’®HTML
            let controlButtons = '';
            deviceEntities.forEach(entity => {
                const domain = entity.domain;
                const entityId = entity.entity_id;
                const isSupported = isEntityControlSupported(domain);
                const groupClass = isSupported ? 'control-group' : 'control-group disabled';
                const titleClass = isSupported ? '' : 'disabled-title';
                
                if (!isSupported) {
                    // ä¸æ”¯æŒæ§åˆ¶çš„å®ä½“ï¼Œæ˜¾ç¤ºç½®ç°çŠ¶æ€
                    controlButtons += `
                        <div class="${groupClass}">
                            <h4 class="${titleClass}">${getEntityIcon(domain)} ${entity.name || entityId}</h4>
                            <div class="control-buttons disabled">
                                <span class="disabled-text">è¯¥å®ä½“ç±»å‹ä¸æ”¯æŒæ§åˆ¶</span>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                switch(domain) {
                    case 'light':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸ’¡ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-success" onclick="callRestfulService('light', 'turn_on', '${entityId}')">å¼€å¯</button>
                                    <button class="btn btn-danger" onclick="callRestfulService('light', 'turn_off', '${entityId}')">å…³é—­</button>
                                    <button class="btn" onclick="callRestfulService('light', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                                </div>
                            </div>
                        `;
                        break;
                    case 'switch':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸ”Œ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-success" onclick="callRestfulService('switch', 'turn_on', '${entityId}')">å¼€å¯</button>
                                    <button class="btn btn-danger" onclick="callRestfulService('switch', 'turn_off', '${entityId}')">å…³é—­</button>
                                    <button class="btn" onclick="callRestfulService('switch', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                                </div>
                            </div>
                        `;
                        break;
                    case 'climate':
                        controlButtons += `
                            <div class="control-group">
                                <h4>â„ï¸ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn" onclick="callRestfulService('climate', 'set_hvac_mode', '${entityId}', {hvac_mode: 'heat'})">åˆ¶çƒ­</button>
                                    <button class="btn" onclick="callRestfulService('climate', 'set_hvac_mode', '${entityId}', {hvac_mode: 'cool'})">åˆ¶å†·</button>
                                    <button class="btn" onclick="callRestfulService('climate', 'set_hvac_mode', '${entityId}', {hvac_mode: 'off'})">å…³é—­</button>
                                    <button class="btn" onclick="callRestfulService('climate', 'set_temperature', '${entityId}', {temperature: 22})">22Â°C</button>
                                </div>
                            </div>
                        `;
                        break;
                    case 'fan':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸŒ€ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-success" onclick="callRestfulService('fan', 'turn_on', '${entityId}')">å¼€å¯</button>
                                    <button class="btn btn-danger" onclick="callRestfulService('fan', 'turn_off', '${entityId}')">å…³é—­</button>
                                    <button class="btn" onclick="callRestfulService('fan', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                                </div>
                            </div>
                        `;
                        break;
                    case 'cover':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸªŸ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-success" onclick="callRestfulService('cover', 'open_cover', '${entityId}')">æ‰“å¼€</button>
                                    <button class="btn btn-danger" onclick="callRestfulService('cover', 'close_cover', '${entityId}')">å…³é—­</button>
                                    <button class="btn" onclick="callRestfulService('cover', 'stop_cover', '${entityId}')">åœæ­¢</button>
                                </div>
                            </div>
                        `;
                        break;
                    case 'lock':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸ”’ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-success" onclick="callRestfulService('lock', 'unlock', '${entityId}')">è§£é”</button>
                                    <button class="btn btn-danger" onclick="callRestfulService('lock', 'lock', '${entityId}')">é”å®š</button>
                                </div>
                            </div>
                        `;
                        break;
                    case 'media_player':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸµ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-success" onclick="callRestfulService('media_player', 'turn_on', '${entityId}')">å¼€å¯</button>
                                    <button class="btn btn-danger" onclick="callRestfulService('media_player', 'turn_off', '${entityId}')">å…³é—­</button>
                                    <button class="btn" onclick="callRestfulService('media_player', 'media_play_pause', '${entityId}')">æ’­æ”¾/æš‚åœ</button>
                                </div>
                            </div>
                        `;
                        break;
                    case 'button':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸ”˜ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-primary" onclick="callRestfulService('button', 'press', '${entityId}')">æŒ‰ä¸‹</button>
                                </div>
                                <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                                    æŒ‰é’®ç±»å‹æ²¡æœ‰çŠ¶æ€ï¼Œåªæœ‰æŒ‰ä¸‹åŠ¨ä½œ
                                </p>
                            </div>
                        `;
                        break;
                    case 'number':
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸ”¢ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn btn-info" onclick="showNumberValueControl('${entityId}')">è®¾ç½®æ•°å€¼</button>
                                </div>
                            </div>
                        `;
                        break;
                    default:
                        controlButtons += `
                            <div class="control-group">
                                <h4>ğŸ”§ ${entity.name || entityId}</h4>
                                <div class="control-buttons">
                                    <button class="btn" onclick="callRestfulService('${domain}', 'turn_on', '${entityId}')">å¼€å¯</button>
                                    <button class="btn" onclick="callRestfulService('${domain}', 'turn_off', '${entityId}')">å…³é—­</button>
                                    <button class="btn" onclick="callRestfulService('${domain}', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                                </div>
                            </div>
                        `;
                }
            });

            if (!controlButtons) {
                controlButtons = '<p>è¯¥è®¾å¤‡æ²¡æœ‰å¯æ§åˆ¶çš„å®ä½“</p>';
            }

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>æ§åˆ¶è®¾å¤‡: ${device.name}</h3>
                        <span class="close" onclick="closeControlModal(this)">&times;</span>
                    </div>
                    <div class="modal-body">
                        ${controlButtons}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // æ˜¾ç¤ºå®ä½“æ§åˆ¶æ¨¡æ€æ¡†
        function showEntityControlModal(entity) {
            const domain = entity.domain;
            const entityId = entity.entity_id;
            const entityName = entity.name || entityId;
            
            // æ ¹æ®å®ä½“ç±»å‹åˆ›å»ºæ§åˆ¶æŒ‰é’®
            let controlButtons = '';
            
            switch(domain) {
                case 'light':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ’¡ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="callRestfulService('light', 'turn_on', '${entityId}')">å¼€å¯</button>
                                <button class="btn btn-danger" onclick="callRestfulService('light', 'turn_off', '${entityId}')">å…³é—­</button>
                                <button class="btn" onclick="callRestfulService('light', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                                <button class="btn btn-info" onclick="showLightAdvancedControl('${entityId}')">é«˜çº§æ§åˆ¶</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'switch':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ”Œ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="callRestfulService('switch', 'turn_on', '${entityId}')">å¼€å¯</button>
                                <button class="btn btn-danger" onclick="callRestfulService('switch', 'turn_off', '${entityId}')">å…³é—­</button>
                                <button class="btn" onclick="callRestfulService('switch', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'climate':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸŒ¡ï¸ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn" onclick="callRestfulService('climate', 'set_hvac_mode', '${entityId}', {hvac_mode: 'heat'})">åˆ¶çƒ­</button>
                                <button class="btn" onclick="callRestfulService('climate', 'set_hvac_mode', '${entityId}', {hvac_mode: 'cool'})">åˆ¶å†·</button>
                                <button class="btn" onclick="callRestfulService('climate', 'set_hvac_mode', '${entityId}', {hvac_mode: 'off'})">å…³é—­</button>
                                <button class="btn" onclick="callRestfulService('climate', 'set_temperature', '${entityId}', {temperature: 22})">22Â°C</button>
                                <button class="btn" onclick="callRestfulService('climate', 'set_temperature', '${entityId}', {temperature: 25})">25Â°C</button>
                                <button class="btn btn-info" onclick="showClimateAdvancedControl('${entityId}')">é«˜çº§æ§åˆ¶</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'fan':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸŒ€ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="callRestfulService('fan', 'turn_on', '${entityId}')">å¼€å¯</button>
                                <button class="btn btn-danger" onclick="callRestfulService('fan', 'turn_off', '${entityId}')">å…³é—­</button>
                                <button class="btn" onclick="callRestfulService('fan', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                                <button class="btn" onclick="callRestfulService('fan', 'set_speed', '${entityId}', {speed: 'low'})">ä½é€Ÿ</button>
                                <button class="btn" onclick="callRestfulService('fan', 'set_speed', '${entityId}', {speed: 'high'})">é«˜é€Ÿ</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'cover':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸªŸ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="callRestfulService('cover', 'open_cover', '${entityId}')">æ‰“å¼€</button>
                                <button class="btn btn-danger" onclick="callRestfulService('cover', 'close_cover', '${entityId}')">å…³é—­</button>
                                <button class="btn" onclick="callRestfulService('cover', 'stop_cover', '${entityId}')">åœæ­¢</button>
                                <button class="btn" onclick="callRestfulService('cover', 'set_cover_position', '${entityId}', {position: 50})">50%</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'lock':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ”’ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="callRestfulService('lock', 'unlock', '${entityId}')">è§£é”</button>
                                <button class="btn btn-danger" onclick="callRestfulService('lock', 'lock', '${entityId}')">é”å®š</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'media_player':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸµ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="callRestfulService('media_player', 'turn_on', '${entityId}')">å¼€å¯</button>
                                <button class="btn btn-danger" onclick="callRestfulService('media_player', 'turn_off', '${entityId}')">å…³é—­</button>
                                <button class="btn" onclick="callRestfulService('media_player', 'media_play_pause', '${entityId}')">æ’­æ”¾/æš‚åœ</button>
                                <button class="btn" onclick="callRestfulService('media_player', 'volume_up', '${entityId}')">éŸ³é‡+</button>
                                <button class="btn" onclick="callRestfulService('media_player', 'volume_down', '${entityId}')">éŸ³é‡-</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'button':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ”˜ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-primary" onclick="callRestfulService('button', 'press', '${entityId}')">æŒ‰ä¸‹</button>
                            </div>
                            <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                                æŒ‰é’®ç±»å‹æ²¡æœ‰çŠ¶æ€ï¼Œåªæœ‰æŒ‰ä¸‹åŠ¨ä½œ
                            </p>
                        </div>
                    `;
                    break;
                case 'sensor':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ“Š ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-info" onclick="showSensorStateControl('${entityId}')">è®¾ç½®çŠ¶æ€</button>
                                <button class="btn" onclick="refreshEntityState('${entityId}')">åˆ·æ–°çŠ¶æ€</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'binary_sensor':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ”˜ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-info" onclick="showBinarySensorStateControl('${entityId}')">è®¾ç½®çŠ¶æ€</button>
                                <button class="btn" onclick="refreshEntityState('${entityId}')">åˆ·æ–°çŠ¶æ€</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'number':
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ”¢ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn btn-info" onclick="showNumberValueControl('${entityId}')">è®¾ç½®æ•°å€¼</button>
                                <button class="btn" onclick="refreshEntityState('${entityId}')">åˆ·æ–°çŠ¶æ€</button>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    controlButtons = `
                        <div class="control-group">
                            <h4>ğŸ”§ ${entityName}</h4>
                            <div class="control-buttons">
                                <button class="btn" onclick="callRestfulService('${domain}', 'turn_on', '${entityId}')">å¼€å¯</button>
                                <button class="btn" onclick="callRestfulService('${domain}', 'turn_off', '${entityId}')">å…³é—­</button>
                                <button class="btn" onclick="callRestfulService('${domain}', 'toggle', '${entityId}')">åˆ‡æ¢</button>
                                <button class="btn btn-info" onclick="showGenericEntityControl('${entityId}', '${domain}')">è‡ªå®šä¹‰æ§åˆ¶</button>
                            </div>
                        </div>
                    `;
            }

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>æ§åˆ¶å®ä½“: ${entityName}</h3>
                        <span class="close" onclick="closeControlModal(this)">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="entity-info">
                            <h4>å®ä½“ä¿¡æ¯</h4>
                            <p><strong>å®ä½“ID:</strong> ${entityId}</p>
                            <p><strong>åŸŸ:</strong> ${domain}</p>
                            <p><strong>ç±»å‹:</strong> ${entity.device_class || 'æœªçŸ¥'}</p>
                        </div>
                        ${controlButtons}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // è°ƒç”¨åŒ—å‘RESTfulæœåŠ¡
        async function callRestfulService(domain, service, entityId, serviceData = {}) {
            // æ„å»ºåŒ—å‘APIè¯·æ±‚æ•°æ®ï¼Œæ ¼å¼ç±»ä¼¼Home Assistant
            const data = {
                entity_id: entityId,
                ...serviceData
            };

            try {
                // è°ƒç”¨åŒ—å‘HTTPæ¥å£ï¼Œæ ¼å¼: /linknlinkedge/api/services/<domain>/<service>
                const response = await fetch(`/linknlinkedge/api/services/${domain}/${service}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer TOKEN', // åŒ—å‘æ¥å£éœ€è¦è®¤è¯
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(`æ§åˆ¶æˆåŠŸ: ${domain}.${service}`, 'success');
                    console.log('åŒ—å‘APIæ§åˆ¶ç»“æœ:', result);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'æ§åˆ¶å¤±è´¥');
                }
            } catch (err) {
                showMessage(`æ§åˆ¶å¤±è´¥: ${err.message}`, 'error');
                console.error('åŒ—å‘APIæ§åˆ¶é”™è¯¯:', err);
            }
        }

        // å…³é—­æ§åˆ¶æ¨¡æ€æ¡†
        function closeControlModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // æ˜¾ç¤ºç¯å…‰é«˜çº§æ§åˆ¶
        function showLightAdvancedControl(entityId) {
            const brightness = prompt('è®¾ç½®äº®åº¦ (0-255):', '255');
            if (brightness !== null) {
                const color = prompt('è®¾ç½®é¢œè‰² (å¦‚: red, blue, #FF0000):', '');
                const serviceData = { brightness: parseInt(brightness) };
                if (color) {
                    serviceData.color_name = color;
                }
                callRestfulService('light', 'turn_on', entityId, serviceData);
            }
        }

        // æ˜¾ç¤ºç©ºè°ƒé«˜çº§æ§åˆ¶
        function showClimateAdvancedControl(entityId) {
            const temperature = prompt('è®¾ç½®æ¸©åº¦:', '22');
            const hvacMode = prompt('è®¾ç½®æ¨¡å¼ (off, heat, cool, heat_cool, auto, dry, fan_only):', 'auto');
            if (temperature !== null && hvacMode !== null) {
                callRestfulService('climate', 'set_temperature', entityId, {
                    temperature: parseFloat(temperature),
                    hvac_mode: hvacMode
                });
            }
        }

        // æ˜¾ç¤ºä¼ æ„Ÿå™¨çŠ¶æ€æ§åˆ¶
        function showSensorStateControl(entityId) {
            const state = prompt('è®¾ç½®ä¼ æ„Ÿå™¨çŠ¶æ€å€¼:', '');
            if (state !== null && state !== '') {
                callRestfulService('sensor', 'set_state', entityId, { state: state });
            }
        }

        // æ˜¾ç¤ºäºŒè¿›åˆ¶ä¼ æ„Ÿå™¨çŠ¶æ€æ§åˆ¶
        function showBinarySensorStateControl(entityId) {
            const state = prompt('è®¾ç½®äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨çŠ¶æ€ (on/off):', 'off');
            if (state !== null && (state === 'on' || state === 'off')) {
                callRestfulService('binary_sensor', 'set_state', entityId, { state: state });
            }
        }

        // æ˜¾ç¤ºæ•°å€¼å®ä½“æ§åˆ¶
        function showNumberValueControl(entityId) {
            const value = prompt('è®¾ç½®æ•°å€¼:', '');
            if (value !== null && value !== '') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    callRestfulService('number', 'set_value', entityId, { value: numValue });
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
                }
            }
        }

        // æ˜¾ç¤ºé€šç”¨å®ä½“æ§åˆ¶
        function showGenericEntityControl(entityId, domain) {
            const service = prompt(`è¾“å…¥æœåŠ¡åç§° (å¦‚: turn_on, turn_off, set_state):`, 'set_state');
            const state = prompt('è¾“å…¥çŠ¶æ€å€¼:', '');
            if (service !== null && state !== null) {
                callRestfulService(domain, service, entityId, { state: state });
            }
        }

        // åˆ·æ–°å®ä½“çŠ¶æ€
        async function refreshEntityState(entityId) {
            try {
                const response = await fetch(`/linknlinkedge/api/states/${entityId}`);
                if (response.ok) {
                    const state = await response.json();
                    showMessage(`å®ä½“ ${entityId} çŠ¶æ€: ${state.state}`, 'success');
                    // åˆ·æ–°å®ä½“åˆ—è¡¨
                    loadEntities();
                } else {
                    throw new Error('è·å–çŠ¶æ€å¤±è´¥');
                }
            } catch (err) {
                showMessage(`åˆ·æ–°çŠ¶æ€å¤±è´¥: ${err.message}`, 'error');
            }
        }

        // WebSocketè¿æ¥åŠŸèƒ½
        function connectWebSocket() {
            if (wsConnected) {
                console.log('WebSocketå·²è¿æ¥');
                return;
            }

            const wsUrl = `ws://${window.location.hostname}:${window.location.port}/linknlinkedge/api/websocket`;
            wsClient = new WebSocket(wsUrl);

            wsClient.onopen = function() {
                wsConnected = true;
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                
                // å‘é€è®¤è¯æ¶ˆæ¯
                const authMessage = {
                    type: "auth",
                    access_token: "test_token",
                    id: getNextMessageId()
                };
                wsClient.send(JSON.stringify(authMessage));
            };

            wsClient.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (e) {
                    console.log('æ”¶åˆ°éJSONæ¶ˆæ¯:', event.data);
                }
            };

            wsClient.onclose = function() {
                wsConnected = false;
                console.log('WebSocketè¿æ¥å·²æ–­å¼€');
            };

            wsClient.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }

        // æ–­å¼€WebSocketè¿æ¥
        function disconnectWebSocket() {
            if (wsClient) {
                wsClient.close();
                wsClient = null;
                wsConnected = false;
            }
        }

        // è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ID
        function getNextMessageId() {
            return messageIdCounter++;
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥è‡ªåŠ¨åˆ·æ–°ï¼ˆç”¨æˆ·æ˜¯å¦æ­£åœ¨æ“ä½œï¼‰
        function canAutoRefresh() {
            // å¦‚æœè‡ªåŠ¨åˆ·æ–°è¢«ç¦ç”¨ï¼Œè¿”å›false
            if (!autoRefreshEnabled) {
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡æ€æ¡†æ‰“å¼€
            const openModals = document.querySelectorAll('.modal[style*="display: block"]');
            if (openModals.length > 0) {
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¾“å…¥æ¡†èšç„¦
            const activeElement = document.activeElement;
            if (activeElement && (
                activeElement.tagName === 'INPUT' || 
                activeElement.tagName === 'TEXTAREA' || 
                activeElement.tagName === 'SELECT' ||
                activeElement.isContentEditable
            )) {
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æ¸²æŸ“
            if (isRenderingEntities) {
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æœ€å°åˆ·æ–°é—´éš”å†…
            const now = Date.now();
            if (now - lastRefreshTime < MIN_REFRESH_INTERVAL) {
                return false;
            }
            
            return true;
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(message) {
            console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', message);
            
            // å¦‚æœæ˜¯å›å¤æ¶ˆæ¯ï¼Œä¿æŒå¯¹ç«¯çš„ID
            if (message.id) {
                // è¿™é‡Œå¯ä»¥å¤„ç†å›å¤æ¶ˆæ¯çš„é€»è¾‘
                console.log('æ”¶åˆ°å›å¤æ¶ˆæ¯ï¼ŒID:', message.id);
            }
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
            if (message.type === 'event') {
                if (message.event && message.event.event_type === 'state_changed') {
                    // å‡†å¤‡ç¼“å­˜æ•°æ®ï¼ŒåŒ…å«time_fired
                    const cacheData = {
                        ...message.event.data,
                        time_fired: message.event.time_fired
                    };
                    
                    // ç¼“å­˜state_changedæ¶ˆæ¯ï¼ˆä¸ç«‹å³åˆ·æ–°ï¼Œç”±å®šæ—¶å™¨è´Ÿè´£æ¸²æŸ“ï¼‰
                    addToStateCache(cacheData);
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥è‡ªåŠ¨åˆ·æ–°ï¼ˆå…¶ä»–æ ‡ç­¾é¡µçš„é€»è¾‘ï¼‰
                    if (!canAutoRefresh()) {
                        console.log('è·³è¿‡è‡ªåŠ¨åˆ·æ–°ï¼šç”¨æˆ·æ­£åœ¨æ“ä½œæˆ–åˆ·æ–°é—´éš”å¤ªçŸ­');
                        return;
                    }
                    
                    // çŠ¶æ€å˜æ›´ï¼Œä½¿ç”¨é˜²æŠ–æœºåˆ¶åˆ·æ–°å½“å‰æ ‡ç­¾é¡µæ•°æ®
                    if (refreshDebounceTimer) {
                        clearTimeout(refreshDebounceTimer);
                    }
                    
                    refreshDebounceTimer = setTimeout(() => {
                        // å†æ¬¡æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ·æ–°ï¼ˆå¯èƒ½åœ¨é˜²æŠ–æœŸé—´ç”¨æˆ·å¼€å§‹æ“ä½œï¼‰
                        if (!canAutoRefresh()) {
                            console.log('è·³è¿‡è‡ªåŠ¨åˆ·æ–°ï¼šé˜²æŠ–æœŸé—´ç”¨æˆ·å¼€å§‹æ“ä½œ');
                            refreshDebounceTimer = null;
                            return;
                        }
                        
                        lastRefreshTime = Date.now();
                        
                        switch(currentTab) {
                            case 'devices':
                                // å¯¹äºè®¾å¤‡é¡µé¢ï¼Œä¹Ÿä½¿ç”¨å¢é‡æ›´æ–°ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                                loadDevices();
                                break;
                            case 'entities':
                                // å¦‚æœå®ä½“è¡¨æ ¼æ­£åœ¨æ¸²æŸ“ï¼Œè·³è¿‡åˆ·æ–°
                                if (!isRenderingEntities) {
                                    updateEntityStateIncremental(message.event.data);
                                }
                                break;
                            case 'states':
                                // çŠ¶æ€é¡µé¢ç”±å®šæ—¶å™¨è´Ÿè´£æ¸²æŸ“ï¼Œè¿™é‡Œä¸åšå¤„ç†
                                break;
                        }
                        refreshDebounceTimer = null;
                    }, 2000); // å¢åŠ åˆ°2ç§’é˜²æŠ–ï¼Œå‡å°‘åˆ·æ–°é¢‘ç‡
                }
            }
        }
        
        // å¢é‡æ›´æ–°å•ä¸ªå®ä½“çŠ¶æ€ï¼ˆé¿å…é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼ï¼‰
        async function updateEntityStateIncremental(eventData) {
            if (!eventData || !eventData.entity_id) return;
            
            const entityId = eventData.entity_id;
            const row = document.querySelector(`tr[data-entity-id="${entityId}"]`);
            
            if (!row) {
                // å¦‚æœè¡Œä¸å­˜åœ¨ï¼Œä¸ç«‹å³é‡æ–°åŠ è½½ï¼Œé¿å…æ‰“æ–­ç”¨æˆ·æ“ä½œ
                // åªåœ¨ç”¨æˆ·åˆ‡æ¢åˆ°å®ä½“æ ‡ç­¾é¡µæ—¶å†åŠ è½½
                console.log(`å®ä½“ ${entityId} çš„è¡Œä¸å­˜åœ¨ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°`);
                return;
            }
            
            try {
                // è·å–æœ€æ–°çŠ¶æ€
                const state = await getEntityState(entityId);
                if (!state) return;
                
                const entity = entities.find(e => e.entity_id === entityId);
                if (!entity) return;
                
                const currentState = state.state;
                const attributes = state.attributes || {};
                const lastUpdated = state.last_updated;
                
                // æ ¹æ®çŠ¶æ€ç¡®å®šæ˜¾ç¤ºæ–‡æœ¬å’ŒCSSç±»
                let statusText = currentState;
                let statusClass = '';
                
                if (entity.domain === 'button') {
                    statusText = 'æ— çŠ¶æ€';
                    statusClass = 'no-state';
                } else if (entity.domain === 'light') {
                    if (currentState === 'on') {
                        statusText = 'å¼€å¯';
                        statusClass = 'online';
                    } else if (currentState === 'off') {
                        statusText = 'å…³é—­';
                        statusClass = 'offline';
                    } else {
                        statusText = currentState === 'unknown' ? 'æœªçŸ¥' : currentState;
                        statusClass = 'unknown';
                    }
                } else if (entity.domain === 'climate') {
                    statusText = currentState === 'unknown' ? 'æœªçŸ¥' : currentState;
                    statusClass = currentState === 'unknown' ? 'unknown' : 'online';
                } else if (currentState === 'unavailable') {
                    statusText = 'ä¸å¯ç”¨';
                    statusClass = 'unavailable';
                } else if (currentState === 'unknown') {
                    statusText = 'æœªçŸ¥';
                    statusClass = 'unknown';
                } else {
                    statusClass = 'online';
                }
                
                // æ›´æ–°çŠ¶æ€åˆ—
                const statusCell = row.cells[5];
                if (statusCell) {
                    statusCell.innerHTML = `<span class="status ${statusClass}">${statusText}</span>`;
                }
                
                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´ï¼ˆç´¢å¼•æ”¹ä¸º7ï¼Œå› ä¸ºåˆ é™¤äº†å±æ€§åˆ—ï¼‰
                const lastUpdatedCell = row.cells[7];
                if (lastUpdatedCell) {
                    try {
                        lastUpdatedCell.textContent = new Date(lastUpdated).toLocaleString();
                    } catch (e) {
                        lastUpdatedCell.textContent = '-';
                    }
                }
            } catch (error) {
                console.error(`æ›´æ–°å®ä½“ ${entityId} çŠ¶æ€å¤±è´¥:`, error);
            }
        }

        // å‘é€WebSocketæ¶ˆæ¯
        function sendWebSocketMessage(message) {
            if (!wsConnected) {
                console.error('WebSocketæœªè¿æ¥');
                return;
            }

            // ä¸ºå‘é€çš„æ¶ˆæ¯åˆ†é…ID
            message.id = getNextMessageId();
            wsClient.send(JSON.stringify(message));
            console.log('å‘é€WebSocketæ¶ˆæ¯:', message);
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllData() {
            const refreshBtn = document.querySelector('button[onclick="refreshAllData()"]');
            const originalText = refreshBtn.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';
            refreshBtn.disabled = true;
            
            // æ›´æ–°åˆ·æ–°æ—¶é—´ï¼ˆæ‰‹åŠ¨åˆ·æ–°ä¸å—é™åˆ¶ï¼‰
            lastRefreshTime = Date.now();
            
            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                await Promise.all([
                    loadDevices(),
                    loadEntities(),
                    loadStates()
                ]);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                refreshBtn.innerHTML = 'âœ… åˆ·æ–°å®Œæˆ';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                refreshBtn.innerHTML = 'âŒ åˆ·æ–°å¤±è´¥';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç¼“å­˜ä¿¡æ¯æ˜¾ç¤º
            updateCacheInfo();
            
            // æ ¹æ®å½“å‰é€‰é¡¹å¡åŠ è½½å¯¹åº”æ•°æ®
            if (currentTab === 'entities') {
                loadEntities();
            } else if (currentTab === 'states') {
                loadStates();
                startStatesRenderTimer(); // å¯åŠ¨çŠ¶æ€è¡¨æ ¼å®šæ—¶æ¸²æŸ“
            } else {
                loadDevices();
            }
            
            // è‡ªåŠ¨è¿æ¥WebSocket
            connectWebSocket();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
