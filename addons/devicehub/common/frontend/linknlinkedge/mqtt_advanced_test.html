<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTæµ‹è¯•å·¥å…· & RESTful APIæ§åˆ¶ - LinkNLink Edge</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .nav {
            display: flex;
            gap: 1rem;
        }

        .nav a {
            text-decoration: none;
            color: #7f8c8d;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav a:hover, .nav a.active {
            background: #3498db;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            color: #2c3e50;
        }

        .card-body {
            padding: 1.5rem;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
            font-family: monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .device-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .device-status-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }

        .btn-online, .btn-offline {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-online {
            background-color: #27ae60;
            color: white;
        }

        .btn-online:hover {
            background-color: #229954;
        }

        .btn-offline {
            background-color: #e74c3c;
            color: white;
        }

        .btn-offline:hover {
            background-color: #c0392b;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* æ–°çš„è®¾å¤‡æµ‹è¯•ç•Œé¢æ ·å¼ */
        .device-test-header {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #3498db;
        }

        .device-test-header h4 {
            margin: 0 0 0.5rem 0;
            color: #2c3e50;
        }

        .device-test-header p {
            margin: 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .device-actions-section,
        .device-control-section,
        .device-status-section {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #ecf0f1;
        }

        .device-actions-section h5,
        .device-control-section h5,
        .device-status-section h5 {
            margin: 0 0 1rem 0;
            color: #34495e;
            font-size: 1rem;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .action-buttons .btn {
            margin: 0;
        }

        .websocket-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .websocket-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .websocket-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .websocket-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .websocket-messages {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f8f9fa;
        }

        .websocket-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .message-device {
            background-color: #e8f5e8;
            border-left: 4px solid #27ae60;
        }

        .message-entity {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
        }

        .message-state {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .message-error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .message-raw {
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .message-command {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e9ecef;
        }

        .message-content {
            white-space: pre-wrap;
            word-break: break-all;
        }

        .copy-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .copy-btn:hover {
            background-color: #0056b3;
        }

        .copy-btn:active {
            background-color: #004085;
        }

        .clear-messages {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .clear-messages:hover {
            background-color: #5a6268;
        }

        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 5px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .log-timestamp {
            color: #95a5a6;
        }

        .log-topic {
            color: #3498db;
        }

        .log-message {
            color: #e74c3c;
        }

        .device-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .device-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }

        .device-card h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .device-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .device-actions .btn {
            flex: 0 0 auto;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            min-width: 80px;
        }

        .message-input {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .message-input .form-group {
            flex: 1;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .message-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“¡ MQTTæµ‹è¯•å·¥å…· & ğŸŒ RESTful APIæ§åˆ¶ - LinkNLink Edge</h1>
        <div class="nav">
            <a href="/">é¦–é¡µ</a>
            <a href="/linknlinkedge/web/unified_dashboard.html">ç»Ÿä¸€ç®¡ç†</a>
            <a href="/linknlinkedge/web/simple_dashboard.html">ç®€å•ä»ªè¡¨æ¿</a>
        </div>
    </div>

    <div class="container">
        <!-- WebSocketå®æ—¶æ¨é€ä¿¡æ¯ -->
        <div class="websocket-section">
            <h3>
                <span>ğŸ“¡</span>
                åŒ—å‘WebSocketå®æ—¶æ¨é€
                <span class="status" id="wsStatus">æœªè¿æ¥</span>
            </h3>
            <div class="websocket-status">
                <span>è¿æ¥çŠ¶æ€:</span>
                <span id="wsConnectionStatus">æœªè¿æ¥</span>
                <button id="wsConnectBtn" class="btn">è¿æ¥WebSocket</button>
                <button id="wsDisconnectBtn" class="btn" style="display: none;">æ–­å¼€è¿æ¥</button>
            </div>
            <div class="websocket-controls">
                <button class="btn" onclick="sendDeviceRegistryList()">ğŸ“± è·å–è®¾å¤‡åˆ—è¡¨</button>
                <button class="btn" onclick="sendEntityRegistryList()">ğŸ”§ è·å–å®ä½“åˆ—è¡¨</button>
            </div>
            <div class="websocket-controls">
                <button class="btn" onclick="sendLightToggle()">ğŸ’¡ ç¯å…‰åˆ‡æ¢</button>
                <button class="btn" onclick="sendLightTurnOn()">ğŸ’¡ ç¯å…‰å¼€å¯</button>
                <button class="btn" onclick="sendLightTurnOff()">ğŸ’¡ ç¯å…‰å…³é—­</button>
                <button class="btn" onclick="sendLightBrightness()">ğŸ”† è°ƒèŠ‚äº®åº¦</button>
            </div>
            <div class="websocket-controls">
                <button class="btn" onclick="sendLightColor()">ğŸŒˆ è®¾ç½®é¢œè‰²</button>
                <button class="btn" onclick="sendLightColorMode()">ğŸ¨ é¢œè‰²æ¨¡å¼</button>
                <button class="btn" onclick="sendLightColorTemp()">ğŸŒ¡ï¸ è‰²æ¸©è°ƒèŠ‚</button>
                <button class="btn" onclick="sendMotionSensor()">ğŸ‘¤ äººæ„Ÿæµ‹è¯•</button>
            </div>
            <div class="websocket-controls">
                <button class="btn" onclick="testAdvancedLight()" style="background: #e74c3c; color: white;">ğŸš€ é«˜çº§ç¯å…‰æµ‹è¯•</button>
                <button class="btn" onclick="testValueTemplate()" style="background: #9b59b6; color: white;">ğŸ“ Value Templateæµ‹è¯•</button>
                <button class="btn" onclick="testDynamicTopics()" style="background: #f39c12; color: white;">ğŸ”„ åŠ¨æ€ä¸»é¢˜æµ‹è¯•</button>
            </div>
            <div class="websocket-controls">
                <button class="btn" onclick="testDeviceOnline()" style="background: #27ae60; color: white;">ğŸŸ¢ è®¾å¤‡ä¸Šçº¿æµ‹è¯•</button>
                <button class="btn" onclick="testDeviceOffline()" style="background: #e74c3c; color: white;">ğŸ”´ è®¾å¤‡ç¦»çº¿æµ‹è¯•</button>
                <button class="btn" onclick="testAllDevices()" style="background: #3498db; color: white;">ğŸ”§ å…¨è®¾å¤‡æµ‹è¯•</button>
            </div>
            <div class="websocket-controls">
                <button class="btn" onclick="sendSwitchToggle()">ğŸ”Œ å¼€å…³åˆ‡æ¢</button>
                <button class="btn" onclick="sendSwitchTurnOn()">ğŸ”Œ å¼€å…³å¼€å¯</button>
                <button class="btn" onclick="sendSwitchTurnOff()">ğŸ”Œ å¼€å…³å…³é—­</button>
                <button class="btn" onclick="sendClimateMode()">â„ï¸ ç©ºè°ƒæ¨¡å¼</button>
            </div>
            <div class="websocket-messages" id="wsMessages">
                <div class="websocket-message">ç­‰å¾…WebSocketè¿æ¥...</div>
            </div>
            <button class="clear-messages" onclick="clearWebSocketMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
        </div>

        <!-- MQTTè¿æ¥é…ç½® -->
        <div class="card">
            <div class="card-header">
                <h3>MQTTè¿æ¥é…ç½®</h3>
                <div>
                    <span class="status" id="connectionStatus">æœªè¿æ¥</span>
                </div>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="mqttHost">MQTT Brokeråœ°å€</label>
                        <input type="text" id="mqttHost" value="127.0.0.1" placeholder="127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label for="mqttPort">ç«¯å£</label>
                        <input type="number" id="mqttPort" value="9001" placeholder="9001">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mqttUsername">ç”¨æˆ·å</label>
                        <input type="text" id="mqttUsername" value="admin" placeholder="admin">
                    </div>
                    <div class="form-group">
                        <label for="mqttPassword">å¯†ç </label>
                        <input type="password" id="mqttPassword" value="admin" placeholder="admin">
                    </div>
                </div>
                <div class="form-group">
                    <label for="mqttClientId">å®¢æˆ·ç«¯ID</label>
                    <input type="text" id="mqttClientId" value="linknlinkedge_web_client" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ID">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-success" id="connectBtn" onclick="connectMQTT()">è¿æ¥</button>
                    <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectMQTT()" disabled>æ–­å¼€è¿æ¥</button>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡æµ‹è¯• -->
        <div class="card">
            <div class="card-header">
                <h3>è®¾å¤‡æµ‹è¯•</h3>
            </div>
            <div class="card-body">
                <!-- è®¾å¤‡é€‰æ‹©åŒºåŸŸ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="deviceTypeSelect">é€‰æ‹©è®¾å¤‡ç±»å‹</label>
                        <select id="deviceTypeSelect" onchange="loadDeviceTestInterface()">
                            <option value="">è¯·é€‰æ‹©è®¾å¤‡ç±»å‹</option>
                            <option value="temperature">ğŸŒ¡ï¸ æ¸©åº¦ä¼ æ„Ÿå™¨</option>
                            <option value="light">ğŸ’¡ æ™ºèƒ½ç¯å…‰</option>
                            <option value="switch">ğŸ”Œ æ™ºèƒ½å¼€å…³</option>
                            <option value="climate">â„ï¸ ç©ºè°ƒæ§åˆ¶å™¨</option>
                            <option value="motion">ğŸ‘¤ äººæ„Ÿä¼ æ„Ÿå™¨</option>
                            <option value="humidity">ğŸ’§ æ¹¿åº¦ä¼ æ„Ÿå™¨</option>
                            <option value="power">âš¡ åŠŸç‡ç›‘æ§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="entityIdInput">å®ä½“ID</label>
                        <input type="text" id="entityIdInput" placeholder="sensor.test_temperature" value="">
                    </div>
                </div>

                <!-- åŠ¨æ€è®¾å¤‡æµ‹è¯•ç•Œé¢ -->
                <div id="deviceTestInterface" style="display: none;">
                    <div class="device-test-header">
                        <h4 id="selectedDeviceTitle">è®¾å¤‡æµ‹è¯•</h4>
                        <p id="selectedDeviceDescription">é€‰æ‹©è®¾å¤‡ç±»å‹åæ˜¾ç¤ºç›¸åº”çš„æµ‹è¯•é€‰é¡¹</p>
                    </div>
                    
                    <!-- è®¾å¤‡å‘ç°å’Œæ§åˆ¶åŒºåŸŸ -->
                    <div class="device-actions-section">
                        <h5>ğŸ” è®¾å¤‡å‘ç°</h5>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="discoveryBtn" onclick="sendDeviceDiscovery()">å‘é€å‘ç°</button>
                            <button class="btn btn-secondary" id="statusReportBtn" onclick="sendStatusReport()">çŠ¶æ€ä¸ŠæŠ¥</button>
                        </div>
                    </div>

                    <!-- Value Template æµ‹è¯•åŒºåŸŸ -->
                    <div class="device-actions-section" style="background: #f0f8ff; border-left: 4px solid #007bff;">
                        <h5>ğŸ¯ Value Template æµ‹è¯•</h5>
                        <div class="action-buttons">
                            <button class="btn btn-info" onclick="testTemperatureSensor()">ğŸŒ¡ï¸ åŸºç¡€æ¸©åº¦ä¼ æ„Ÿå™¨</button>
                            <button class="btn btn-info" onclick="testAdvancedTemperatureSensor()">ğŸŒ¡ï¸ é«˜çº§æ¸©åº¦ä¼ æ„Ÿå™¨ (roundæ¨¡æ¿)</button>
                            <button class="btn btn-info" onclick="testAdvancedTemperatureState()">ğŸ“Š é«˜çº§æ¸©åº¦çŠ¶æ€</button>
                            <button class="btn btn-info" onclick="testAdvancedTemperatureAttributes()">ğŸ“‹ é«˜çº§æ¸©åº¦å±æ€§</button>
                        </div>
                        <div class="action-buttons" style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="testLightDiscovery()">ğŸ’¡ åŸºç¡€æ™ºèƒ½ç¯å…‰</button>
                            <button class="btn btn-warning" onclick="testAdvancedLightDiscovery()">ğŸ’¡ é«˜çº§æ™ºèƒ½ç¯å…‰ (å¤šæ¨¡æ¿)</button>
                            <button class="btn btn-warning" onclick="testAdvancedLightState()">ğŸ¨ é«˜çº§ç¯å…‰çŠ¶æ€</button>
                            <button class="btn btn-warning" onclick="testAdvancedLightAttributes()">ğŸ“‹ é«˜çº§ç¯å…‰å±æ€§</button>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #e8f4fd; border-radius: 5px; font-size: 0.9rem; color: #666;">
                            <strong>æ¨¡æ¿åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
                            â€¢ <code>{{ value_json.temperature | round(1) }}</code> - å››èˆäº”å…¥åˆ°1ä½å°æ•°<br>
                            â€¢ <code>{{ value_json.brightness | round(0) }}</code> - å››èˆäº”å…¥åˆ°æ•´æ•°<br>
                            â€¢ <code>{{ value_json.rgb | join(",") }}</code> - æ•°ç»„è½¬é€—å·åˆ†éš”å­—ç¬¦ä¸²<br>
                            â€¢ <code>{{ value_json.state if value_json.state is defined else "off" }}</code> - æ¡ä»¶åˆ¤æ–­
                        </div>
                    </div>

                    <!-- è®¾å¤‡æ§åˆ¶åŒºåŸŸ -->
                    <div class="device-control-section" id="deviceControlSection" style="display: none;">
                        <h5>ğŸ›ï¸ è®¾å¤‡æ§åˆ¶</h5>
                        <div id="controlButtons" class="action-buttons">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„æ§åˆ¶æŒ‰é’® -->
                        </div>
                    </div>

                    <!-- è®¾å¤‡çŠ¶æ€æ§åˆ¶ -->
                    <div class="device-status-section">
                        <h5>ğŸ“¡ è®¾å¤‡çŠ¶æ€</h5>
                        <div class="action-buttons">
                            <button class="btn-online" onclick="setDeviceOnlineFromSelect()">ä¸Šçº¿</button>
                            <button class="btn-offline" onclick="setDeviceOfflineFromSelect()">ä¸‹çº¿</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€ä¸ŠæŠ¥è¡¨å• -->
        <div class="card">
            <div class="card-header">
                <h3>ğŸ“Š çŠ¶æ€ä¸ŠæŠ¥è¡¨å•</h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="stateEntityId">å®ä½“ID</label>
                        <input type="text" id="stateEntityId" placeholder="sensor.test_temperature" value="sensor.test_temperature">
                    </div>
                    <div class="form-group">
                        <label for="stateValue">çŠ¶æ€å€¼</label>
                        <input type="text" id="stateValue" placeholder="25.5" value="25.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="stateAttributes">å±æ€§ (JSONæ ¼å¼)</label>
                        <textarea id="stateAttributes" rows="4" placeholder='{"temperature": "25.5", "unit": "Â°C", "quality": "good"}'>{"temperature": "25.5", "unit": "Â°C", "quality": "good", "status": "active"}</textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="sendCustomStateReport()">ğŸ“¤ å‘é€çŠ¶æ€ä¸ŠæŠ¥</button>
                    <button class="btn btn-secondary" onclick="loadPresetStates()">ğŸ“‹ åŠ è½½é¢„è®¾</button>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯å‘é€ -->
        <div class="card">
            <div class="card-header">
                <h3>æ¶ˆæ¯å‘é€</h3>
            </div>
            <div class="card-body">
                <div class="message-input">
                    <div class="form-group">
                        <label for="messageTopic">ä¸»é¢˜</label>
                        <input type="text" id="messageTopic" placeholder="linknlinkedge/sensor/temperature/config">
                    </div>
                    <div class="form-group">
                        <label for="messagePayload">æ¶ˆæ¯å†…å®¹</label>
                        <textarea id="messagePayload" placeholder='{"name": "Test Sensor", "state_topic": "test/status"}'></textarea>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ—¥å¿— -->
        <div class="card">
            <div class="card-header">
                <h3>æ¶ˆæ¯æ—¥å¿—</h3>
                <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="card-body">
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[ç­‰å¾…è¿æ¥]</span> MQTTæµ‹è¯•å·¥å…·å·²å°±ç»ª
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mqttClient = null;
        let isConnected = false;
        let wsClient = null;
        let wsConnected = false;
        let messageIdCounter = 1; // WebSocketæ¶ˆæ¯IDè®¡æ•°å™¨

        // è¿æ¥MQTT
        function connectMQTT() {
            const host = document.getElementById('mqttHost').value;
            const port = document.getElementById('mqttPort').value;
            const username = document.getElementById('mqttUsername').value;
            const password = document.getElementById('mqttPassword').value;
            let clientId = document.getElementById('mqttClientId').value;

            // ç¡®ä¿å®¢æˆ·ç«¯IDå”¯ä¸€æ€§
            if (!clientId) {
                clientId = 'linknlinkedge_web_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                document.getElementById('mqttClientId').value = clientId;
            }

            const brokerUrl = `ws://${host}:${port}`; // ç›´æ¥è¿æ¥åˆ°MQTT brokerçš„WebSocketç«¯å£

            const options = {
                clientId: clientId,
                username: username,
                password: password,
                clean: true,
                reconnectPeriod: 0, // ç¦ç”¨è‡ªåŠ¨é‡è¿ï¼Œé¿å…è¿æ¥å¾ªç¯
                connectTimeout: 10 * 1000,
                keepalive: 60,
                protocolVersion: 4, // ä½¿ç”¨MQTT 3.1.1
                protocol: 'ws', // æ˜ç¡®æŒ‡å®šWebSocketåè®®
            };

            try {
                mqttClient = mqtt.connect(brokerUrl, options);

                mqttClient.on('connect', function () {
                    isConnected = true;
                    updateConnectionStatus('å·²è¿æ¥', 'connected');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    addLog('ç³»ç»Ÿ', 'MQTTè¿æ¥æˆåŠŸ');
                    
                    // è®¢é˜…æ‰€æœ‰linknlinkedgeä¸»é¢˜
                    mqttClient.subscribe('linknlinkedge/#', function (err) {
                        if (!err) {
                            addLog('ç³»ç»Ÿ', 'å·²è®¢é˜… linknlinkedge/# ä¸»é¢˜');
                        }
                    });
                });

                mqttClient.on('error', function (err) {
                    console.error('MQTTè¿æ¥é”™è¯¯:', err);
                    addLog('é”™è¯¯', err.message);
                    showMessage('MQTTè¿æ¥å¤±è´¥: ' + err.message, 'error');
                });

                mqttClient.on('message', function (topic, message) {
                    addLog('æ¥æ”¶', topic, message.toString());
                });

                mqttClient.on('close', function () {
                    console.log('MQTTè¿æ¥å·²å…³é—­');
                    isConnected = false;
                    updateConnectionStatus('å·²æ–­å¼€', 'disconnected');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    addLog('ç³»ç»Ÿ', 'MQTTè¿æ¥å·²æ–­å¼€');
                });

                mqttClient.on('offline', function () {
                    console.log('MQTTå®¢æˆ·ç«¯ç¦»çº¿');
                    addLog('ç³»ç»Ÿ', 'MQTTå®¢æˆ·ç«¯ç¦»çº¿');
                });

                mqttClient.on('reconnect', function () {
                    console.log('MQTTå®¢æˆ·ç«¯é‡è¿ä¸­...');
                    addLog('ç³»ç»Ÿ', 'MQTTå®¢æˆ·ç«¯é‡è¿ä¸­...');
                });

            } catch (err) {
                showMessage('è¿æ¥å¤±è´¥: ' + err.message, 'error');
            }
        }

        // æ–­å¼€MQTTè¿æ¥
        function disconnectMQTT() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = 'status ' + className;
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(type, topic, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            if (message) {
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span> 
                    <span class="log-topic">[${type}] ${topic}</span><br>
                    <span class="log-message">${message}</span>
                `;
            } else {
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span> 
                    <span class="log-topic">[${type}]</span> ${topic}
                `;
            }
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const topic = document.getElementById('messageTopic').value;
            const payload = document.getElementById('messagePayload').value;

            if (!topic) {
                showMessage('è¯·è¾“å…¥ä¸»é¢˜', 'error');
                return;
            }

            try {
                mqttClient.publish(topic, payload, { qos: 1, retain: false });
                addLog('å‘é€', topic, payload);
                showMessage('æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
            } catch (err) {
                showMessage('å‘é€å¤±è´¥: ' + err.message, 'error');
            }
        }

        // æµ‹è¯•æ¸©åº¦ä¼ æ„Ÿå™¨ï¼ˆå¸¦Value Templateï¼‰
        function testTemperatureSensor() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "æµ‹è¯•æ¸©åº¦ä¼ æ„Ÿå™¨",
                unique_id: "test_temp_001",
                state_topic: "linknlinkedge/sensor/test_temperature/status",
                command_topic: "linknlinkedge/sensor/test_temperature/set",
                unit_of_measurement: "Â°C",
                device_class: "temperature",
                state_class: "measurement",
                availability_topic: "linknlinkedge/sensor/test_temperature/availability",
                payload_available: "online",
                payload_not_available: "offline",
                json_attributes_topic: "linknlinkedge/sensor/test_temperature/attributes",
                value_template: "{{ value_json.temperature }}",
                device: {
                    identifiers: ["test_temp_001"],
                    name: "æµ‹è¯•æ¸©åº¦ä¼ æ„Ÿå™¨",
                    manufacturer: "Test Manufacturer",
                    model: "Test Model",
                    sw_version: "1.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/sensor/test_temperature/config";
            mqttClient.publish(topic, JSON.stringify(config, null, 2), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(config, null, 2));
            showMessage('æ¸©åº¦ä¼ æ„Ÿå™¨å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // æµ‹è¯•é«˜çº§æ¸©åº¦ä¼ æ„Ÿå™¨ï¼ˆå¸¦å¤æ‚Value Templateï¼‰
        function testAdvancedTemperatureSensor() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "é«˜çº§æ¸©åº¦ä¼ æ„Ÿå™¨",
                unique_id: "advanced_temp_001",
                state_topic: "linknlinkedge/sensor/advanced_temp/status",
                command_topic: "linknlinkedge/sensor/advanced_temp/set",
                unit_of_measurement: "Â°C",
                device_class: "temperature",
                state_class: "measurement",
                availability_topic: "linknlinkedge/sensor/advanced_temp/availability",
                payload_available: "online",
                payload_not_available: "offline",
                json_attributes_topic: "linknlinkedge/sensor/advanced_temp/attributes",
                value_template: "{{ value_json.temperature | round(1) }}",
                device: {
                    identifiers: ["advanced_temp_001"],
                    name: "é«˜çº§æ¸©åº¦ä¼ æ„Ÿå™¨",
                    manufacturer: "Advanced Manufacturer",
                    model: "Advanced Model",
                    sw_version: "2.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/sensor/advanced_temp/config";
            mqttClient.publish(topic, JSON.stringify(config, null, 2), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(config, null, 2));
            showMessage('é«˜çº§æ¸©åº¦ä¼ æ„Ÿå™¨å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // æµ‹è¯•æ¸©åº¦çŠ¶æ€
        function testTemperatureState() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const state = {
                temperature: (Math.random() * 20 + 15).toFixed(1),
                timestamp: new Date().toISOString(),
                quality: "good",
                status: "active"
            };

            const topic = "linknlinkedge/sensor/test_temperature/status";
            mqttClient.publish(topic, JSON.stringify(state), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(state));
            showMessage('æ¸©åº¦çŠ¶æ€å·²ä¸ŠæŠ¥', 'success');
        }

        // æµ‹è¯•é«˜çº§æ¸©åº¦çŠ¶æ€ï¼ˆå¸¦å¤æ‚æ•°æ®ï¼‰
        function testAdvancedTemperatureState() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const state = {
                temperature: (Math.random() * 20 + 15).toFixed(4), // 4ä½å°æ•°ï¼Œæµ‹è¯•round(1)æ¨¡æ¿
                humidity: (Math.random() * 40 + 30).toFixed(1),
                pressure: (Math.random() * 100 + 1000).toFixed(2),
                timestamp: new Date().toISOString(),
                quality: "excellent",
                status: "active",
                battery_level: Math.floor(Math.random() * 20 + 80),
                signal_strength: Math.floor(Math.random() * 20 - 60)
            };

            const topic = "linknlinkedge/sensor/advanced_temp/state";
            mqttClient.publish(topic, JSON.stringify(state), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(state));
            showMessage('é«˜çº§æ¸©åº¦çŠ¶æ€å·²ä¸ŠæŠ¥ï¼ˆæµ‹è¯•Value Template: round(1)ï¼‰', 'success');
        }

        // æµ‹è¯•JSONå±æ€§æ›´æ–°
        function testAdvancedTemperatureAttributes() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const attributes = {
                location: "living_room",
                room: "å®¢å…",
                calibration_offset: (Math.random() * 0.2 - 0.1).toFixed(3),
                last_calibration: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                battery_level: Math.floor(Math.random() * 20 + 80),
                signal_strength: Math.floor(Math.random() * 20 - 60),
                firmware_version: "2.1." + Math.floor(Math.random() * 10),
                power_consumption: (Math.random() * 5 + 10).toFixed(1),
                energy_today: (Math.random() * 2).toFixed(2)
            };

            const topic = "linknlinkedge/sensor/advanced_temp/attributes";
            mqttClient.publish(topic, JSON.stringify(attributes), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(attributes));
            showMessage('é«˜çº§æ¸©åº¦å±æ€§å·²æ›´æ–°', 'success');
        }

        // æµ‹è¯•ç¯å…‰å‘ç°
        function testLightDiscovery() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "æµ‹è¯•æ™ºèƒ½ç¯å…‰",
                unique_id: "test_light_001",
                state_topic: "linknlinkedge/light/test_light/status",
                command_topic: "linknlinkedge/light/test_light/set",
                brightness_state_topic: "linknlinkedge/light/test_light/status",
                brightness_command_topic: "linknlinkedge/light/test_light/set",
                availability_topic: "linknlinkedge/light/test_light/availability",
                payload_available: "online",
                payload_not_available: "offline",
                payload_on: "ON",
                payload_off: "OFF",
                state_on: "ON",
                state_off: "OFF",
                brightness: true,
                device: {
                    identifiers: ["test_light_001"],
                    name: "æµ‹è¯•æ™ºèƒ½ç¯å…‰",
                    manufacturer: "Test Manufacturer",
                    model: "Test Light",
                    sw_version: "1.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/light/test_light/config";
            mqttClient.publish(topic, JSON.stringify(config, null, 2), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(config, null, 2));
            showMessage('æ™ºèƒ½ç¯å…‰å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // æµ‹è¯•é«˜çº§æ™ºèƒ½ç¯å…‰ï¼ˆå¸¦å¤æ‚Value Templateï¼‰
        function testAdvancedLightDiscovery() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "é«˜çº§æ™ºèƒ½ç¯å…‰",
                unique_id: "advanced_light_001",
                device_class: "light",
                state_topic: "linknlinkedge/light/advanced_light/status",
                command_topic: "linknlinkedge/light/advanced_light/set",
                brightness_command_topic: "linknlinkedge/light/advanced_light/set",
                color_temp_command_topic: "linknlinkedge/light/advanced_light/set",
                rgb_command_topic: "linknlinkedge/light/advanced_light/set",
                availability_topic: "linknlinkedge/light/advanced_light/availability",
                json_attributes_topic: "linknlinkedge/light/advanced_light/attributes",
                value_template: "{{ value_json.state if value_json.state is defined else \"off\" }}",
                brightness_value_template: "{{ value_json.brightness | round(0) }}",
                color_temp_value_template: "{{ value_json.color_temp | round(0) }}",
                rgb_value_template: "{{ value_json.rgb | join(\",\") }}",
                payload_available: "online",
                payload_not_available: "offline",
                payload_on: "ON",
                payload_off: "OFF",
                state_on: "ON",
                state_off: "OFF",
                device: {
                    identifiers: ["advanced_light_001"],
                    name: "é«˜çº§æ™ºèƒ½ç¯å…‰",
                    manufacturer: "Smart Home Co",
                    model: "RGBW Light Pro",
                    sw_version: "2.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/light/advanced_light/config";
            mqttClient.publish(topic, JSON.stringify(config, null, 2), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(config, null, 2));
            showMessage('é«˜çº§æ™ºèƒ½ç¯å…‰å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // æµ‹è¯•ç¯å…‰æ§åˆ¶
        function testLightControl() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const commands = [
                { topic: "linknlinkedge/light/test_light/set", payload: "ON" },
                { topic: "linknlinkedge/light/test_light/brightness/set", payload: "180" }
            ];

            commands.forEach(cmd => {
                mqttClient.publish(cmd.topic, cmd.payload, { qos: 1, retain: false });
                addLog('å‘é€', cmd.topic, cmd.payload);
            });

            showMessage('ç¯å…‰æ§åˆ¶å‘½ä»¤å·²å‘é€', 'success');
        }

        // æµ‹è¯•é«˜çº§ç¯å…‰çŠ¶æ€ï¼ˆå¸¦å¤æ‚Value Templateï¼‰
        function testAdvancedLightState() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const state = {
                state: Math.random() > 0.5 ? "ON" : "OFF",
                brightness: Math.floor(Math.random() * 255), // æµ‹è¯•round(0)æ¨¡æ¿
                color_temp: Math.floor(Math.random() * 2000 + 2000), // æµ‹è¯•round(0)æ¨¡æ¿
                rgb: [Math.floor(Math.random() * 255), Math.floor(Math.random() * 255), Math.floor(Math.random() * 255)], // æµ‹è¯•joinæ¨¡æ¿
                effect: Math.random() > 0.5 ? "rainbow" : "static",
                color_mode: "rgb",
                friendly_name: "é«˜çº§æ™ºèƒ½ç¯å…‰",
                supported_features: 147,
                power_consumption: (Math.random() * 20 + 5).toFixed(1)
            };

            const topic = "linknlinkedge/light/advanced_light/status";
            mqttClient.publish(topic, JSON.stringify(state), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(state));
            showMessage('é«˜çº§ç¯å…‰çŠ¶æ€å·²ä¸ŠæŠ¥ï¼ˆæµ‹è¯•å¤šç§Value Templateï¼‰', 'success');
        }

        // æµ‹è¯•é«˜çº§ç¯å…‰å±æ€§
        function testAdvancedLightAttributes() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const attributes = {
                location: "living_room",
                room: "å®¢å…",
                power_consumption: (Math.random() * 20 + 5).toFixed(1),
                last_seen: new Date().toISOString(),
                firmware_version: "2.1." + Math.floor(Math.random() * 10),
                wifi_signal: Math.floor(Math.random() * 20 - 60),
                energy_today: (Math.random() * 2).toFixed(2),
                total_runtime: Math.floor(Math.random() * 10000),
                color_temperature_range: [2000, 6500],
                supported_effects: ["rainbow", "static", "breathing", "strobe"]
            };

            const topic = "linknlinkedge/light/advanced_light/attributes";
            mqttClient.publish(topic, JSON.stringify(attributes), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(attributes));
            showMessage('é«˜çº§ç¯å…‰å±æ€§å·²æ›´æ–°', 'success');
        }

        // æµ‹è¯•å¼€å…³å‘ç°
        function testSwitchDiscovery() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "æµ‹è¯•æ™ºèƒ½å¼€å…³",
                unique_id: "test_switch_001",
                device_class: "switch",
                state_topic: "linknlinkedge/switch/test_switch/status",
                command_topic: "linknlinkedge/switch/test_switch/set",
                availability_topic: "linknlinkedge/switch/test_switch/availability",
                json_attributes_topic: "linknlinkedge/switch/test_switch/attributes",
                value_template: "{{ value_json.state if value_json.state is defined else 'off' }}",
                payload_available: "online",
                payload_not_available: "offline",
                payload_on: "ON",
                payload_off: "OFF",
                state_on: "ON",
                state_off: "OFF",
                device: {
                    identifiers: ["test_switch_001"],
                    name: "æµ‹è¯•æ™ºèƒ½å¼€å…³",
                    manufacturer: "Test Manufacturer",
                    model: "Test Switch",
                    sw_version: "1.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/switch/test_switch/config";
            mqttClient.publish(topic, JSON.stringify(config, null, 2), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(config, null, 2));
            showMessage('æ™ºèƒ½å¼€å…³å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // æµ‹è¯•å¼€å…³æ§åˆ¶
        function testSwitchControl() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const topic = "linknlinkedge/switch/test_switch/set";
            const payload = "ON";
            mqttClient.publish(topic, payload, { qos: 1, retain: false });
            addLog('å‘é€', topic, payload);
            showMessage('å¼€å…³æ§åˆ¶å‘½ä»¤å·²å‘é€', 'success');
        }

        // æµ‹è¯•ç©ºè°ƒå‘ç°
        function testClimateDiscovery() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "æµ‹è¯•ç©ºè°ƒæ§åˆ¶å™¨",
                unique_id: "test_climate_001",
                device_class: "climate",
                current_temperature_topic: "linknlinkedge/climate/test_climate/status",
                temperature_command_topic: "linknlinkedge/climate/test_climate/set",
                temperature_state_topic: "linknlinkedge/climate/test_climate/status",
                mode_command_topic: "linknlinkedge/climate/test_climate/set",
                mode_state_topic: "linknlinkedge/climate/test_climate/status",
                fan_mode_command_topic: "linknlinkedge/climate/test_climate/set",
                fan_mode_state_topic: "linknlinkedge/climate/test_climate/status",
                availability_topic: "linknlinkedge/climate/test_climate/availability",
                json_attributes_topic: "linknlinkedge/climate/test_climate/attributes",
                value_template: "{{ value_json.state if value_json.state is defined else 'off' }}",
                payload_available: "online",
                payload_not_available: "offline",
                modes: ["off", "auto", "cool", "heat", "dry", "fan_only"],
                fan_modes: ["auto", "low", "medium", "high"],
                min_temp: 16,
                max_temp: 30,
                temp_step: 1,
                temperature_unit: "C",
                device: {
                    identifiers: ["test_climate_001"],
                    name: "æµ‹è¯•ç©ºè°ƒæ§åˆ¶å™¨",
                    manufacturer: "Test Manufacturer",
                    model: "Test AC",
                    sw_version: "1.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/climate/test_climate/config";
            mqttClient.publish(topic, JSON.stringify(config, null, 2), { qos: 1, retain: false });
            addLog('å‘é€', topic, JSON.stringify(config, null, 2));
            showMessage('ç©ºè°ƒæ§åˆ¶å™¨å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // æµ‹è¯•ç©ºè°ƒæ§åˆ¶
        function testClimateControl() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const commands = [
                { topic: "linknlinkedge/climate/test_climate/mode/set", payload: "cool" },
                { topic: "linknlinkedge/climate/test_climate/target_temperature/set", payload: "24" },
                { topic: "linknlinkedge/climate/test_climate/fan_mode/set", payload: "auto" }
            ];

            commands.forEach(cmd => {
                mqttClient.publish(cmd.topic, cmd.payload, { qos: 1, retain: false });
                addLog('å‘é€', cmd.topic, cmd.payload);
            });

            showMessage('ç©ºè°ƒæ§åˆ¶å‘½ä»¤å·²å‘é€', 'success');
        }

        // è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ID
        function getNextMessageId() {
            return messageIdCounter++;
        }

        // WebSocketè¿æ¥åŠŸèƒ½
        function connectWebSocket() {
            if (wsConnected) {
                showMessage('WebSocketå·²è¿æ¥', 'warning');
                return;
            }

            const wsUrl = `ws://${window.location.hostname}:${window.location.port}/linknlinkedge/api/websocket`;
            wsClient = new WebSocket(wsUrl);

            wsClient.onopen = function() {
                wsConnected = true;
                updateWebSocketStatus('å·²è¿æ¥', 'connected');
                addWebSocketMessage('WebSocketè¿æ¥æˆåŠŸ', 'success');
                
                // å‘é€è®¤è¯æ¶ˆæ¯
                const authMessage = {
                    type: "auth",
                    access_token: "test_token",
                    id: getNextMessageId()
                };
                wsClient.send(JSON.stringify(authMessage));
            };

            wsClient.onmessage = function(event) {
                try {
                    // å¤„ç†å¯èƒ½åŒ…å«å¤šä¸ªJSONæ¶ˆæ¯çš„æƒ…å†µ
                    const data = event.data;
                    const messages = data.split('\n').filter(msg => msg.trim());
                    
                    messages.forEach(msg => {
                        try {
                            const message = JSON.parse(msg);
                            handleWebSocketMessage(message);
                        } catch (e) {
                            addWebSocketMessage(`æ”¶åˆ°æ¶ˆæ¯: ${msg}`, 'info');
                        }
                    });
                } catch (e) {
                    addWebSocketMessage(`æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'info');
                }
            };

            wsClient.onclose = function() {
                wsConnected = false;
                updateWebSocketStatus('å·²æ–­å¼€', 'disconnected');
                addWebSocketMessage('WebSocketè¿æ¥å·²æ–­å¼€', 'warning');
            };

            wsClient.onerror = function(error) {
                addWebSocketMessage(`WebSocketé”™è¯¯: ${error}`, 'error');
            };
        }

        function disconnectWebSocket() {
            if (wsClient) {
                wsClient.close();
                wsClient = null;
            }
        }

        function updateWebSocketStatus(status, className) {
            const statusElement = document.getElementById('wsStatus');
            const connectionStatusElement = document.getElementById('wsConnectionStatus');
            
            statusElement.textContent = status;
            statusElement.className = `status ${className}`;
            connectionStatusElement.textContent = status;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const connectBtn = document.getElementById('wsConnectBtn');
            const disconnectBtn = document.getElementById('wsDisconnectBtn');
            
            if (wsConnected) {
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-block';
            } else {
                connectBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'none';
            }
        }

        function addWebSocketMessage(message, type = 'info', jsonData = null) {
            const messagesContainer = document.getElementById('wsMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `websocket-message message-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            // å¦‚æœæ˜¯åŸå§‹JSONæ¶ˆæ¯ï¼Œæ·»åŠ å¤åˆ¶æŒ‰é’®
            if (type === 'raw' && jsonData) {
                const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <strong>[${timestamp}]</strong>
                        <button class="copy-btn" onclick="copyJsonMessage('${messageId}')" title="å¤åˆ¶JSON">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                    </div>
                    <div class="message-content" id="${messageId}">${message}</div>
                `;
                // å­˜å‚¨JSONæ•°æ®ç”¨äºå¤åˆ¶
                messageDiv.setAttribute('data-json', JSON.stringify(jsonData));
            } else {
                messageDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // é™åˆ¶æ¶ˆæ¯æ•°é‡
            const messages = messagesContainer.children;
            if (messages.length > 100) {
                messagesContainer.removeChild(messages[0]);
            }
        }

        function handleWebSocketMessage(message) {
            // æ˜¾ç¤ºåŸå§‹JSONæ¶ˆæ¯
            addWebSocketMessage(`åŸå§‹æ¶ˆæ¯: ${JSON.stringify(message, null, 2)}`, 'raw', message);
            
            // å¤„ç†æ¶ˆæ¯ID
            if (message.id) {
                console.log('æ”¶åˆ°å›å¤æ¶ˆæ¯ï¼ŒID:', message.id);
            }
            
            // åŒæ—¶æ˜¾ç¤ºç®€åŒ–çš„å¤„ç†ä¿¡æ¯
            if (message.type === 'event') {
                if (message.event) {
                    const eventType = message.event.event_type;
                    const eventData = message.event.data;
                    
                    switch (eventType) {
                        case 'device_registry_updated':
                            addWebSocketMessage(`ğŸ“± è®¾å¤‡æ³¨å†Œæ›´æ–°: ${eventData.device_id} (${eventData.action})`, 'device');
                            break;
                        case 'entity_registry_updated':
                            addWebSocketMessage(`ğŸ”§ å®ä½“æ³¨å†Œæ›´æ–°: ${eventData.entity_id} (${eventData.action})`, 'entity');
                            break;
                        case 'state_changed':
                            addWebSocketMessage(`ğŸ”„ çŠ¶æ€å˜æ›´: ${eventData.entity_id} -> ${eventData.new_state.state}`, 'state');
                            break;
                        case 'mqtt_command_received':
                            addWebSocketMessage(`ğŸ® MQTTæ§åˆ¶å‘½ä»¤: ${eventData.entity_id} -> ${eventData.payload}`, 'command');
                            break;
                        default:
                            addWebSocketMessage(`ğŸ“¡ äº‹ä»¶: ${eventType}`, 'info');
                    }
                }
            } else if (message.type === 'result') {
                addWebSocketMessage(`âœ… ç»“æœ: ${JSON.stringify(message.result, null, 2)}`, 'info');
            } else if (message.type === 'error') {
                addWebSocketMessage(`âŒ é”™è¯¯: ${message.error.message}`, 'error');
            } else {
                addWebSocketMessage(`ğŸ“¨ å…¶ä»–æ¶ˆæ¯ç±»å‹: ${message.type}`, 'info');
            }
        }

        function clearWebSocketMessages() {
            const messagesContainer = document.getElementById('wsMessages');
            messagesContainer.innerHTML = '<div class="websocket-message">æ¶ˆæ¯å·²æ¸…ç©º</div>';
        }

        // å¤åˆ¶JSONæ¶ˆæ¯åˆ°å‰ªè´´æ¿
        function copyJsonMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) {
                showMessage('æ¶ˆæ¯å…ƒç´ æœªæ‰¾åˆ°', 'error');
                return;
            }

            // è·å–çˆ¶çº§æ¶ˆæ¯å®¹å™¨
            const messageContainer = messageElement.closest('.websocket-message');
            if (!messageContainer) {
                showMessage('æ¶ˆæ¯å®¹å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }

            // è·å–å­˜å‚¨çš„JSONæ•°æ®
            const jsonData = messageContainer.getAttribute('data-json');
            if (!jsonData) {
                showMessage('JSONæ•°æ®æœªæ‰¾åˆ°', 'error');
                return;
            }

            try {
                // è§£æå¹¶æ ¼å¼åŒ–JSON
                const parsedJson = JSON.parse(jsonData);
                const formattedJson = JSON.stringify(parsedJson, null, 2);
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(formattedJson).then(() => {
                    showMessage('JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡æœ¬
                    const copyBtn = messageContainer.querySelector('.copy-btn');
                    if (copyBtn) {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = 'âœ… å·²å¤åˆ¶';
                        copyBtn.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                            copyBtn.style.backgroundColor = '';
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            } catch (err) {
                console.error('JSONè§£æå¤±è´¥:', err);
                showMessage('JSONæ ¼å¼é”™è¯¯', 'error');
            }
        }

        // å‘é€è®¾å¤‡æ³¨å†Œè¡¨åˆ—è¡¨è¯·æ±‚
        function sendDeviceRegistryList() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "config/device_registry/list",
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€è¯·æ±‚: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€å®ä½“æ³¨å†Œè¡¨åˆ—è¡¨è¯·æ±‚
        function sendEntityRegistryList() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "config/entity_registry/list",
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€è¯·æ±‚: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç¯å…‰åˆ‡æ¢æ§åˆ¶
        function sendLightToggle() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "light",
                service: "toggle",
                return_response: false,
                service_data: {
                    entity_id: "light.test_light"
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€ç¯å…‰åˆ‡æ¢: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç¯å…‰å¼€å¯æ§åˆ¶
        function sendLightTurnOn() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "light",
                service: "turn_on",
                return_response: false,
                service_data: {
                    entity_id: "light.test_light"
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€ç¯å…‰å¼€å¯: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç¯å…‰å…³é—­æ§åˆ¶
        function sendLightTurnOff() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "light",
                service: "turn_off",
                return_response: false,
                service_data: {
                    entity_id: "light.test_light"
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€ç¯å…‰å…³é—­: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç¯å…‰äº®åº¦æ§åˆ¶
        function sendLightBrightness() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "light",
                service: "turn_on",
                return_response: false,
                service_data: {
                    entity_id: "light.test_light",
                    brightness: 128
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€äº®åº¦è°ƒèŠ‚: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€å¼€å…³åˆ‡æ¢æ§åˆ¶
        function sendSwitchToggle() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "switch",
                service: "toggle",
                return_response: false,
                service_data: {
                    entity_id: "switch.test_switch"
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€å¼€å…³åˆ‡æ¢: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€å¼€å…³å¼€å¯æ§åˆ¶
        function sendSwitchTurnOn() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "switch",
                service: "turn_on",
                return_response: false,
                service_data: {
                    entity_id: "switch.test_switch"
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€å¼€å…³å¼€å¯: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€å¼€å…³å…³é—­æ§åˆ¶
        function sendSwitchTurnOff() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "switch",
                service: "turn_off",
                return_response: false,
                service_data: {
                    entity_id: "switch.test_switch"
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€å¼€å…³å…³é—­: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç©ºè°ƒæ¨¡å¼æ§åˆ¶
        function sendClimateMode() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "climate",
                service: "set_hvac_mode",
                return_response: false,
                service_data: {
                    entity_id: "climate.test_climate",
                    hvac_mode: "cool"
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€ç©ºè°ƒæ¨¡å¼: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç¯å…‰é¢œè‰²æ§åˆ¶
        function sendLightColor() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "light",
                service: "turn_on",
                return_response: false,
                service_data: {
                    entity_id: "light.test_light",
                    rgb_color: [255, 0, 0] // çº¢è‰²
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€ç¯å…‰é¢œè‰²: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç¯å…‰é¢œè‰²æ¨¡å¼æ§åˆ¶
        function sendLightColorMode() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "light",
                service: "turn_on",
                return_response: false,
                service_data: {
                    entity_id: "light.test_light",
                    color_mode: "hs",
                    hs_color: [120, 100] // ç»¿è‰²ï¼Œé¥±å’Œåº¦100%
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€é¢œè‰²æ¨¡å¼: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // å‘é€ç¯å…‰è‰²æ¸©æ§åˆ¶
        function sendLightColorTemp() {
            if (!wsConnected) {
                showMessage('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            const message = {
                type: "call_service",
                domain: "light",
                service: "turn_on",
                return_response: false,
                service_data: {
                    entity_id: "light.test_light",
                    color_temp: 3000 // æš–ç™½è‰²
                },
                id: getNextMessageId()
            };

            wsClient.send(JSON.stringify(message));
            addWebSocketMessage(`ğŸ“¤ å‘é€è‰²æ¸©è°ƒèŠ‚: ${JSON.stringify(message, null, 2)}`, 'info');
        }

        // é«˜çº§ç¯å…‰æµ‹è¯•
        function testAdvancedLight() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            showMessage('å¼€å§‹é«˜çº§ç¯å…‰æµ‹è¯•...', 'info');

            // 1. å‘é€è®¾å¤‡å‘ç°
            testLightDiscovery();
            
            setTimeout(() => {
                // 2. å‘é€è®¾å¤‡ä¸Šçº¿
                mqttClient.publish("linknlinkedge/light/test_light/online", "online", { qos: 1, retain: false });
                addLog('å‘é€', "linknlinkedge/light/test_light/online", "online");
                
                setTimeout(() => {
                    // 3. æµ‹è¯•ä¸åŒäº®åº¦
                    const brightnessLevels = [0, 64, 128, 192, 255];
                    let index = 0;
                    
                    const testBrightness = () => {
                        if (index < brightnessLevels.length) {
                            const brightness = brightnessLevels[index];
                            const stateData = {
                                state: brightness > 0 ? "ON" : "OFF",
                                brightness: brightness,
                                color_temp: 300,
                                rgb: [255, 100, 50]
                            };
                            
                            mqttClient.publish("linknlinkedge/light/test_light/status", JSON.stringify(stateData), { qos: 1, retain: false });
                            addLog('å‘é€', "linknlinkedge/light/test_light/status", `äº®åº¦: ${brightness}`);
                            
                            index++;
                            setTimeout(testBrightness, 1000);
                        } else {
                            // 4. æµ‹è¯•é¢œè‰²å˜åŒ–
                            const colors = [
                                [255, 0, 0],     // çº¢è‰²
                                [0, 255, 0],     // ç»¿è‰²
                                [0, 0, 255],     // è“è‰²
                                [255, 255, 0],   // é»„è‰²
                                [255, 0, 255],   // ç´«è‰²
                                [0, 255, 255]    // é’è‰²
                            ];
                            
                            let colorIndex = 0;
                            const testColors = () => {
                                if (colorIndex < colors.length) {
                                    const color = colors[colorIndex];
                                    const stateData = {
                                        state: "ON",
                                        brightness: 200,
                                        color_temp: 300,
                                        rgb: color
                                    };
                                    
                                    mqttClient.publish("linknlinkedge/light/test_light/status", JSON.stringify(stateData), { qos: 1, retain: false });
                                    addLog('å‘é€', "linknlinkedge/light/test_light/status", `é¢œè‰²: [${color.join(', ')}]`);
                                    
                                    colorIndex++;
                                    setTimeout(testColors, 1000);
                                } else {
                                    // 5. å‘é€æœ€ç»ˆçŠ¶æ€
                                    const finalState = {
                                        state: "ON",
                                        brightness: 180,
                                        color_temp: 350,
                                        rgb: [200, 150, 100],
                                        effect: "solid"
                                    };
                                    
                                    mqttClient.publish("linknlinkedge/light/test_light/status", JSON.stringify(finalState), { qos: 1, retain: false });
                                    addLog('å‘é€', "linknlinkedge/light/test_light/status", "æœ€ç»ˆçŠ¶æ€");
                                    
                                    showMessage('é«˜çº§ç¯å…‰æµ‹è¯•å®Œæˆï¼', 'success');
                                }
                            };
                            
                            setTimeout(testColors, 1000);
                        }
                    };
                    
                    testBrightness();
                }, 2000);
            }, 1000);
        }

        // Value Templateæµ‹è¯•
        function testValueTemplate() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            showMessage('å¼€å§‹Value Templateæµ‹è¯•...', 'info');

            // æµ‹è¯•ä¸åŒçš„æ¨¡æ¿
            const templates = [
                {
                    name: "åŸºç¡€çŠ¶æ€æ¨¡æ¿",
                    template: "{{ value_json.state }}",
                    data: { state: "ON", brightness: 128 }
                },
                {
                    name: "äº®åº¦æ¨¡æ¿",
                    template: "{{ value_json.brightness | int }}",
                    data: { state: "ON", brightness: 180.5 }
                },
                {
                    name: "æ¡ä»¶æ¨¡æ¿",
                    template: "{{ value_json.state if value_json.state != 'unknown' else 'unavailable' }}",
                    data: { state: "unknown", brightness: 128 }
                },
                {
                    name: "æ•°å­¦è¿ç®—æ¨¡æ¿",
                    template: "{{ value_json.brightness | float * 2 }}",
                    data: { state: "ON", brightness: 100 }
                },
                {
                    name: "å­—ç¬¦ä¸²å¤„ç†æ¨¡æ¿",
                    template: "{{ value_json.mode | upper }}",
                    data: { state: "ON", mode: "color" }
                }
            ];

            let index = 0;
            const testTemplate = () => {
                if (index < templates.length) {
                    const test = templates[index];
                    const stateData = {
                        ...test.data,
                        template_test: test.name,
                        template: test.template
                    };
                    
                    mqttClient.publish("linknlinkedge/light/test_light/status", JSON.stringify(stateData), { qos: 1, retain: false });
                    addLog('å‘é€', "linknlinkedge/light/test_light/status", `${test.name}: ${test.template}`);
                    
                    index++;
                    setTimeout(testTemplate, 2000);
                } else {
                    showMessage('Value Templateæµ‹è¯•å®Œæˆï¼', 'success');
                }
            };
            
            testTemplate();
        }

        // åŠ¨æ€ä¸»é¢˜æµ‹è¯•
        function testDynamicTopics() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            showMessage('å¼€å§‹åŠ¨æ€ä¸»é¢˜æµ‹è¯•...', 'info');

            // æµ‹è¯•ä¸åŒçš„ä¸»é¢˜ç»“æ„
            const topics = [
                {
                    name: "è‡ªå®šä¹‰çŠ¶æ€ä¸»é¢˜",
                    topic: "linknlinkedge/light/test_light/custom_status",
                    data: { state: "ON", brightness: 200, custom_field: "test_value" }
                },
                {
                    name: "è‡ªå®šä¹‰å±æ€§ä¸»é¢˜",
                    topic: "linknlinkedge/light/test_light/custom_attributes",
                    data: { battery_level: 90, signal_strength: -30, custom_attr: "dynamic_test" }
                },
                {
                    name: "è‡ªå®šä¹‰å¯ç”¨æ€§ä¸»é¢˜",
                    topic: "linknlinkedge/light/test_light/custom_availability",
                    data: "online"
                }
            ];

            let index = 0;
            const testTopic = () => {
                if (index < topics.length) {
                    const test = topics[index];
                    
                    if (typeof test.data === 'string') {
                        mqttClient.publish(test.topic, test.data, { qos: 1, retain: false });
                        addLog('å‘é€', test.topic, test.data);
                    } else {
                        mqttClient.publish(test.topic, JSON.stringify(test.data), { qos: 1, retain: false });
                        addLog('å‘é€', test.topic, JSON.stringify(test.data));
                    }
                    
                    index++;
                    setTimeout(testTopic, 2000);
                } else {
                    showMessage('åŠ¨æ€ä¸»é¢˜æµ‹è¯•å®Œæˆï¼', 'success');
                }
            };
            
            testTopic();
        }

        // è®¾å¤‡ä¸Šçº¿æµ‹è¯•
        function testDeviceOnline() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            showMessage('å¼€å§‹è®¾å¤‡ä¸Šçº¿æµ‹è¯•...', 'info');

            const devices = [
                { name: 'ç¯å…‰', topic: 'linknlinkedge/light/test_light/online', entity: 'light.test_light' },
                { name: 'å¼€å…³', topic: 'linknlinkedge/switch/test_switch/online', entity: 'switch.test_switch' },
                { name: 'ç©ºè°ƒ', topic: 'linknlinkedge/climate/test_climate/online', entity: 'climate.test_climate' },
                { name: 'äººæ„Ÿ', topic: 'linknlinkedge/binary_sensor/motion_sensor/online', entity: 'binary_sensor.motion_sensor' },
                { name: 'æ¹¿åº¦', topic: 'linknlinkedge/sensor/test_humidity/online', entity: 'sensor.test_humidity' },
                { name: 'åŠŸç‡', topic: 'linknlinkedge/sensor/power_monitor/online', entity: 'sensor.power_monitor' }
            ];

            let index = 0;
            const sendOnline = () => {
                if (index < devices.length) {
                    const device = devices[index];
                    mqttClient.publish(device.topic, 'online', { qos: 1, retain: false });
                    addLog('å‘é€', device.topic, 'online');
                    showMessage(`${device.name}è®¾å¤‡ä¸Šçº¿`, 'success');
                    index++;
                    setTimeout(sendOnline, 1000);
                } else {
                    showMessage('æ‰€æœ‰è®¾å¤‡ä¸Šçº¿æµ‹è¯•å®Œæˆï¼', 'success');
                }
            };

            sendOnline();
        }

        // è®¾å¤‡ç¦»çº¿æµ‹è¯•
        function testDeviceOffline() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            showMessage('å¼€å§‹è®¾å¤‡ç¦»çº¿æµ‹è¯•...', 'info');

            const devices = [
                { name: 'ç¯å…‰', topic: 'linknlinkedge/light/test_light/online', entity: 'light.test_light' },
                { name: 'å¼€å…³', topic: 'linknlinkedge/switch/test_switch/online', entity: 'switch.test_switch' },
                { name: 'ç©ºè°ƒ', topic: 'linknlinkedge/climate/test_climate/online', entity: 'climate.test_climate' },
                { name: 'äººæ„Ÿ', topic: 'linknlinkedge/binary_sensor/motion_sensor/online', entity: 'binary_sensor.motion_sensor' },
                { name: 'æ¹¿åº¦', topic: 'linknlinkedge/sensor/test_humidity/online', entity: 'sensor.test_humidity' },
                { name: 'åŠŸç‡', topic: 'linknlinkedge/sensor/power_monitor/online', entity: 'sensor.power_monitor' }
            ];

            let index = 0;
            const sendOffline = () => {
                if (index < devices.length) {
                    const device = devices[index];
                    mqttClient.publish(device.topic, 'offline', { qos: 1, retain: false });
                    addLog('å‘é€', device.topic, 'offline');
                    showMessage(`${device.name}è®¾å¤‡ç¦»çº¿`, 'info');
                    index++;
                    setTimeout(sendOffline, 1000);
                } else {
                    showMessage('æ‰€æœ‰è®¾å¤‡ç¦»çº¿æµ‹è¯•å®Œæˆï¼', 'success');
                }
            };

            sendOffline();
        }

        // å…¨è®¾å¤‡æµ‹è¯•
        function testAllDevices() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            showMessage('å¼€å§‹å…¨è®¾å¤‡æµ‹è¯•...', 'info');

            // 1. å‘é€æ‰€æœ‰è®¾å¤‡å‘ç°æ¶ˆæ¯
            const discoveryFunctions = [
                testLightDiscovery,
                testSwitchDiscovery,
                testClimateDiscovery,
                testMotionDiscovery,
                testHumidityDiscovery,
                testPowerDiscovery
            ];

            let index = 0;
            const sendDiscovery = () => {
                if (index < discoveryFunctions.length) {
                    discoveryFunctions[index]();
                    index++;
                    setTimeout(sendDiscovery, 2000);
                } else {
                    // 2. ç­‰å¾…2ç§’åå‘é€ä¸Šçº¿æ¶ˆæ¯
                    setTimeout(() => {
                        testDeviceOnline();
                    }, 2000);
                }
            };

            sendDiscovery();
        }
        // å‘é€äººæ„Ÿæµ‹è¯•
        function sendMotionSensor() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            // äººæ„Ÿä¼ æ„Ÿå™¨åº”è¯¥å‘é€çŠ¶æ€æ¶ˆæ¯ï¼Œä¸æ˜¯æ§åˆ¶æ¶ˆæ¯
            const state = {
                motion_detected: Math.random() > 0.5, // éšæœºç”Ÿæˆæ£€æµ‹çŠ¶æ€
                timestamp: new Date().toISOString(),
                confidence: Math.floor(Math.random() * 100)
            };

            const topic = "linknlinkedge/binary_sensor/motion_sensor/status";
            mqttClient.publish(topic, JSON.stringify(state), { qos: 1 });
            showMessage(`äººæ„Ÿä¼ æ„Ÿå™¨çŠ¶æ€å·²å‘é€: ${state.motion_detected ? 'æ£€æµ‹åˆ°äºº' : 'æ— äººæ£€æµ‹'}`, 'success');
        }

        // æµ‹è¯•äººæ„Ÿä¼ æ„Ÿå™¨å‘ç°
        function testMotionDiscovery() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "äººæ„Ÿä¼ æ„Ÿå™¨",
                unique_id: "motion_sensor_001",
                device_class: "motion",
                state_topic: "linknlinkedge/binary_sensor/motion_sensor/status",
                availability_topic: "linknlinkedge/binary_sensor/motion_sensor/availability",
                json_attributes_topic: "linknlinkedge/binary_sensor/motion_sensor/attributes",
                value_template: "{{ value_json.motion_detected if value_json.motion_detected is defined else false }}",
                payload_available: "online",
                payload_not_available: "offline",
                device: {
                    identifiers: ["motion_sensor_001"],
                    name: "äººæ„Ÿä¼ æ„Ÿå™¨è®¾å¤‡",
                    model: "Motion Sensor Pro",
                    manufacturer: "LinkNLink",
                    sw_version: "1.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/binary_sensor/motion_sensor/config";
            mqttClient.publish(topic, JSON.stringify(config), { qos: 1, retain: false });
            showMessage('äººæ„Ÿä¼ æ„Ÿå™¨å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // å‘é€æ£€æµ‹åˆ°äººçŠ¶æ€
        function sendMotionDetected() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const state = {
                motion_detected: true,
                timestamp: new Date().toISOString(),
                confidence: Math.floor(Math.random() * 30) + 70 // 70-100% ç½®ä¿¡åº¦
            };

            const topic = "linknlinkedge/binary_sensor/motion_sensor/status";
            mqttClient.publish(topic, JSON.stringify(state), { qos: 1 });
            showMessage('äººæ„Ÿä¼ æ„Ÿå™¨çŠ¶æ€å·²å‘é€: æ£€æµ‹åˆ°äºº', 'success');
        }

        // å‘é€æ— äººæ£€æµ‹çŠ¶æ€
        function sendMotionNotDetected() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const state = {
                motion_detected: false,
                timestamp: new Date().toISOString(),
                confidence: Math.floor(Math.random() * 30) + 70 // 70-100% ç½®ä¿¡åº¦
            };

            const topic = "linknlinkedge/binary_sensor/motion_sensor/status";
            mqttClient.publish(topic, JSON.stringify(state), { qos: 1 });
            showMessage('äººæ„Ÿä¼ æ„Ÿå™¨çŠ¶æ€å·²å‘é€: æ— äººæ£€æµ‹', 'success');
        }

        // ä¸ŠæŠ¥äººæ„Ÿä¼ æ„Ÿå™¨çŠ¶æ€
        function reportMotionState() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const state = {
                motion_detected: Math.random() > 0.5, // éšæœºç”Ÿæˆæ£€æµ‹çŠ¶æ€
                timestamp: new Date().toISOString(),
                confidence: Math.floor(Math.random() * 100)
            };

            const topic = "linknlinkedge/binary_sensor/motion_sensor/status";
            mqttClient.publish(topic, JSON.stringify(state), { qos: 1 });
            showMessage(`äººæ„Ÿä¼ æ„Ÿå™¨çŠ¶æ€å·²ä¸ŠæŠ¥: ${state.motion_detected ? 'æ£€æµ‹åˆ°äºº' : 'æ— äººæ£€æµ‹'}`, 'success');
        }

        // æµ‹è¯•æ¹¿åº¦ä¼ æ„Ÿå™¨å‘ç°
        function testHumidityDiscovery() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "æ¹¿åº¦ä¼ æ„Ÿå™¨",
                unique_id: "humidity_sensor_001",
                device_class: "humidity",
                state_topic: "linknlinkedge/sensor/test_humidity/status",
                command_topic: "linknlinkedge/sensor/test_humidity/set",
                availability_topic: "linknlinkedge/sensor/test_humidity/availability",
                json_attributes_topic: "linknlinkedge/sensor/test_humidity/attributes",
                value_template: "{{ value_json.humidity if value_json.humidity is defined else 0 }}",
                unit_of_measurement: "%",
                payload_available: "online",
                payload_not_available: "offline",
                device: {
                    identifiers: ["humidity_sensor_001"],
                    name: "æ¹¿åº¦ä¼ æ„Ÿå™¨è®¾å¤‡",
                    model: "Humidity Sensor Pro",
                    manufacturer: "LinkNLink",
                    sw_version: "1.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/sensor/test_humidity/config";
            mqttClient.publish(topic, JSON.stringify(config), { qos: 1, retain: false });
            showMessage('æ¹¿åº¦ä¼ æ„Ÿå™¨å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // ä¸ŠæŠ¥æ¹¿åº¦ä¼ æ„Ÿå™¨çŠ¶æ€
        function reportHumidityState() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const humidity = Math.floor(Math.random() * 40) + 30; // 30-70% æ¹¿åº¦
            const topic = "linknlinkedge/sensor/test_humidity/status";
            mqttClient.publish(topic, humidity.toString(), { qos: 1 });
            showMessage(`æ¹¿åº¦ä¼ æ„Ÿå™¨çŠ¶æ€å·²ä¸ŠæŠ¥: ${humidity}%`, 'success');
        }

        // æµ‹è¯•åŠŸç‡ç›‘æ§å‘ç°
        function testPowerDiscovery() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = {
                name: "åŠŸç‡ç›‘æ§",
                unique_id: "power_monitor_001",
                device_class: "power",
                state_topic: "linknlinkedge/sensor/power_monitor/status",
                command_topic: "linknlinkedge/sensor/power_monitor/set",
                availability_topic: "linknlinkedge/sensor/power_monitor/availability",
                json_attributes_topic: "linknlinkedge/sensor/power_monitor/attributes",
                value_template: "{{ value_json.power if value_json.power is defined else 0 }}",
                unit_of_measurement: "W",
                payload_available: "online",
                payload_not_available: "offline",
                device: {
                    identifiers: ["power_monitor_001"],
                    name: "åŠŸç‡ç›‘æ§è®¾å¤‡",
                    model: "Power Monitor Pro",
                    manufacturer: "LinkNLink",
                    sw_version: "1.0.0"
                },
                qos: 1,
                retain: false
            };

            const topic = "linknlinkedge/sensor/power_monitor/config";
            mqttClient.publish(topic, JSON.stringify(config), { qos: 1, retain: false });
            showMessage('åŠŸç‡ç›‘æ§å‘ç°æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // ä¸ŠæŠ¥åŠŸç‡ç›‘æ§çŠ¶æ€
        function reportPowerState() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const power = Math.floor(Math.random() * 1000) + 100; // 100-1100W åŠŸç‡
            const topic = "linknlinkedge/sensor/power_monitor/status";
            mqttClient.publish(topic, power.toString(), { qos: 1 });
            showMessage(`åŠŸç‡ç›‘æ§çŠ¶æ€å·²ä¸ŠæŠ¥: ${power}W`, 'success');
        }

        // è°ƒç”¨åŒ—å‘RESTfulæœåŠ¡ï¼ˆç”¨äºè®¾å¤‡æµ‹è¯•ï¼‰
        async function callRestfulService(domain, service, entityId, serviceData = {}) {
            // æ„å»ºåŒ—å‘APIè¯·æ±‚æ•°æ®ï¼Œæ ¼å¼ç±»ä¼¼Home Assistant
            const data = {
                entity_id: entityId,
                ...serviceData
            };

            try {
                // è°ƒç”¨åŒ—å‘HTTPæ¥å£ï¼Œæ ¼å¼: /linknlinkedge/api/services/<domain>/<service>
                const response = await fetch(`/linknlinkedge/api/services/${domain}/${service}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer TOKEN', // åŒ—å‘æ¥å£éœ€è¦è®¤è¯
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(`æ§åˆ¶æˆåŠŸ: ${domain}.${service}`, 'success');
                    console.log('åŒ—å‘APIæ§åˆ¶ç»“æœ:', result);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'æ§åˆ¶å¤±è´¥');
                }
            } catch (err) {
                showMessage(`æ§åˆ¶å¤±è´¥: ${err.message}`, 'error');
                console.error('åŒ—å‘APIæ§åˆ¶é”™è¯¯:', err);
            }
        }

        // å‘é€è‡ªå®šä¹‰çŠ¶æ€ä¸ŠæŠ¥
        function sendCustomStateReport() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const entityId = document.getElementById('stateEntityId').value;
            const stateValue = document.getElementById('stateValue').value;
            const attributesText = document.getElementById('stateAttributes').value;

            if (!entityId || !stateValue) {
                showMessage('è¯·å¡«å†™å®ä½“IDå’ŒçŠ¶æ€å€¼', 'error');
                return;
            }

            // è§£æå®ä½“IDè·å–ä¸»é¢˜
            const parts = entityId.split('.');
            if (parts.length !== 2) {
                showMessage('å®ä½“IDæ ¼å¼é”™è¯¯ï¼Œåº”ä¸º: domain.object_id', 'error');
                return;
            }

            const domain = parts[0];
            const objectId = parts[1];
            const topic = `linknlinkedge/${domain}/${objectId}/state`;

            // æ„å»ºpayload
            let payload;
            try {
                if (attributesText.trim()) {
                    const attributes = JSON.parse(attributesText);
                    payload = JSON.stringify(attributes);
                } else {
                    payload = stateValue;
                }
            } catch (e) {
                showMessage('å±æ€§JSONæ ¼å¼é”™è¯¯', 'error');
                return;
            }

            // å‘é€MQTTæ¶ˆæ¯
            mqttClient.publish(topic, payload, { qos: 1, retain: false });
            addLog('çŠ¶æ€ä¸ŠæŠ¥', topic, payload);
            showMessage(`çŠ¶æ€ä¸ŠæŠ¥å·²å‘é€: ${entityId} -> ${stateValue}`, 'success');
        }

        // åŠ è½½é¢„è®¾çŠ¶æ€
        function loadPresetStates() {
            const presets = [
                {
                    name: "æ¸©åº¦ä¼ æ„Ÿå™¨",
                    entityId: "sensor.test_temperature",
                    stateValue: "24.8",
                    attributes: '{"temperature": "24.8", "unit": "Â°C", "quality": "excellent", "status": "active", "timestamp": "' + new Date().toISOString() + '"}'
                },
                {
                    name: "æ™ºèƒ½ç¯å…‰",
                    entityId: "light.test_light",
                    stateValue: "on",
                    attributes: '{"brightness": 128, "color_mode": "brightness", "friendly_name": "Test Light", "supported_color_modes": ["brightness"], "supported_features": 40}'
                },
                {
                    name: "æ™ºèƒ½å¼€å…³",
                    entityId: "switch.test_switch",
                    stateValue: "on",
                    attributes: '{"friendly_name": "Test Switch"}'
                },
                {
                    name: "ç©ºè°ƒæ§åˆ¶å™¨",
                    entityId: "climate.test_climate",
                    stateValue: "cool",
                    attributes: '{"temperature": 22, "current_temperature": 24, "hvac_modes": ["off", "cool", "heat"], "friendly_name": "Test AC"}'
                }
            ];

            const presetHtml = presets.map((preset, index) => 
                `<button class="btn btn-sm" onclick="loadPreset(${index})">${preset.name}</button>`
            ).join(' ');

            showMessage(`é¢„è®¾çŠ¶æ€: ${presetHtml}`, 'info');
        }

        // åŠ è½½é¢„è®¾
        function loadPreset(index) {
            const presets = [
                {
                    entityId: "sensor.test_temperature",
                    stateValue: "24.8",
                    attributes: '{"temperature": "24.8", "unit": "Â°C", "quality": "excellent", "status": "active", "timestamp": "' + new Date().toISOString() + '"}'
                },
                {
                    entityId: "light.test_light",
                    stateValue: "on",
                    attributes: '{"brightness": 128, "color_mode": "brightness", "friendly_name": "Test Light", "supported_color_modes": ["brightness"], "supported_features": 40}'
                },
                {
                    entityId: "switch.test_switch",
                    stateValue: "on",
                    attributes: '{"friendly_name": "Test Switch"}'
                },
                {
                    entityId: "climate.test_climate",
                    stateValue: "cool",
                    attributes: '{"temperature": 22, "current_temperature": 24, "hvac_modes": ["off", "cool", "heat"], "friendly_name": "Test AC"}'
                }
            ];

            const preset = presets[index];
            document.getElementById('stateEntityId').value = preset.entityId;
            document.getElementById('stateValue').value = preset.stateValue;
            document.getElementById('stateAttributes').value = preset.attributes;
        }

        // æ§åˆ¶ç±»è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥å‡½æ•°
        function reportLightState() {
            document.getElementById('stateEntityId').value = 'light.test_light';
            document.getElementById('stateValue').value = 'on';
            document.getElementById('stateAttributes').value = '{"brightness": 128, "color_mode": "brightness", "friendly_name": "Test Light", "supported_color_modes": ["brightness"], "supported_features": 40}';
            showMessage('å·²åŠ è½½ç¯å…‰çŠ¶æ€æ¨¡æ¿ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»"å‘é€çŠ¶æ€ä¸ŠæŠ¥"', 'info');
        }

        function reportSwitchState() {
            document.getElementById('stateEntityId').value = 'switch.test_switch';
            document.getElementById('stateValue').value = 'on';
            document.getElementById('stateAttributes').value = '{"friendly_name": "Test Switch"}';
            showMessage('å·²åŠ è½½å¼€å…³çŠ¶æ€æ¨¡æ¿ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»"å‘é€çŠ¶æ€ä¸ŠæŠ¥"', 'info');
        }

        function reportClimateState() {
            document.getElementById('stateEntityId').value = 'climate.test_climate';
            document.getElementById('stateValue').value = 'cool';
            document.getElementById('stateAttributes').value = '{"temperature": 22, "current_temperature": 24, "hvac_modes": ["off", "cool", "heat"], "friendly_name": "Test AC"}';
            showMessage('å·²åŠ è½½ç©ºè°ƒçŠ¶æ€æ¨¡æ¿ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»"å‘é€çŠ¶æ€ä¸ŠæŠ¥"', 'info');
        }

        // è®¾å¤‡ä¸Šçº¿/ä¸‹çº¿æ§åˆ¶
        function setDeviceOnline(deviceType) {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const deviceTopics = {
                'temperature': "linknlinkedge/sensor/test_temperature/online",
                'light': "linknlinkedge/light/test_light/online",
                'switch': "linknlinkedge/switch/test_switch/online",
                'climate': "linknlinkedge/climate/test_climate/online",
                'humidity': "linknlinkedge/sensor/test_humidity/online",
                'power': "linknlinkedge/sensor/power_monitor/online",
                'illuminance': "linknlinkedge/sensor/light_sensor/online",
                'button': "linknlinkedge/button/test_button/online"
            };

            const topic = deviceTopics[deviceType];
            if (topic) {
                mqttClient.publish(topic, "online", { qos: 1, retain: false });
                addLog('è®¾å¤‡ä¸Šçº¿', topic, "online");
                showMessage(`${deviceType}è®¾å¤‡å·²ä¸Šçº¿`, 'success');
            } else {
                showMessage('æœªçŸ¥è®¾å¤‡ç±»å‹', 'error');
            }
        }

        function setDeviceOffline(deviceType) {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const deviceTopics = {
                'temperature': "linknlinkedge/sensor/test_temperature/online",
                'light': "linknlinkedge/light/test_light/online",
                'switch': "linknlinkedge/switch/test_switch/online",
                'climate': "linknlinkedge/climate/test_climate/online",
                'humidity': "linknlinkedge/sensor/test_humidity/online",
                'power': "linknlinkedge/sensor/power_monitor/online",
                'illuminance': "linknlinkedge/sensor/light_sensor/online",
                'button': "linknlinkedge/button/test_button/online"
            };

            const topic = deviceTopics[deviceType];
            if (topic) {
                mqttClient.publish(topic, "offline", { qos: 1, retain: false });
                addLog('è®¾å¤‡ä¸‹çº¿', topic, "offline");
                showMessage(`${deviceType}è®¾å¤‡å·²ä¸‹çº¿`, 'warning');
            } else {
                showMessage('æœªçŸ¥è®¾å¤‡ç±»å‹', 'error');
            }
        }

        function testAllDevices() {
            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            // ä¾æ¬¡æµ‹è¯•æ‰€æœ‰è®¾å¤‡
            setTimeout(() => testTemperatureSensor(), 100);
            setTimeout(() => testLightDiscovery(), 200);
            setTimeout(() => testSwitchDiscovery(), 300);
            setTimeout(() => testClimateDiscovery(), 400);
            
            showMessage('å¼€å§‹æµ‹è¯•æ‰€æœ‰è®¾å¤‡...', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šWebSocketæŒ‰é’®äº‹ä»¶
            document.getElementById('wsConnectBtn').addEventListener('click', connectWebSocket);
            document.getElementById('wsDisconnectBtn').addEventListener('click', disconnectWebSocket);
            
            // ä¸è‡ªåŠ¨è¿æ¥WebSocketï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨è¿æ¥
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // è®¾å¤‡ç±»å‹é…ç½®
        const deviceConfigs = {
            temperature: {
                title: 'ğŸŒ¡ï¸ æ¸©åº¦ä¼ æ„Ÿå™¨',
                description: 'æµ‹è¯•æ¸©åº¦ä¼ æ„Ÿå™¨çš„è®¾å¤‡å‘ç°å’ŒçŠ¶æ€ä¸ŠæŠ¥',
                entityId: 'sensor.test_temperature',
                hasControl: false,
                controls: []
            },
            light: {
                title: 'ğŸ’¡ æ™ºèƒ½ç¯å…‰',
                description: 'æµ‹è¯•æ™ºèƒ½ç¯å…‰çš„è®¾å¤‡å‘ç°å’Œæ§åˆ¶',
                entityId: 'light.test_light',
                hasControl: true,
                controls: [
                    { label: 'å¼€å¯', action: 'turn_on', service: 'turn_on' },
                    { label: 'å…³é—­', action: 'turn_off', service: 'turn_off' },
                    { label: 'åˆ‡æ¢', action: 'toggle', service: 'toggle' },
                    { label: 'äº®åº¦50%', action: 'brightness_50', service: 'turn_on', data: { brightness: 128 } },
                    { label: 'äº®åº¦100%', action: 'brightness_100', service: 'turn_on', data: { brightness: 255 } },
                    { label: 'çº¢è‰²', action: 'color_red', service: 'turn_on', data: { rgb_color: [255, 0, 0] } },
                    { label: 'ç»¿è‰²', action: 'color_green', service: 'turn_on', data: { rgb_color: [0, 255, 0] } },
                    { label: 'è“è‰²', action: 'color_blue', service: 'turn_on', data: { rgb_color: [0, 0, 255] } },
                    { label: 'æš–ç™½', action: 'color_warm', service: 'turn_on', data: { color_temp: 3000 } },
                    { label: 'å†·ç™½', action: 'color_cool', service: 'turn_on', data: { color_temp: 6500 } }
                ]
            },
            switch: {
                title: 'ğŸ”Œ æ™ºèƒ½å¼€å…³',
                description: 'æµ‹è¯•æ™ºèƒ½å¼€å…³çš„è®¾å¤‡å‘ç°å’Œæ§åˆ¶',
                entityId: 'switch.test_switch',
                hasControl: true,
                controls: [
                    { label: 'å¼€å¯', action: 'turn_on', service: 'turn_on' },
                    { label: 'å…³é—­', action: 'turn_off', service: 'turn_off' },
                    { label: 'åˆ‡æ¢', action: 'toggle', service: 'toggle' }
                ]
            },
            climate: {
                title: 'â„ï¸ ç©ºè°ƒæ§åˆ¶å™¨',
                description: 'æµ‹è¯•ç©ºè°ƒæ§åˆ¶å™¨çš„è®¾å¤‡å‘ç°å’Œæ§åˆ¶',
                entityId: 'climate.test_climate',
                hasControl: true,
                controls: [
                    { label: 'åˆ¶å†·æ¨¡å¼', action: 'mode_cool', service: 'set_hvac_mode', data: { hvac_mode: 'cool' } },
                    { label: 'åˆ¶çƒ­æ¨¡å¼', action: 'mode_heat', service: 'set_hvac_mode', data: { hvac_mode: 'heat' } },
                    { label: 'è‡ªåŠ¨æ¨¡å¼', action: 'mode_auto', service: 'set_hvac_mode', data: { hvac_mode: 'auto' } },
                    { label: 'å…³é—­', action: 'mode_off', service: 'set_hvac_mode', data: { hvac_mode: 'off' } },
                    { label: '22Â°C', action: 'temp_22', service: 'set_temperature', data: { temperature: 22 } },
                    { label: '24Â°C', action: 'temp_24', service: 'set_temperature', data: { temperature: 24 } },
                    { label: '26Â°C', action: 'temp_26', service: 'set_temperature', data: { temperature: 26 } },
                    { label: 'ä½é£é€Ÿ', action: 'fan_low', service: 'set_fan_mode', data: { fan_mode: 'low' } },
                    { label: 'ä¸­é£é€Ÿ', action: 'fan_medium', service: 'set_fan_mode', data: { fan_mode: 'medium' } },
                    { label: 'é«˜é£é€Ÿ', action: 'fan_high', service: 'set_fan_mode', data: { fan_mode: 'high' } },
                    { label: 'è‡ªåŠ¨é£é€Ÿ', action: 'fan_auto', service: 'set_fan_mode', data: { fan_mode: 'auto' } }
                ]
            },
            motion: {
                title: 'ğŸ‘¤ äººæ„Ÿä¼ æ„Ÿå™¨',
                description: 'æµ‹è¯•äººæ„Ÿä¼ æ„Ÿå™¨çš„è®¾å¤‡å‘ç°å’ŒçŠ¶æ€ä¸ŠæŠ¥',
                entityId: 'binary_sensor.motion_sensor',
                hasControl: false,
                controls: [
                    { label: 'æ£€æµ‹åˆ°äºº', action: 'motion_detected', service: 'custom', data: { motion_detected: true } },
                    { label: 'æ— äººæ£€æµ‹', action: 'motion_not_detected', service: 'custom', data: { motion_detected: false } }
                ]
            },
            humidity: {
                title: 'ğŸ’§ æ¹¿åº¦ä¼ æ„Ÿå™¨',
                description: 'æµ‹è¯•æ¹¿åº¦ä¼ æ„Ÿå™¨çš„è®¾å¤‡å‘ç°å’ŒçŠ¶æ€ä¸ŠæŠ¥',
                entityId: 'sensor.test_humidity',
                hasControl: false,
                controls: []
            },
            power: {
                title: 'âš¡ åŠŸç‡ç›‘æ§',
                description: 'æµ‹è¯•åŠŸç‡ç›‘æ§è®¾å¤‡çš„è®¾å¤‡å‘ç°å’ŒçŠ¶æ€ä¸ŠæŠ¥',
                entityId: 'sensor.power_monitor',
                hasControl: false,
                controls: []
            },
            illuminance: {
                title: 'â˜€ï¸ å…‰ç…§ä¼ æ„Ÿå™¨',
                description: 'æµ‹è¯•å…‰ç…§ä¼ æ„Ÿå™¨çš„è®¾å¤‡å‘ç°å’ŒçŠ¶æ€ä¸ŠæŠ¥',
                entityId: 'sensor.light_sensor',
                hasControl: false,
                controls: []
            },
            button: {
                title: 'ğŸ”˜ æŒ‰é’®ä¼ æ„Ÿå™¨',
                description: 'æµ‹è¯•æŒ‰é’®ä¼ æ„Ÿå™¨çš„è®¾å¤‡å‘ç°å’ŒçŠ¶æ€ä¸ŠæŠ¥',
                entityId: 'button.test_button',
                hasControl: true,
                controls: [
                    { label: 'æŒ‰ä¸‹', action: 'press', service: 'press' },
                    { label: 'é•¿æŒ‰', action: 'long_press', service: 'press', data: { duration: 3 } },
                    { label: 'åŒå‡»', action: 'double_press', service: 'press', data: { count: 2 } }
                ]
            }
        };

        // åŠ è½½è®¾å¤‡æµ‹è¯•ç•Œé¢
        function loadDeviceTestInterface() {
            const deviceType = document.getElementById('deviceTypeSelect').value;
            const testInterface = document.getElementById('deviceTestInterface');
            const controlSection = document.getElementById('deviceControlSection');
            const controlButtons = document.getElementById('controlButtons');
            const entityIdInput = document.getElementById('entityIdInput');

            if (!deviceType) {
                testInterface.style.display = 'none';
                return;
            }

            const config = deviceConfigs[deviceType];
            if (!config) return;

            // æ˜¾ç¤ºæµ‹è¯•ç•Œé¢
            testInterface.style.display = 'block';

            // æ›´æ–°æ ‡é¢˜å’Œæè¿°
            document.getElementById('selectedDeviceTitle').textContent = config.title;
            document.getElementById('selectedDeviceDescription').textContent = config.description;

            // è®¾ç½®é»˜è®¤å®ä½“ID
            entityIdInput.value = config.entityId;

            // æ˜¾ç¤ºæˆ–éšè—æ§åˆ¶åŒºåŸŸ
            if (config.hasControl && config.controls.length > 0) {
                controlSection.style.display = 'block';
                
                // ç”Ÿæˆæ§åˆ¶æŒ‰é’®
                controlButtons.innerHTML = '';
                config.controls.forEach(control => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.textContent = control.label;
                    button.onclick = () => executeDeviceControl(control);
                    controlButtons.appendChild(button);
                });
            } else {
                controlSection.style.display = 'none';
            }
        }

        // æ‰§è¡Œè®¾å¤‡æ§åˆ¶
        function executeDeviceControl(control) {
            const entityId = document.getElementById('entityIdInput').value;
            if (!entityId) {
                showMessage('è¯·è¾“å…¥å®ä½“ID', 'error');
                return;
            }

            if (control.service === 'custom') {
                // è‡ªå®šä¹‰æœåŠ¡ï¼ˆå¦‚äººæ„Ÿä¼ æ„Ÿå™¨çŠ¶æ€ï¼‰
                if (control.action === 'motion_detected') {
                    sendMotionDetected();
                } else if (control.action === 'motion_not_detected') {
                    sendMotionNotDetected();
                }
            } else {
                // æ ‡å‡†RESTfulæœåŠ¡
                callRestfulService(control.service.split('_')[0], control.service, entityId, control.data || {});
            }
        }

        // å‘é€è®¾å¤‡å‘ç°
        function sendDeviceDiscovery() {
            const deviceType = document.getElementById('deviceTypeSelect').value;
            const entityId = document.getElementById('entityIdInput').value;
            
            if (!deviceType || !entityId) {
                showMessage('è¯·é€‰æ‹©è®¾å¤‡ç±»å‹å¹¶è¾“å…¥å®ä½“ID', 'error');
                return;
            }

            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            const config = deviceConfigs[deviceType];
            if (!config) return;

            // æ ¹æ®è®¾å¤‡ç±»å‹å‘é€ç›¸åº”çš„å‘ç°æ¶ˆæ¯
            switch (deviceType) {
                case 'temperature':
                    testTemperatureSensor();
                    break;
                case 'light':
                    testLightDiscovery();
                    break;
                case 'switch':
                    testSwitchDiscovery();
                    break;
                case 'climate':
                    testClimateDiscovery();
                    break;
                case 'motion':
                    testMotionDiscovery();
                    break;
                case 'humidity':
                    testHumidityDiscovery();
                    break;
                case 'power':
                    testPowerDiscovery();
                    break;
            }
        }

        // å‘é€çŠ¶æ€ä¸ŠæŠ¥
        function sendStatusReport() {
            const deviceType = document.getElementById('deviceTypeSelect').value;
            const entityId = document.getElementById('entityIdInput').value;
            
            if (!deviceType || !entityId) {
                showMessage('è¯·é€‰æ‹©è®¾å¤‡ç±»å‹å¹¶è¾“å…¥å®ä½“ID', 'error');
                return;
            }

            if (!isConnected) {
                showMessage('è¯·å…ˆè¿æ¥MQTT', 'error');
                return;
            }

            // æ ¹æ®è®¾å¤‡ç±»å‹å‘é€ç›¸åº”çš„çŠ¶æ€ä¸ŠæŠ¥
            switch (deviceType) {
                case 'temperature':
                    testTemperatureState();
                    break;
                case 'light':
                    reportLightState();
                    break;
                case 'switch':
                    reportSwitchState();
                    break;
                case 'climate':
                    reportClimateState();
                    break;
                case 'motion':
                    reportMotionState();
                    break;
                case 'humidity':
                    reportHumidityState();
                    break;
                case 'power':
                    reportPowerState();
                    break;
            }
        }

        // è®¾ç½®è®¾å¤‡ä¸Šçº¿ï¼ˆä»ä¸‹æ‹‰èœå•ï¼‰
        function setDeviceOnlineFromSelect() {
            const deviceType = document.getElementById('deviceTypeSelect').value;
            if (deviceType) {
                setDeviceOnline(deviceType);
            } else {
                showMessage('è¯·å…ˆé€‰æ‹©è®¾å¤‡ç±»å‹', 'error');
            }
        }

        // è®¾ç½®è®¾å¤‡ä¸‹çº¿ï¼ˆä»ä¸‹æ‹‰èœå•ï¼‰
        function setDeviceOfflineFromSelect() {
            const deviceType = document.getElementById('deviceTypeSelect').value;
            if (deviceType) {
                setDeviceOffline(deviceType);
            } else {
                showMessage('è¯·å…ˆé€‰æ‹©è®¾å¤‡ç±»å‹', 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ç³»ç»Ÿ', 'MQTTæµ‹è¯•å·¥å…·å·²å°±ç»ªï¼Œè¯·é…ç½®è¿æ¥å‚æ•°');
        });
    </script>
</body>
</html>
